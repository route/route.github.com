<!DOCTYPE html>
<html>
  <head>
    <title>Ruby loading and requiring modules</title>
    <meta charset='utf-8' />
    <link href="/stylesheets/application.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/application.js" type="text/javascript"></script>
  </head>
  <body>
    <div class='content'>
      <header>
        <a href="/">Blog</a>
      </header>
      <article>
  <h3>Ruby loading and requiring modules</h3>
  <time>November  5, 2013</time>
  <p>This article has started as my own research on a slightly different theme -
<a href="http://route.github.io/2013/11/06/rails-autoloading.html">Rails autoloading</a>
but I couldn&#39;t describe it without saying a single word about Ruby
itself. If this topic is clear for you, start right off the next part.</p>

<p>I won&#39;t describe everything in this post just a couple of important moments.
When we separate the code by files we start using three different methods in
order to &#39;concatenate&#39; it. Here they are: <code>require</code>, <code>load</code>, <code>autoload</code>. You can
find a lot info about them in ruby-doc, so I&#39;ll just sum it up. <code>Kernel#require</code>
will load file only once making any constants or globals within the loaded
source file available in the calling program&#39;s global namespace. If it succeded
then file&#39;s absolute path would be added to <code>$LOADED_FEATURES</code> preventing us
from loading it twice. <code>Kernel#load</code> won&#39;t add path of loaded file to
<code>$LOADED_FEATURES</code>. All the rest differences about them is on your own please :)</p>

<p>Example with <code>require</code>:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre>  <span class="c1"># In ./first/a.rb</span>
  <span class="c1"># module A</span>
  <span class="c1">#   C = &#39;constant&#39;</span>
  <span class="c1"># end</span>

  <span class="n">before</span> <span class="o">=</span> <span class="vg">$LOADED_FEATURES</span><span class="o">.</span><span class="n">dup</span>
  <span class="nb">require</span> <span class="s1">&#39;./first/a&#39;</span>
  <span class="vg">$LOADED_FEATURES</span> <span class="o">-</span> <span class="n">before</span> <span class="c1"># =&gt; [&#39;/Users/route/Projects/dependencies/first/a.rb&#39;]</span>

  <span class="n">A</span><span class="o">::</span><span class="n">C</span> <span class="c1"># =&gt; &#39;constant&#39;</span>
  <span class="nb">sleep</span> <span class="mi">5</span>
  <span class="c1"># Meanwhile changing constant value to &#39;changed&#39;</span>

  <span class="nb">require</span> <span class="s1">&#39;./first/a&#39;</span>

  <span class="n">A</span><span class="o">::</span><span class="n">C</span> <span class="c1"># =&gt; &#39;constant&#39;</span>
</pre></div>
</td></tr></table></div>
<p>Example with <code>load</code>:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre>  <span class="c1"># In ./first/a.rb</span>
  <span class="c1"># module A</span>
  <span class="c1">#   C = &#39;constant&#39;</span>
  <span class="c1"># end</span>

  <span class="n">before</span> <span class="o">=</span> <span class="vg">$LOADED_FEATURES</span><span class="o">.</span><span class="n">dup</span>
  <span class="nb">load</span> <span class="s1">&#39;./first/a.rb&#39;</span>
  <span class="vg">$LOADED_FEATURES</span> <span class="o">-</span> <span class="n">before</span> <span class="c1"># =&gt; []</span>

  <span class="n">A</span><span class="o">::</span><span class="n">C</span> <span class="c1"># =&gt; &#39;constant&#39;</span>
  <span class="nb">sleep</span> <span class="mi">5</span>
  <span class="c1"># Meanwhile changing constant value to &#39;changed&#39;</span>

  <span class="nb">load</span> <span class="s1">&#39;./first/a.rb&#39;</span>

  <span class="c1"># ./first/a.rb:2: warning: already initialized constant A::C</span>
  <span class="c1"># ./first/a.rb:2: warning: previous definition of C was here</span>
  <span class="n">A</span><span class="o">::</span><span class="n">C</span> <span class="c1"># =&gt; &#39;changed&#39;</span>
</pre></div>
</td></tr></table></div>
<p>With warnings but the code was reloaded. Moving forward to <code>Kernel#autoload</code>.</p>

<p>Example 1 with <code>autoload</code>:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre>  <span class="c1"># In ./first/a.rb</span>
  <span class="c1"># module A</span>
  <span class="c1">#   p &#39;loading&#39;</span>
  <span class="c1"># end</span>

  <span class="nb">autoload</span> <span class="ss">:A</span><span class="p">,</span> <span class="s1">&#39;./first/a&#39;</span>
</pre></div>
</td></tr></table></div>
<p>Running this won&#39;t produce anything useful, because we&#39;ve just declared that
constant <code>A</code> could be found in a file but we&#39;ve never used it.</p>

<p>Example 2 with <code>autoload</code>:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre>  <span class="c1"># In ./first/a.rb</span>
  <span class="c1"># module A</span>
  <span class="c1">#   p &#39;loading&#39;</span>
  <span class="c1"># end</span>

  <span class="nb">autoload</span> <span class="ss">:A</span><span class="p">,</span> <span class="s1">&#39;./first/a&#39;</span>
  <span class="n">A</span> <span class="c1"># =&gt; Gives output &#39;loading&#39;</span>
</pre></div>
</td></tr></table></div>
<p>In other words <code>autoload</code> makes us to load code lazily on demand decreasing time
of loading on the beginning. There were some problems with thread safety and
<code>autoload</code>, also there was a rumor that it would be deprecated, but I hadn&#39;t
found anything what ruby core team came up with. I just can say it works
properly even with threads for now.</p>

<p>Next topic is constant name resolution, and I&#39;ll give just a few words(see my
colleague&#39;s <a href="http://valve.github.io/blog/2013/10/26/constant-resolution-in-ruby/">post</a>).
As for me, I find this example comprehensive:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre>  <span class="k">module</span> <span class="nn">Kernel</span>
    <span class="c1"># Constants defined in Kernel</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">B</span> <span class="o">=</span> <span class="n">C</span> <span class="o">=</span> <span class="n">D</span> <span class="o">=</span> <span class="n">E</span> <span class="o">=</span> <span class="n">F</span> <span class="o">=</span> <span class="s2">&quot;defined in kernel&quot;</span>
  <span class="k">end</span>

  <span class="c1"># Top-level or &quot;global&quot; constants defined in Object</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">B</span> <span class="o">=</span> <span class="n">C</span> <span class="o">=</span> <span class="n">D</span> <span class="o">=</span> <span class="n">E</span> <span class="o">=</span> <span class="s2">&quot;defined at toplevel&quot;</span>

  <span class="k">class</span> <span class="nc">Super</span>
    <span class="c1"># Constants defined in a superclass</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">B</span> <span class="o">=</span> <span class="n">C</span> <span class="o">=</span> <span class="n">D</span> <span class="o">=</span> <span class="s2">&quot;defined in superclass&quot;</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Included</span>
    <span class="c1"># Constants defined in an included module</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">B</span> <span class="o">=</span> <span class="n">C</span> <span class="o">=</span> <span class="s2">&quot;defined in included module&quot;</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Enclosing</span>
    <span class="c1"># Constants defined in an enclosing module</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">B</span> <span class="o">=</span> <span class="s2">&quot;defined in enclosing module&quot;</span>

    <span class="k">class</span> <span class="nc">Local</span> <span class="o">&lt;</span> <span class="no">Super</span>
      <span class="kp">include</span> <span class="no">Included</span>

      <span class="c1"># Locally defined constant</span>
      <span class="n">A</span> <span class="o">=</span> <span class="s2">&quot;defined locally&quot;</span>

      <span class="c1"># The list of modules searched, in the order searched</span>
      <span class="c1"># [Enclosing::Local, Enclosing, Included, Super, Object, Kernel, BasicObject]</span>
      <span class="c1"># (Module.nesting + self.ancestors + Object.ancestors).uniq</span>
      <span class="nb">puts</span> <span class="n">A</span>  <span class="c1"># Prints &quot;defined locally&quot;</span>
      <span class="nb">puts</span> <span class="n">B</span>  <span class="c1"># Prints &quot;defined in enclosing module&quot;</span>
      <span class="nb">puts</span> <span class="n">C</span>  <span class="c1"># Prints &quot;defined in included module&quot;</span>
      <span class="nb">puts</span> <span class="n">D</span>  <span class="c1"># Prints &quot;defined in superclass&quot;</span>
      <span class="nb">puts</span> <span class="n">E</span>  <span class="c1"># Prints &quot;defined at toplevel&quot;</span>
      <span class="nb">puts</span> <span class="n">F</span>  <span class="c1"># Prints &quot;defined in kernel&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</td></tr></table></div>
<p>A few cases should also be mentioned here:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre>  <span class="k">module</span> <span class="nn">A</span>
    <span class="n">C</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">A</span>
    <span class="k">module</span> <span class="nn">B</span>
      <span class="n">C</span> <span class="c1"># =&gt; &#39;c&#39;</span>
      <span class="no">Module</span><span class="o">.</span><span class="n">nesting</span> <span class="c1"># =&gt; [A::B, A]</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">A::B</span>
    <span class="n">C</span> <span class="c1"># =&gt; NameError: uninitialized constant A::B::C</span>
    <span class="no">Module</span><span class="o">.</span><span class="n">nesting</span> <span class="c1"># =&gt; [A::B]</span>
  <span class="k">end</span>
</pre></div>
</td></tr></table></div>
<p>As you can see the nesting for these two forms is different and enclosing module
<code>A</code> doesn&#39;t exist and won&#39;t be used in constant name resolution for the last
example.</p>

<p>Another case:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre>  <span class="k">class</span> <span class="nc">Parent</span>
    <span class="no">CONST</span> <span class="o">=</span> <span class="s1">&#39;parent&#39;</span>

    <span class="k">def</span> <span class="nf">get</span>
      <span class="no">CONST</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Child</span> <span class="o">&lt;</span> <span class="no">Parent</span>
    <span class="no">CONST</span> <span class="o">=</span> <span class="s1">&#39;child&#39;</span>
  <span class="k">end</span>

  <span class="no">Child</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">get</span> <span class="c1"># =&gt; parent</span>
</pre></div>
</td></tr></table></div>
<p>Remember that constants use the same lexical scope. In this example method is
invoked on parent class so it&#39;s scope is used. To change things you could use
<code>self.class::CONST</code> this way you expicitly saying find my constant in my own
class.</p>

<p>Lastly, imagine we access a constant that isn&#39;t defined in all places listed
above then <code>self.const_missing</code> is invoked on the class that needs constant or
if it wasn&#39;t defined on that class it&#39;s invoked on <code>Module</code>. It accepts just one
single argument <code>const_name</code> which is the constant we&#39;re looking for. By default
this method simply throws an error <code>NameError: uninitialized constant #{const_name}</code>.</p>

<p>That&#39;s all for ruby, moving to
<a href="http://route.github.io/2013/11/05/rails-autoloading.html">Rails autoloading</a></p>
  <div class='share'>
    <a class="twitter-share-button" data-via="rO_Oute" href="https://twitter.com/share">Tweet</a>
    <script type='text/javascript'>
      //<![CDATA[
        !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
      //]]>
    </script>
  </div>
</article>
      <footer>
        Copyright Â© 2012-2013
        <a target="_blank" href="https://github.com/route">Dmitry Vorotilin</a>
        |
        <a target="_blank" href="http://route.github.io/cv.html">CV</a>
        |
        <a target="_blank" href="http://evrone.com">Evrone.com</a>
      </footer>
    </div>
  </body>
</html>

