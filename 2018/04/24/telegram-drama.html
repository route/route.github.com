<!DOCTYPE html>
<html>
  <head>
    <title>Telegram drama</title>
    <meta charset='utf-8' />
    <link href="/stylesheets/application.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/application.js" type="text/javascript"></script>
  </head>
  <body>
    <div class='content'>
      <header>
        <a href="/">Blog</a>
      </header>
      <article>
  <h1>Telegram drama</h1>
  <time>April 24, 2018</time>
  <p>I didn&#39;t write a word in the blog for almost 4 years because I didn&#39;t have time
or most likely motivation to do it. But current circumstances forced me.</p>

<p>In my childhood internet and network looked like a magick. In movies they showed
something like ping output and I definitely thought that someone hacked someone
else.</p>

<p><img alt="hacking" src="https://www.techworm.net/wp-content/uploads/2016/03/Movies-Based-On-Hacking-e1457858868314.png" /></p>

<p>I&#39;m located in Russia and I work for Chicago based startup thanks 21st century
for remote. We have our servers on AWS and DigitalOcean. Thereon this long
summer story ends as bloody winter is coming.</p>

<p>Recently media regulator Roskomnadzor started to block Telegram IP addresses
because the latter denied giving goverment keys to decipher messages. It goes
without saying that it&#39;s creepy but among other things Roskomnadzor blocked like
roughly 18kk of IP addresses. It happened because Telegram uses services
publicly provided by AWS and other big companies. Here I should say that&#39;s
exactly the reason these companies exist lol they provide services. Roskomnadzor
started to block these IPs and Telegram as it&#39;s an application using push
notifications (correct me if I&#39;m wrong) started to use other IPs and so on and
so on. The post is not about how secure Telegram is or why it doesn&#39;t provide
secure E2E channels by default. It&#39;s about not giving up freedom to talk to each
other privately.</p>

<p>As usually this morning I tried to connect to one of our web services and
surprise what? It timed out. ICMP traffic wasn&#39;t blocked though. Let&#39;s say a
domain for this server for simplification is <code>a.com</code>.</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$ </span>ping a.com
PING 159.89.184.10: 64 data bytes
72 bytes from 159.89.184.10: <span class="nv">seq</span><span class="o">=</span>0 <span class="nv">ttl</span><span class="o">=</span>52 <span class="nb">time</span><span class="o">=</span>141.242 ms
72 bytes from 159.89.184.10: <span class="nv">seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>52 <span class="nb">time</span><span class="o">=</span>140.809 ms
72 bytes from 159.89.184.10: <span class="nv">seq</span><span class="o">=</span>2 <span class="nv">ttl</span><span class="o">=</span>52 <span class="nb">time</span><span class="o">=</span>141.031 ms
72 bytes from 159.89.184.10: <span class="nv">seq</span><span class="o">=</span>3 <span class="nv">ttl</span><span class="o">=</span>52 <span class="nb">time</span><span class="o">=</span>140.702 ms
72 bytes from 159.89.184.10: <span class="nv">seq</span><span class="o">=</span>4 <span class="nv">ttl</span><span class="o">=</span>52 <span class="nb">time</span><span class="o">=</span>140.808 ms

5 packets transmitted, 5 packets received, 0% packet loss
round-trip min/avg/max <span class="o">=</span> 140.702/140.918/141.242 ms
</pre></div>
</td></tr></table></div>
<p>You would say so what? I&#39;ll tell you that for example if I want to open torrent
tracker <a href="http://rutracker.org">rutracker.org</a> (which has been blocked for years
in Russia) ISP redirects me to its <a href="http://warning.rt.ru/?id=9&st=0&dt=195.82.146.214&rs=http%3A%2F%2Frutracker.org%2Fforum%2Findex.php">own page</a>
showing that this address was in fact blocked by goverment. Surprisingly it&#39;s
not the case for <code>159.89.184.10</code>. HTTP traffic disappears silently. So first
thing we go to <a href="https://eais.rkn.gov.ru/">eais.rkn.gov.ru</a> to check if the
address is really blocked. It says it&#39;s all clear no blocks, nothing. Ok we go
to ISP (hello <a href="http://rt.ru">Rostelekom</a>) then.</p>

<p>Below in this post I provide full conversations with ISP and DigitalOcean but
long story short after ISP checked everything on their end they called me
saying that they don&#39;t block it as well as Roskomnadzor. So most likely it&#39;s
DigitalOcean who blocks it. As you wish guys&hellip; I go to DigitalOcean and
together we investigate it. Opening <code>chrome://net-internals</code> is very intersting
sometimes and confirms time out:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span class="mi">14057</span><span class="o">:</span> <span class="n">URL_REQUEST</span>
<span class="n">https</span><span class="o">://</span><span class="n">a</span><span class="o">.</span><span class="na">com</span><span class="o">/</span>
<span class="n">Start</span> <span class="n">Time</span><span class="o">:</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">04</span><span class="o">-</span><span class="mi">24</span> <span class="mi">08</span><span class="o">:</span><span class="mi">07</span><span class="o">:</span><span class="mf">06.009</span>

<span class="n">t</span><span class="o">=</span><span class="mi">144674</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span>    <span class="mi">0</span><span class="o">]</span> <span class="o">+</span><span class="n">REQUEST_ALIVE</span>  <span class="o">[</span><span class="n">dt</span><span class="o">=</span><span class="mi">24521</span><span class="o">]</span>
                     <span class="o">--&gt;</span> <span class="n">priority</span> <span class="o">=</span> <span class="s2">&quot;HIGHEST&quot;</span>
                     <span class="o">--&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://a.com/&quot;</span>
<span class="n">t</span><span class="o">=</span><span class="mi">144674</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span>    <span class="mi">0</span><span class="o">]</span>    <span class="n">URL_REQUEST_DELEGATE</span>  <span class="o">[</span><span class="n">dt</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
<span class="n">t</span><span class="o">=</span><span class="mi">144674</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span>    <span class="mi">0</span><span class="o">]</span>   <span class="o">+</span><span class="n">URL_REQUEST_START_JOB</span>  <span class="o">[</span><span class="n">dt</span><span class="o">=</span><span class="mi">24521</span><span class="o">]</span>
                       <span class="o">--&gt;</span> <span class="n">load_flags</span> <span class="o">=</span> <span class="mi">4353</span> <span class="o">(</span><span class="n">MAIN_FRAME_DEPRECATED</span> <span class="o">|</span> <span class="n">VALIDATE_CACHE</span> <span class="o">|</span> <span class="n">VERIFY_EV_CERT</span><span class="o">)</span>
                       <span class="o">--&gt;</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span>
                       <span class="o">--&gt;</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://a.com/&quot;</span>
<span class="n">t</span><span class="o">=</span><span class="mi">144674</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span>    <span class="mi">0</span><span class="o">]</span>      <span class="n">URL_REQUEST_DELEGATE</span>  <span class="o">[</span><span class="n">dt</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
<span class="n">t</span><span class="o">=</span><span class="mi">144674</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span>    <span class="mi">0</span><span class="o">]</span>      <span class="n">HTTP_CACHE_GET_BACKEND</span>  <span class="o">[</span><span class="n">dt</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
<span class="n">t</span><span class="o">=</span><span class="mi">144674</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span>    <span class="mi">0</span><span class="o">]</span>      <span class="n">HTTP_CACHE_OPEN_ENTRY</span>  <span class="o">[</span><span class="n">dt</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
                         <span class="o">--&gt;</span> <span class="n">net_error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">(</span><span class="n">ERR_FAILED</span><span class="o">)</span>
<span class="n">t</span><span class="o">=</span><span class="mi">144674</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span>    <span class="mi">0</span><span class="o">]</span>      <span class="n">HTTP_CACHE_CREATE_ENTRY</span>  <span class="o">[</span><span class="n">dt</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
<span class="n">t</span><span class="o">=</span><span class="mi">144674</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span>    <span class="mi">0</span><span class="o">]</span>      <span class="n">HTTP_CACHE_ADD_TO_ENTRY</span>  <span class="o">[</span><span class="n">dt</span><span class="o">=</span><span class="mi">1</span><span class="o">]</span>
<span class="n">t</span><span class="o">=</span><span class="mi">144675</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span>    <span class="mi">1</span><span class="o">]</span>     <span class="o">+</span><span class="n">HTTP_STREAM_REQUEST</span>  <span class="o">[</span><span class="n">dt</span><span class="o">=</span><span class="mi">24520</span><span class="o">]</span>
<span class="n">t</span><span class="o">=</span><span class="mi">144675</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span>    <span class="mi">1</span><span class="o">]</span>        <span class="n">HTTP_STREAM_JOB_CONTROLLER_BOUND</span>
                           <span class="o">--&gt;</span> <span class="n">source_dependency</span> <span class="o">=</span> <span class="mi">14060</span> <span class="o">(</span><span class="n">HTTP_STREAM_JOB_CONTROLLER</span><span class="o">)</span>
<span class="n">t</span><span class="o">=</span><span class="mi">169195</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span><span class="mi">24521</span><span class="o">]</span>        <span class="n">HTTP_STREAM_REQUEST_BOUND_TO_JOB</span>
                           <span class="o">--&gt;</span> <span class="n">source_dependency</span> <span class="o">=</span> <span class="mi">14061</span> <span class="o">(</span><span class="n">HTTP_STREAM_JOB</span><span class="o">)</span>
<span class="n">t</span><span class="o">=</span><span class="mi">169195</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span><span class="mi">24521</span><span class="o">]</span>     <span class="o">-</span><span class="n">HTTP_STREAM_REQUEST</span>
<span class="n">t</span><span class="o">=</span><span class="mi">169195</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span><span class="mi">24521</span><span class="o">]</span>   <span class="o">-</span><span class="n">URL_REQUEST_START_JOB</span>
                       <span class="o">--&gt;</span> <span class="n">net_error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">118</span> <span class="o">(</span><span class="n">ERR_CONNECTION_TIMED_OUT</span><span class="o">)</span>
<span class="n">t</span><span class="o">=</span><span class="mi">169195</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span><span class="mi">24521</span><span class="o">]</span>    <span class="n">URL_REQUEST_DELEGATE</span>  <span class="o">[</span><span class="n">dt</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
<span class="n">t</span><span class="o">=</span><span class="mi">169195</span> <span class="o">[</span><span class="n">st</span><span class="o">=</span><span class="mi">24521</span><span class="o">]</span> <span class="o">-</span><span class="n">REQUEST_ALIVE</span>
                     <span class="o">--&gt;</span> <span class="n">net_error</span> <span class="o">=</span> <span class="o">-</span><span class="mi">118</span> <span class="o">(</span><span class="n">ERR_CONNECTION_TIMED_OUT</span><span class="o">)</span>
</pre></div>
</td></tr></table></div>
<p>Traceroute from my machine to this IP shows a few intermidiate backbone providers:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre>traceroute to a.com <span class="o">(</span>159.89.184.10<span class="o">)</span>, 30 hops max, 60 byte packets
 1  gateway <span class="o">(</span>192.168.0.1<span class="o">)</span>  0.417 ms  0.484 ms  0.568 ms
 2  100.103.0.1 <span class="o">(</span>100.103.0.1<span class="o">)</span>  4.935 ms  4.992 ms  5.020 ms
 3  213.59.232.208 <span class="o">(</span>213.59.232.208<span class="o">)</span>  38.910 ms 213.59.232.204 <span class="o">(</span>213.59.232.204<span class="o">)</span>  5.076 ms 213.59.232.208 <span class="o">(</span>213.59.232.208<span class="o">)</span>  5.339 ms
 4  87.226.146.65 <span class="o">(</span>87.226.146.65<span class="o">)</span>  6.112 ms 87.226.146.63 <span class="o">(</span>87.226.146.63<span class="o">)</span>  6.889 ms  6.970 ms
 5  87.226.146.58 <span class="o">(</span>87.226.146.58<span class="o">)</span>  20.707 ms  20.892 ms  20.702 ms
 6  213.59.212.235 <span class="o">(</span>213.59.212.235<span class="o">)</span>  20.632 ms  16.806 ms  17.437 ms
 7  rostelecom.demarc.cogentco.com <span class="o">(</span>149.11.20.138<span class="o">)</span>  63.077 ms  63.722 ms  64.571 ms
 8  hu0-1-0-4.rcr22.fra06.atlas.cogentco.com <span class="o">(</span>149.11.20.137<span class="o">)</span>  57.615 ms  58.457 ms  58.454 ms
 9  be2845.ccr41.fra03.atlas.cogentco.com <span class="o">(</span>154.54.56.189<span class="o">)</span>  58.463 ms be2846.ccr42.fra03.atlas.cogentco.com <span class="o">(</span>154.54.37.29<span class="o">)</span>  66.791 ms be2845.ccr41.fra03.atlas.cogentco.com <span class="o">(</span>154.54.56.189<span class="o">)</span>  59.662 ms
10  be3187.agr41.fra03.atlas.cogentco.com <span class="o">(</span>130.117.1.117<span class="o">)</span>  63.433 ms be3186.agr41.fra03.atlas.cogentco.com <span class="o">(</span>130.117.0.2<span class="o">)</span>  64.132 ms be3187.agr41.fra03.atlas.cogentco.com <span class="o">(</span>130.117.1.117<span class="o">)</span>  63.998 ms
11  telia.fra03.atlas.cogentco.com <span class="o">(</span>130.117.14.198<span class="o">)</span>  70.302 ms  70.477 ms  70.480 ms
12  ffm-bb3-link.telia.net <span class="o">(</span>62.115.133.34<span class="o">)</span>  168.162 ms ffm-bb4-link.telia.net <span class="o">(</span>62.115.125.218<span class="o">)</span>  140.360 ms ffm-bb3-link.telia.net <span class="o">(</span>62.115.120.3<span class="o">)</span>  165.617 ms
13  prs-bb3-link.telia.net <span class="o">(</span>62.115.123.13<span class="o">)</span>  171.186 ms  171.374 ms  169.994 ms
14  nyk-bb3-link.telia.net <span class="o">(</span>213.155.135.5<span class="o">)</span>  164.382 ms nyk-bb4-link.telia.net <span class="o">(</span>80.91.251.100<span class="o">)</span>  149.359 ms  150.275 ms
15  nyk-b3-link.telia.net <span class="o">(</span>62.115.140.223<span class="o">)</span>  163.973 ms hbg-bb1-link.telia.net <span class="o">(</span>80.91.249.11<span class="o">)</span>  177.416 ms  177.405 ms
16  digitalocean-ic-306498-nyk-b3.c.telia.net <span class="o">(</span>62.115.45.10<span class="o">)</span>  145.430 ms  145.572 ms  158.371 ms
17  * * *
18  159.89.184.10 <span class="o">(</span>159.89.184.10<span class="o">)</span>  154.054 ms  140.789 ms  141.688 ms
</pre></div>
</td></tr></table></div>
<p>While in reverse from the droplet there&#39;s only one of them:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre>traceroute to 95.32.215.86 <span class="o">(</span>95.32.215.86<span class="o">)</span>, 30 hops max, 60 byte packets
 1  159.89.176.253 <span class="o">(</span>159.89.176.253<span class="o">)</span>  0.290 ms  0.263 ms  0.231 ms
 2  138.197.248.28 <span class="o">(</span>138.197.248.28<span class="o">)</span>  0.478 ms  0.469 ms  0.456 ms
 3  nyk-b3-link.telia.net <span class="o">(</span>62.115.45.9<span class="o">)</span>  1.021 ms  1.058 ms  1.043 ms
 4  nyk-bb3-link.telia.net <span class="o">(</span>62.115.140.222<span class="o">)</span>  1.153 ms nyk-bb4-link.telia.net <span class="o">(</span>62.115.139.150<span class="o">)</span>  1.523 ms nyk-bb3-link.telia.net <span class="o">(</span>62.115.140.222<span class="o">)</span>  1.111 ms
 5  prs-bb4-link.telia.net <span class="o">(</span>80.91.251.101<span class="o">)</span>  71.869 ms prs-bb3-link.telia.net <span class="o">(</span>213.155.135.4<span class="o">)</span>  106.781 ms  107.322 ms
 6  prs-bb3-link.telia.net <span class="o">(</span>62.115.134.92<span class="o">)</span>  88.216 ms  88.162 ms ffm-bb4-link.telia.net <span class="o">(</span>62.115.122.139<span class="o">)</span>  81.890 ms
 7  ffm-b1-link.telia.net <span class="o">(</span>62.115.141.237<span class="o">)</span>  93.304 ms ffm-bb3-link.telia.net <span class="o">(</span>62.115.123.12<span class="o">)</span>  101.734 ms  102.168 ms
 8  rostelecom-ic-319651-ffm-b1.c.telia.net <span class="o">(</span>62.115.151.97<span class="o">)</span>  156.199 ms  156.187 ms  156.198 ms
 9  213.59.212.103 <span class="o">(</span>213.59.212.103<span class="o">)</span>  138.304 ms  149.985 ms rostelecom-ic-319651-ffm-b1.c.telia.net <span class="o">(</span>62.115.151.97<span class="o">)</span>  158.270 ms
10  86.215.32.95.dsl-dynamic.vsi.ru <span class="o">(</span>95.32.215.86<span class="o">)</span>  139.571 ms  139.690 ms  139.701 ms
</pre></div>
</td></tr></table></div>
<p>BGP might have an answer why the route changes. I found pretty interesting site
BTW <a href="https://bgpstream.com/">bgpstream.com</a></p>

<p>Let&#39;s monitor outgoing and incoming traffic:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre>$ <span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">a</span><span class="p">.</span><span class="n">com</span>
<span class="n">curl</span><span class="p">:</span> <span class="p">(</span>7<span class="p">)</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">a</span><span class="p">.</span><span class="n">com</span> <span class="n">port</span> 80<span class="p">:</span> <span class="n">Connection</span> <span class="n">timed</span> <span class="n">out</span>

$ <span class="n">sudo</span> <span class="n">tcpdump</span> <span class="o">-</span><span class="n">nn</span> <span class="o">-</span><span class="n">vvv</span> <span class="o">-</span><span class="nb">i</span> <span class="n">enp4s0</span> <span class="n">dst</span> 159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10 <span class="n">or</span> <span class="n">src</span> 159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10
<span class="n">tcpdump</span><span class="p">:</span> <span class="n">listening</span> <span class="n">on</span> <span class="n">enp4s0</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="n">type</span> <span class="n">EN10MB</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">),</span> <span class="n">capture</span> <span class="nb">size</span> 262144 <span class="n">bytes</span>
23<span class="p">:</span>38<span class="p">:</span>18<span class="p">.</span>908971 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 64<span class="p">,</span> <span class="n">id</span> 59563<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">DF</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 60<span class="p">)</span>
    192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722 <span class="o">&gt;</span> 159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">S</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">xd52f</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 1092877667<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="n">options</span> <span class="p">[</span><span class="n">mss</span> 1460<span class="p">,</span><span class="n">sackOK</span><span class="p">,</span><span class="n">TS</span> <span class="n">val</span> 3908771289 <span class="n">ecr</span> 0<span class="p">,</span><span class="n">nop</span><span class="p">,</span><span class="n">wscale</span> 7<span class="p">],</span> <span class="nb">length</span> 0
23<span class="p">:</span>38<span class="p">:</span>18<span class="p">.</span>925014 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 58<span class="p">,</span> <span class="n">id</span> 1<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">none</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 40<span class="p">)</span>
    159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80 <span class="o">&gt;</span> 192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">R</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">x43e5</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 0<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="nb">length</span> 0
23<span class="p">:</span>38<span class="p">:</span>19<span class="p">.</span>932815 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 64<span class="p">,</span> <span class="n">id</span> 59564<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">DF</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 60<span class="p">)</span>
    192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722 <span class="o">&gt;</span> 159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">S</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">xd12f</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 1092877667<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="n">options</span> <span class="p">[</span><span class="n">mss</span> 1460<span class="p">,</span><span class="n">sackOK</span><span class="p">,</span><span class="n">TS</span> <span class="n">val</span> 3908772313 <span class="n">ecr</span> 0<span class="p">,</span><span class="n">nop</span><span class="p">,</span><span class="n">wscale</span> 7<span class="p">],</span> <span class="nb">length</span> 0
23<span class="p">:</span>38<span class="p">:</span>19<span class="p">.</span>948956 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 58<span class="p">,</span> <span class="n">id</span> 1<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">none</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 40<span class="p">)</span>
    159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80 <span class="o">&gt;</span> 192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">R</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">x43e5</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 0<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="nb">length</span> 0
23<span class="p">:</span>38<span class="p">:</span>21<span class="p">.</span>948826 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 64<span class="p">,</span> <span class="n">id</span> 59565<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">DF</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 60<span class="p">)</span>
    192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722 <span class="o">&gt;</span> 159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">S</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">xc94f</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 1092877667<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="n">options</span> <span class="p">[</span><span class="n">mss</span> 1460<span class="p">,</span><span class="n">sackOK</span><span class="p">,</span><span class="n">TS</span> <span class="n">val</span> 3908774329 <span class="n">ecr</span> 0<span class="p">,</span><span class="n">nop</span><span class="p">,</span><span class="n">wscale</span> 7<span class="p">],</span> <span class="nb">length</span> 0
23<span class="p">:</span>38<span class="p">:</span>21<span class="p">.</span>965036 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 58<span class="p">,</span> <span class="n">id</span> 1<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">none</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 40<span class="p">)</span>
    159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80 <span class="o">&gt;</span> 192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">R</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">x43e5</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 0<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="nb">length</span> 0
23<span class="p">:</span>38<span class="p">:</span>26<span class="p">.</span>044817 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 64<span class="p">,</span> <span class="n">id</span> 59566<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">DF</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 60<span class="p">)</span>
    192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722 <span class="o">&gt;</span> 159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">S</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">xb94f</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 1092877667<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="n">options</span> <span class="p">[</span><span class="n">mss</span> 1460<span class="p">,</span><span class="n">sackOK</span><span class="p">,</span><span class="n">TS</span> <span class="n">val</span> 3908778425 <span class="n">ecr</span> 0<span class="p">,</span><span class="n">nop</span><span class="p">,</span><span class="n">wscale</span> 7<span class="p">],</span> <span class="nb">length</span> 0
23<span class="p">:</span>38<span class="p">:</span>26<span class="p">.</span>061047 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 58<span class="p">,</span> <span class="n">id</span> 1<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">none</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 40<span class="p">)</span>
    159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80 <span class="o">&gt;</span> 192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">R</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">x43e5</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 0<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="nb">length</span> 0
23<span class="p">:</span>38<span class="p">:</span>34<span class="p">.</span>236838 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 64<span class="p">,</span> <span class="n">id</span> 59567<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">DF</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 60<span class="p">)</span>
    192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722 <span class="o">&gt;</span> 159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">S</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">x994f</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 1092877667<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="n">options</span> <span class="p">[</span><span class="n">mss</span> 1460<span class="p">,</span><span class="n">sackOK</span><span class="p">,</span><span class="n">TS</span> <span class="n">val</span> 3908786617 <span class="n">ecr</span> 0<span class="p">,</span><span class="n">nop</span><span class="p">,</span><span class="n">wscale</span> 7<span class="p">],</span> <span class="nb">length</span> 0
23<span class="p">:</span>38<span class="p">:</span>34<span class="p">.</span>252685 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 58<span class="p">,</span> <span class="n">id</span> 1<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">none</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 40<span class="p">)</span>
    159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80 <span class="o">&gt;</span> 192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">R</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">x43e5</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 0<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="nb">length</span> 0
23<span class="p">:</span>38<span class="p">:</span>50<span class="p">.</span>364856 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 64<span class="p">,</span> <span class="n">id</span> 59568<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">DF</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 60<span class="p">)</span>
    192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722 <span class="o">&gt;</span> 159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">S</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">x5a4e</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 1092877667<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="n">options</span> <span class="p">[</span><span class="n">mss</span> 1460<span class="p">,</span><span class="n">sackOK</span><span class="p">,</span><span class="n">TS</span> <span class="n">val</span> 3908802746 <span class="n">ecr</span> 0<span class="p">,</span><span class="n">nop</span><span class="p">,</span><span class="n">wscale</span> 7<span class="p">],</span> <span class="nb">length</span> 0
23<span class="p">:</span>38<span class="p">:</span>50<span class="p">.</span>381002 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 58<span class="p">,</span> <span class="n">id</span> 1<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">none</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 40<span class="p">)</span>
    159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80 <span class="o">&gt;</span> 192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">R</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">x43e5</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 0<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="nb">length</span> 0
23<span class="p">:</span>39<span class="p">:</span>22<span class="p">.</span>620807 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 64<span class="p">,</span> <span class="n">id</span> 59569<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">DF</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 60<span class="p">)</span>
    192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722 <span class="o">&gt;</span> 159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">S</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">xdc4d</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 1092877667<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="n">options</span> <span class="p">[</span><span class="n">mss</span> 1460<span class="p">,</span><span class="n">sackOK</span><span class="p">,</span><span class="n">TS</span> <span class="n">val</span> 3908835002 <span class="n">ecr</span> 0<span class="p">,</span><span class="n">nop</span><span class="p">,</span><span class="n">wscale</span> 7<span class="p">],</span> <span class="nb">length</span> 0
23<span class="p">:</span>39<span class="p">:</span>22<span class="p">.</span>637077 <span class="n">IP</span> <span class="p">(</span><span class="n">tos</span> 0<span class="n">x0</span><span class="p">,</span> <span class="n">ttl</span> 58<span class="p">,</span> <span class="n">id</span> 1<span class="p">,</span> <span class="n">offset</span> 0<span class="p">,</span> <span class="n">flags</span> <span class="p">[</span><span class="n">none</span><span class="p">],</span> <span class="n">proto</span> <span class="n">TCP</span> <span class="p">(</span>6<span class="p">),</span> <span class="nb">length</span> 40<span class="p">)</span>
    159<span class="p">.</span>89<span class="p">.</span>184<span class="p">.</span>10<span class="p">.</span>80 <span class="o">&gt;</span> 192<span class="p">.</span>168<span class="p">.</span>0<span class="p">.</span>13<span class="p">.</span>41722<span class="p">:</span> <span class="n">Flags</span> <span class="p">[</span><span class="n">R</span><span class="p">],</span> <span class="n">cksum</span> 0<span class="n">x43e5</span> <span class="p">(</span><span class="n">correct</span><span class="p">),</span> <span class="n">seq</span> 0<span class="p">,</span> <span class="n">win</span> 29200<span class="p">,</span> <span class="nb">length</span> 0
</pre></div>
</td></tr></table></div>
<p>Goodbye 3-Way TCP Handshake which should be (SYN, SYN-ACK, ACK) and hello RST
after SYN. You can see them as [S] and [R] flags. In other words all outgoing
http traffic dropped in the middle. Does it mean Roskomnadzor no longer needs
ISP to handle this crap or ISP is lying? If a girl says who blocks servers
a man will feed her.</p>

<p><img alt="The girl is no one" src="https://pbs.twimg.com/media/DbhrAF_WAAAE80q.jpg" /></p>

<p>Let&#39;s try it other way around. I set port mapping on my router to give an
ability for incoming http request go behind it and reach Ngnix on my PC.</p>

<p>We ssh into the droplet and try to connect with curl:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$ </span>curl http://95.32.183.155
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body <span class="o">{</span>
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    <span class="o">}</span>
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://nginx.org/&quot;</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;http://nginx.com/&quot;</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you <span class="k">for </span>using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;

<span class="nv">$ </span>sudo tcpdump -nn -vvv -i eth0 dst 95.32.183.155 and dst port 80 or src 95.32.183.155 and dst port 80
05:40:20.044097 IP <span class="o">(</span>tos 0x0, ttl 64, id 14142, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 60<span class="o">)</span>
    159.89.184.10.55928 &gt; 95.32.183.155.80: Flags <span class="o">[</span>S<span class="o">]</span>, cksum 0x6e4e <span class="o">(</span>incorrect -&gt; 0x2b0c<span class="o">)</span>, seq 1395059192, win 29200, options <span class="o">[</span>mss 1460,sackOK,TS val 1175838406 ecr 0,nop,wscale 7<span class="o">]</span>, length 0
05:40:20.196601 IP <span class="o">(</span>tos 0x0, ttl 64, id 14143, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 52<span class="o">)</span>
    159.89.184.10.55928 &gt; 95.32.183.155.80: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0x6e46 <span class="o">(</span>incorrect -&gt; 0xd836<span class="o">)</span>, seq 1395059193, ack 1061805333, win 229, options <span class="o">[</span>nop,nop,TS val 1175838444 ecr 3637509479<span class="o">]</span>, length 0
05:40:20.196784 IP <span class="o">(</span>tos 0x0, ttl 64, id 14144, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 129<span class="o">)</span>
    159.89.184.10.55928 &gt; 95.32.183.155.80: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0x6e93 <span class="o">(</span>incorrect -&gt; 0x40c3<span class="o">)</span>, seq 0:77, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val 1175838445 ecr 3637509479<span class="o">]</span>, length 77: HTTP, length: 77
    GET / HTTP/1.1
    Host: 95.32.183.155
    User-Agent: curl/7.47.0
    Accept: */*

05:40:20.350596 IP <span class="o">(</span>tos 0x0, ttl 64, id 14145, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 52<span class="o">)</span>
    159.89.184.10.55928 &gt; 95.32.183.155.80: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0x6e46 <span class="o">(</span>incorrect -&gt; 0xd3c1<span class="o">)</span>, seq 77, ack 860, win 242, options <span class="o">[</span>nop,nop,TS val 1175838483 ecr 3637509632<span class="o">]</span>, length 0
05:40:20.350809 IP <span class="o">(</span>tos 0x0, ttl 64, id 14146, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 52<span class="o">)</span>
    159.89.184.10.55928 &gt; 95.32.183.155.80: Flags <span class="o">[</span>F.<span class="o">]</span>, cksum 0x6e46 <span class="o">(</span>incorrect -&gt; 0xd3c0<span class="o">)</span>, seq 77, ack 860, win 242, options <span class="o">[</span>nop,nop,TS val 1175838483 ecr 3637509632<span class="o">]</span>, length 0
05:40:20.503792 IP <span class="o">(</span>tos 0x0, ttl 64, id 14147, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 52<span class="o">)</span>
    159.89.184.10.55928 &gt; 95.32.183.155.80: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0x6e46 <span class="o">(</span>incorrect -&gt; 0xd2ff<span class="o">)</span>, seq 78, ack 861, win 242, options <span class="o">[</span>nop,nop,TS val 1175838521 ecr 3637509786<span class="o">]</span>, length 0
</pre></div>
</td></tr></table></div>
<p>It works. Let&#39;s send an outdoing packet from the droplet with source port 80:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$ </span>yes | nc -p 80 -t 95.32.183.155 80

<span class="nv">$ </span>sudo tcpdump -nn -vvv -i eth0 dst 95.32.183.155 and dst port 80 or src 95.32.183.155 and dst port 80
tcpdump: listening on eth0, link-type EN10MB <span class="o">(</span>Ethernet<span class="o">)</span>, capture size 262144 bytes
05:39:49.968049 IP <span class="o">(</span>tos 0x0, ttl 64, id 18207, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 60<span class="o">)</span>
    159.89.184.10.80 &gt; 95.32.183.155.80: Flags <span class="o">[</span>S<span class="o">]</span>, cksum 0x6e4e <span class="o">(</span>incorrect -&gt; 0x16e9<span class="o">)</span>, seq 3260122744, win 29200, options <span class="o">[</span>mss 1460,sackOK,TS val 1175830887 ecr 0,nop,wscale 7<span class="o">]</span>, length 0
05:39:50.109076 IP <span class="o">(</span>tos 0x28, ttl 49, id 0, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 60<span class="o">)</span>
    95.32.183.155.80 &gt; 159.89.184.10.80: Flags <span class="o">[</span>S.<span class="o">]</span>, cksum 0x83e9 <span class="o">(</span>correct<span class="o">)</span>, seq 3723973951, ack 3260122745, win 28960, options <span class="o">[</span>mss 1440,sackOK,TS val 3637479403 ecr 1175830887,nop,wscale 7<span class="o">]</span>, length 0
05:39:50.109117 IP <span class="o">(</span>tos 0x0, ttl 64, id 18208, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 52<span class="o">)</span>
    159.89.184.10.80 &gt; 95.32.183.155.80: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0x6e46 <span class="o">(</span>incorrect -&gt; 0x22b9<span class="o">)</span>, seq 1, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val 1175830923 ecr 3637479403<span class="o">]</span>, length 0
05:39:50.109230 IP <span class="o">(</span>tos 0x0, ttl 64, id 18209, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 2100<span class="o">)</span>
    159.89.184.10.80 &gt; 95.32.183.155.80: Flags <span class="o">[</span>P.<span class="o">]</span>, cksum 0x7646 <span class="o">(</span>incorrect -&gt; 0xf0cc<span class="o">)</span>, seq 1:2049, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val 1175830923 ecr 3637479403<span class="o">]</span>, length 2048: HTTP
05:39:50.109280 IP <span class="o">(</span>tos 0x0, ttl 64, id 18211, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 1480<span class="o">)</span>
    159.89.184.10.80 &gt; 95.32.183.155.80: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0x73da <span class="o">(</span>incorrect -&gt; 0x7def<span class="o">)</span>, seq 2049:3477, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val 1175830923 ecr 3637479403<span class="o">]</span>, length 1428: HTTP
05:39:50.109299 IP <span class="o">(</span>tos 0x0, ttl 64, id 18212, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 1480<span class="o">)</span>
    159.89.184.10.80 &gt; 95.32.183.155.80: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0x73da <span class="o">(</span>incorrect -&gt; 0x785b<span class="o">)</span>, seq 3477:4905, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val 1175830923 ecr 3637479403<span class="o">]</span>, length 1428: HTTP
05:39:50.109331 IP <span class="o">(</span>tos 0x0, ttl 64, id 18213, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 2908<span class="o">)</span>
    159.89.184.10.80 &gt; 95.32.183.155.80: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0x796e <span class="o">(</span>incorrect -&gt; 0xd5fd<span class="o">)</span>, seq 4905:7761, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val 1175830923 ecr 3637479403<span class="o">]</span>, length 2856: HTTP
05:39:50.109349 IP <span class="o">(</span>tos 0x0, ttl 64, id 18215, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 1480<span class="o">)</span>
    159.89.184.10.80 &gt; 95.32.183.155.80: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0x73da <span class="o">(</span>incorrect -&gt; 0x679f<span class="o">)</span>, seq 7761:9189, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val 1175830923 ecr 3637479403<span class="o">]</span>, length 1428: HTTP
05:39:50.109371 IP <span class="o">(</span>tos 0x0, ttl 64, id 18216, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 2908<span class="o">)</span>
    159.89.184.10.80 &gt; 95.32.183.155.80: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0x796e <span class="o">(</span>incorrect -&gt; 0xc541<span class="o">)</span>, seq 9189:12045, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val 1175830923 ecr 3637479403<span class="o">]</span>, length 2856: HTTP
05:39:50.109390 IP <span class="o">(</span>tos 0x0, ttl 64, id 18218, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 1480<span class="o">)</span>
    159.89.184.10.80 &gt; 95.32.183.155.80: Flags <span class="o">[</span>.<span class="o">]</span>, cksum 0x73da <span class="o">(</span>incorrect -&gt; 0x56e3<span class="o">)</span>, seq 12045:13473, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val 1175830923 ecr 3637479403<span class="o">]</span>, length 1428: HTTP
05:39:50.251998 IP <span class="o">(</span>tos 0x28, ttl 49, id 34134, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 40<span class="o">)</span>
    95.32.183.155.80 &gt; 159.89.184.10.80: Flags <span class="o">[</span>R<span class="o">]</span>, cksum 0x0de9 <span class="o">(</span>correct<span class="o">)</span>, seq 3723973952, win 0, length 0
05:39:50.252020 IP <span class="o">(</span>tos 0x28, ttl 49, id 34135, offset 0, flags <span class="o">[</span>DF<span class="o">]</span>, proto TCP <span class="o">(</span>6<span class="o">)</span>, length 40<span class="o">)</span>
</pre></div>
</td></tr></table></div>
<p>TCP handshake and reset after all. Looks weird and empty on my side. Now I
wonder if we can catch where exactly http traffic drops. With traceroute we can
see where ICMP packets go but does that mean HTTP goes the same direction and
where it drops? I don&#39;t know the answer.</p>

<p>Overall I feel disappointed. I&#39;ve been googling about backbone providers and
found very interesting articles:</p>

<ul>
<li><a href="http://www.lookatme.ru/mag/magazine/russian-internet/207489-decentralization">about decentralization</a></li>
<li><a href="https://www.newyorker.com/tech/elements/the-mission-to-decentralize-the-internet">one more in english</a></li>
<li><a href="https://dyn.com/blog/could-it-happen-in-your-countr/">about Syria internet blackout</a></li>
</ul>

<p>It&#39;s like Telegram opened a curtain. Internet started like a small local network
with purpose of exchanging data for research, helping humankind to solve issues
or at least doing something meaningful and get better. Instead it&#39;s a place for
intertainment controlled by goverment.</p>

<p>If you read until this point there&#39;s a small bonus for you:
It&#39;s known fact that rutracker is blocked.</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="nv">$ </span>curl -vvv http://rutracker.org/forum/index.php
*   Trying 195.82.146.214...
* TCP_NODELAY <span class="nb">set</span>
* Connected to rutracker.org <span class="o">(</span>195.82.146.214<span class="o">)</span> port 80 <span class="o">(</span><span class="c">#0)</span>
&gt; GET /forum/index.php HTTP/1.1
&gt; Host: rutracker.org
&gt; User-Agent: curl/7.55.1
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 302 Found
&lt; Connection: close
&lt; Content-Length: 2
&lt; Location: http://warning.rt.ru/?id<span class="o">=</span>9&amp;st<span class="o">=</span>0&amp;dt<span class="o">=</span>195.82.146.214&amp;rs<span class="o">=</span>http%3A%2F%2Frutracker.org%2Fforum%2Findex.php
&lt;
* Closing connection 0
</pre></div>
</td></tr></table></div>
<p>Run this if you have Rostelekom <code>(printf &#39;GET /forum/index.php HTTP/1.1\r\nHost: rutracker.org\r\n\r\n&#39;; sleep 1) | nc rutracker.org 80</code></p>

<p>and you&#39;ll see:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre>HTTP/1.1 302 Found
Connection: close
Content-Length: 2
Location: http://warning.rt.ru/?id=9<span class="err">&amp;</span>st=0<span class="err">&amp;</span>dt=195.82.146.214<span class="err">&amp;</span>rs=http%3A%2F%2Frutracker.org%2Fforum%2Findex.php

OK Accept-Encoding
X-BB-ID: rto
X-Frame-Options: SAMEORIGIN

1f90
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;ru&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>

<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;Windows-1251&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;description&quot;</span> <span class="na">content=</span><span class="s">&quot;   .   , , , ..&quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;title&gt;</span>BitTorrent  RuTracker.org<span class="nt">&lt;/title&gt;</span>
...
</pre></div>
</td></tr></table></div>
<p>They intercept traffic and put 302 redirect and below goes original page.
Is that <a href="https://habr.com/post/335436/">passive DPI</a>? Remove carriage
return headers now and watch plain 200:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span class="o">(</span><span class="nb">printf</span> <span class="s1">&#39;GET /forum/index.php HTTP/1.1\nHost: rutracker.org\n\n&#39;</span>; sleep 1<span class="o">)</span> | nc rutracker.org 80

HTTP/1.1 200 OK
Server: nginx
Date: Wed, 25 Apr 2018 10:23:11 GMT
Content-Type: text/html; <span class="nv">charset</span><span class="o">=</span>Windows-1251
Transfer-Encoding: chunked
Connection: keep-alive
Vary: Accept-Encoding
X-BB-ID: rto
X-Frame-Options: SAMEORIGIN

1f90
&lt;!DOCTYPE html&gt;
&lt;html <span class="nv">lang</span><span class="o">=</span><span class="s2">&quot;ru&quot;</span>&gt;
&lt;head&gt;

&lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">&quot;Windows-1251&quot;</span>&gt;
&lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;description&quot;</span> <span class="nv">content</span><span class="o">=</span><span class="s2">&quot;   .   , , , ..&quot;</span>&gt;
</pre></div>
</td></tr></table></div>
<p>Unfortunately the story for DO is completely different because the traffic is
blocked somwhere in between.</p>

<p>Here I should say that the reason remains unknown and I&#39;ll keep you posted.</p>

<p>Rostelekom convo:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70</pre></div></td><td class="code"><div class="highlight"><pre>
 ,       http://a.com/


!
  ,       .
, .


     


    


         .
      .


    ,   
,   ,   
curl: (7) Failed to connect to a.com port 443: Connection timed out


      .     
  VPN,      .   
-        .
     .     ,
  -    
.


         ?


   -      
 .


?


    .


      
        
          . 


   -      
 .     . 
     .


   ?


      . , ,
  ,     .



...


       .
       132147087.   ,
   .  ,     
 . ,     .
</pre></div>
</td></tr></table></div>
<p>DigitalOcean convo:</p>
<div class='codeblock'><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120</pre></div></td><td class="code"><div class="highlight"><pre>*Me*
As you likely aware in Russia they try to block Telegram yet hopelessly. I tried
to connect to one of our servers today without luck. The url was
http://a.com/ (159.89.184.10) and it timed out.
I contacted my provider asking why is that and the answer was they didn&#39;t block
it as well as RKN (https://eais.rkn.gov.ru/). Yet this IP address is available
by ICMP and unavailable by http/https here&#39;s the log _link_
This IP is available using VPN.

The conclusion was that it is DO who blocks it. May I know if this is true and
you really block it for Russian IPs? My IP was 95.32.215.86

Thanks

*They*
Thank you for your email.
I really appreciate you taking the time to raise a case with us!

We&#39;re aware of a disruption in traffic from some areas in Russia to some of our
datacenters (AMS3, LON1, FRA1). It appears that traffic has been blocked at some
other point in the Internet, which is beyond our control. All circuits into
these datacenters are fully functional.

In case, your IP comes to any of those datacenters, we would recommend to
re-deploy. Again, I know this is not an ideal solution, we do apologize for the
inconvenience caused here.

*Me*
Surprisingly it&#39;s in NYC3... Do you have an information where at least it&#39;s
being blocked in Europe or in Russia?

*They*
Personally, we do not block any IPs and our circuits are fully working.

Would you be able to run an MTR to and fro from your location and vice-versa as
well as an MTR to the Droplet which is reachable from your end, so that we can
review both the MTRs this side.

Rest, if its blocked somewhere outside of our reach, due to the mass block of
IPs within Russia, getting a new IP would be helpful. Rest, we&#39;d be happy to
review the MTR and see if there&#39;s any specific hop where it is blocked.

*Me*
Yes I already added it to the log _link_

I&#39;ve added a traceroute from droplet to my IP as well.

Is that enough?

I&#39;m a bit confused I know that with traceroute we can see where all packets go
but how do we catch we http packets drop. I can connect to
a.com ssh easily. Only http doesn&#39;t work :( Someone&#39;s
dropping http packets and nobody tells it&#39;s him lol :)

*They*
Hey there,
Based on the information you provided, the issue does not appear to be a
network connectivity issue (ping works and the traceroute reaches the
destination) but an issue specifically with the HTTP request timing out,
which is likely something occurring either within the droplet itself or within
your local computer or network configuration.

Does your web server (Apache or Nginx in most cases) show these connections in
the access log, and if so, does the error log contain any information that might
explain why the connections are timing out?

*Me*
I don&#39;t see anything in logs on the machine when I try to connect with curl to it

*They*
Are you able to SSH into the droplet, or connect to it in any way other than HTTP?
This appears to be application or web server specific rather than a network
block but this would be a good way to confirm that.

*Me*
Yes exactly I have an access by ssh but http times out.

*They*

Very weird. Do you have any firewall running on this Droplet that may be
inadvertently blocking you via http and https? It looks like visiting your
IP prompts me to log in. Do you have something like fail2ban set up, where too
many failed login attempts would result in an IP block? Can you send me the
output of &quot;ufw status&quot; and &quot;iptables -L&quot;?

So far I&#39;m thinking this is either a firewall issue on the Droplet,
or some sort of weird ISP/Russian issue where they&#39;re solely blocking
HTTP/HTTPS for your IP, but I don&#39;t know why they&#39;d do that.

*Me*

Nothing:

ufw status
Status: inactive

iptables -L
Chain INPUT (policy ACCEPT)
target prot opt source destination

Chain FORWARD (policy ACCEPT)
target prot opt source destination

Chain OUTPUT (policy ACCEPT)
target prot opt source destination

http and https works for my IP I can reach many sites. Only weird issues with
some like this one. I contacted my ISP they said they didn&#39;t block it.
I contacted RKN they said they didn&#39;t either. Someone in the middle drops
https packets or smth weird is going on on DO side. I have no clue either...

*They*
This would seem to suggest that there are ISP level blocks of certain IPs and
ranges are happening. I&#39;m located in the US and if I curl 159.89.156.100, I get
a 200 OK response.

There is unfortunately not much we can do about that, since we don&#39;t have
control over how your ISP might manage or block traffic. I would recommend
bringing this to the attention of your ISP and seeing if they can confirm if
this is the case or not.
</pre></div>
</td></tr></table></div>
  <div class='share'>
    <a class="twitter-share-button" data-via="rO_Oute" href="https://twitter.com/share">Tweet</a>
    <script type='text/javascript'>
      //<![CDATA[
        !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
      //]]>
    </script>
  </div>
</article>
      <footer>
        Copyright  2012-2014
        <a target="_blank" href="https://github.com/route">Dmitry Vorotilin</a>
        |
        <a target="_blank" href="cv.html">CV</a>
        |
        <a target="_blank" href="http://evrone.com">Evrone.com</a>
      </footer>
      <div class='yandex_metrika'>
        <!-- Yandex.Metrika informer -->
        <a href="https://metrika.yandex.ru/stat/?id=25785359&amp;from=informer"
        target="_blank" rel="nofollow"><img src="//bs.yandex.ru/informer/25785359/1_0_FFFFFFFF_EFEFEFFF_0_pageviews"
        style="width:80px; height:15px; border:0;" alt="." title=".:    ()" /></a>
        <!-- /Yandex.Metrika informer -->
        
        <!-- Yandex.Metrika counter -->
        <script type="text/javascript">
        (function (d, w, c) {
            (w[c] = w[c] || []).push(function() {
                try {
                    w.yaCounter25785359 = new Ya.Metrika({id:25785359,
                            webvisor:true,
                            clickmap:true,
                            trackLinks:true,
                            accurateTrackBounce:true});
                } catch(e) { }
            });
        
            var n = d.getElementsByTagName("script")[0],
                s = d.createElement("script"),
                f = function () { n.parentNode.insertBefore(s, n); };
            s.type = "text/javascript";
            s.async = true;
            s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js";
        
            if (w.opera == "[object Opera]") {
                d.addEventListener("DOMContentLoaded", f, false);
            } else { f(); }
        })(document, window, "yandex_metrika_callbacks");
        </script>
        <noscript><div><img src="//mc.yandex.ru/watch/25785359" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
        <!-- /Yandex.Metrika counter -->
      </div>
    </div>
  </body>
</html>

