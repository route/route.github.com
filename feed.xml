<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>NOPe Code</title>
  <id>http://route.github.io/</id>
  <link href="http://route.github.io/"/>
  <link href="http://route.github.io/feed.xml" rel="self"/>
  <updated>2025-01-14T00:00:00+03:00</updated>
  <author>
    <name>Dmitry Vorotilin</name>
  </author>
  <entry>
    <title>AI is going to steal your job because you are dumb</title>
    <link rel="alternate" href="/2025/01/14/ai-is-not-stealing-my-job.html"/>
    <id>/2025/01/14/ai-is-not-stealing-my-job.html</id>
    <published>2025-01-14T00:00:00+03:00</published>
    <updated>2025-01-14T00:00:00+03:00</updated>
    <author>
      <name>Dmitry Vorotilin</name>
    </author>
    <summary type="html">&lt;p&gt;AI is never going to steal my job. Period. &lt;/p&gt;

&lt;p&gt;there are tasks that you can’t google, you have to fit it into your memory, grasp and produce the result. These kind of tasks are ungoogled. &lt;/p&gt;

&lt;p&gt;better code is no code, better ticket is not ticket.&lt;/p&gt;

&lt;p&gt;a better...&lt;/p&gt;</summary>
    <content type="html">&lt;p&gt;AI is never going to steal my job. Period. &lt;/p&gt;

&lt;p&gt;there are tasks that you can&amp;rsquo;t google, you have to fit it into your memory, grasp and produce the result. These kind of tasks are ungoogled. &lt;/p&gt;

&lt;p&gt;better code is no code, better ticket is not ticket.&lt;/p&gt;

&lt;p&gt;a better engineer before starting to work on the ticket should ask himself, does business need this feature?&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>OpenVPN without PKI on Ubuntu 24.04</title>
    <link rel="alternate" href="/2024/12/16/ubuntu-no-pki-openvpn.html"/>
    <id>/2024/12/16/ubuntu-no-pki-openvpn.html</id>
    <published>2024-12-16T00:00:00+03:00</published>
    <updated>2024-12-16T00:00:00+03:00</updated>
    <author>
      <name>Dmitry Vorotilin</name>
    </author>
    <summary type="html">&lt;p&gt;It’s mostly copy-paste version of the original OpenVPN &lt;a href="https://github.com/openvpn/openvpn/blob/master/doc/man-sections/example-fingerprint.rst"&gt;example&lt;/a&gt; with
exception to editing &lt;code&gt;/etc/sysctl.conf&lt;/code&gt;, figuring out default interface and downloading ovpn file.&lt;/p&gt;

&lt;h3&gt;Install and copy configs:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;apt update
&lt;span class="nb"&gt;sudo &lt;/span&gt;apt upgrade
&lt;span class="nb"&gt;sudo &lt;/span&gt;reboot
&lt;span class="nb"&gt;sudo &lt;/span&gt;apt &lt;span class="nb"&gt;install...&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</summary>
    <content type="html">&lt;p&gt;It&amp;rsquo;s mostly copy-paste version of the original OpenVPN &lt;a href="https://github.com/openvpn/openvpn/blob/master/doc/man-sections/example-fingerprint.rst"&gt;example&lt;/a&gt; with
exception to editing &lt;code&gt;/etc/sysctl.conf&lt;/code&gt;, figuring out default interface and downloading ovpn file.&lt;/p&gt;

&lt;h3&gt;Install and copy configs:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;apt update
&lt;span class="nb"&gt;sudo &lt;/span&gt;apt upgrade
&lt;span class="nb"&gt;sudo &lt;/span&gt;reboot
&lt;span class="nb"&gt;sudo &lt;/span&gt;apt &lt;span class="nb"&gt;install &lt;/span&gt;openvpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Generate server/client configs:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;export &lt;/span&gt;&lt;span class="nv"&gt;CLIENT_NAME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;client &lt;span class="c"&gt;# arbitrary client name&lt;/span&gt;
&lt;span class="nb"&gt;export &lt;/span&gt;&lt;span class="nv"&gt;REMOTE_SERVER_IP&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;'x.x.x.x'&lt;/span&gt; &lt;span class="c"&gt;# public ip address of the server&lt;/span&gt;

openssl req &lt;span class="nt"&gt;-x509&lt;/span&gt; &lt;span class="nt"&gt;-newkey&lt;/span&gt; ec:&amp;lt;&lt;span class="o"&gt;(&lt;/span&gt;openssl ecparam &lt;span class="nt"&gt;-name&lt;/span&gt; secp384r1&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="nt"&gt;-keyout&lt;/span&gt; server.key &lt;span class="nt"&gt;-out&lt;/span&gt; server.crt &lt;span class="nt"&gt;-nodes&lt;/span&gt; &lt;span class="nt"&gt;-sha256&lt;/span&gt; &lt;span class="nt"&gt;-days&lt;/span&gt; 3650 &lt;span class="nt"&gt;-subj&lt;/span&gt; &lt;span class="s1"&gt;'/CN=server'&lt;/span&gt;
&lt;span class="nb"&gt;export &lt;/span&gt;&lt;span class="nv"&gt;SERVER_FINGERPRINT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;$(&lt;/span&gt;openssl x509 &lt;span class="nt"&gt;-fingerprint&lt;/span&gt; &lt;span class="nt"&gt;-sha256&lt;/span&gt; &lt;span class="nt"&gt;-in&lt;/span&gt; server.crt &lt;span class="nt"&gt;-noout&lt;/span&gt; | &lt;span class="nb"&gt;cut&lt;/span&gt; &lt;span class="nt"&gt;-d&lt;/span&gt;&lt;span class="s1"&gt;'='&lt;/span&gt; &lt;span class="nt"&gt;-f2&lt;/span&gt;&lt;span class="si"&gt;)&lt;/span&gt;

openssl req &lt;span class="nt"&gt;-x509&lt;/span&gt; &lt;span class="nt"&gt;-newkey&lt;/span&gt; ec:&amp;lt;&lt;span class="o"&gt;(&lt;/span&gt;openssl ecparam &lt;span class="nt"&gt;-name&lt;/span&gt; secp384r1&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="nt"&gt;-nodes&lt;/span&gt; &lt;span class="nt"&gt;-sha256&lt;/span&gt; &lt;span class="nt"&gt;-days&lt;/span&gt; 3650 &lt;span class="nt"&gt;-subj&lt;/span&gt; &lt;span class="s2"&gt;"/CN=&lt;/span&gt;&lt;span class="k"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;CLIENT_NAME&lt;/span&gt;&lt;span class="k"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; client.cert
&lt;span class="nb"&gt;export &lt;/span&gt;&lt;span class="nv"&gt;CLIENT_CERTIFICATE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;$(&lt;/span&gt;&amp;lt;client.cert&lt;span class="si"&gt;)&lt;/span&gt;
&lt;span class="nb"&gt;export &lt;/span&gt;&lt;span class="nv"&gt;CLIENT_PRIVATE_KEY&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;$(&lt;/span&gt;&amp;lt;privkey.pem&lt;span class="si"&gt;)&lt;/span&gt;

&lt;span class="nb"&gt;cat&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class="no"&gt;EOF&lt;/span&gt;&lt;span class="sh"&gt;
remote &lt;/span&gt;&lt;span class="nv"&gt;$REMOTE_SERVER_IP&lt;/span&gt;&lt;span class="sh"&gt; 1194 udp

client
nobind
dev tun
tun-mtu 1400

key-direction 1

redirect-gateway def1

&amp;lt;key&amp;gt;
&lt;/span&gt;&lt;span class="nv"&gt;$CLIENT_PRIVATE_KEY&lt;/span&gt;&lt;span class="sh"&gt;
&amp;lt;/key&amp;gt;

&amp;lt;cert&amp;gt;
&lt;/span&gt;&lt;span class="nv"&gt;$CLIENT_CERTIFICATE&lt;/span&gt;&lt;span class="sh"&gt;
&amp;lt;/cert&amp;gt;

peer-fingerprint &lt;/span&gt;&lt;span class="nv"&gt;$SERVER_FINGERPRINT&lt;/span&gt;&lt;span class="sh"&gt;
&lt;/span&gt;&lt;span class="no"&gt;
EOF

&lt;/span&gt;&lt;span class="nb"&gt;export &lt;/span&gt;&lt;span class="nv"&gt;CLIENT_FINGERPRINT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="si"&gt;$(&lt;/span&gt;openssl x509 &lt;span class="nt"&gt;-fingerprint&lt;/span&gt; &lt;span class="nt"&gt;-sha256&lt;/span&gt; &lt;span class="nt"&gt;-noout&lt;/span&gt; &lt;span class="nt"&gt;-in&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn | &lt;span class="nb"&gt;cut&lt;/span&gt; &lt;span class="nt"&gt;-d&lt;/span&gt;&lt;span class="s1"&gt;'='&lt;/span&gt; &lt;span class="nt"&gt;-f2&lt;/span&gt;&lt;span class="si"&gt;)&lt;/span&gt;

&lt;span class="nb"&gt;cat&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; server.conf &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class="no"&gt;EOF&lt;/span&gt;&lt;span class="sh"&gt;
server 192.168.255.0 255.255.255.0

cert server/server.crt
key server/server.key
dh none

proto udp
port 1194
dev tun
tun-mtu 1400

&amp;lt;peer-fingerprint&amp;gt;
&lt;/span&gt;&lt;span class="nv"&gt;$CLIENT_FINGERPRINT&lt;/span&gt;&lt;span class="sh"&gt;
&amp;lt;/peer-fingerprint&amp;gt;

explicit-exit-notify 1

keepalive 10 60

push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"
&lt;/span&gt;&lt;span class="no"&gt;
EOF

&lt;/span&gt;&lt;span class="nb"&gt;rm &lt;/span&gt;client.cert privkey.pem
&lt;span class="nb"&gt;sudo mv &lt;/span&gt;server.key server.crt /etc/openvpn/server
&lt;span class="nb"&gt;sudo mv&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn /etc/openvpn/client
&lt;span class="nb"&gt;sudo mv &lt;/span&gt;server.conf /etc/openvpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;That&amp;rsquo;s basically it, we only need to allow traffic to be NATed through the
server. Set &lt;code&gt;net.ipv4.ip_forward=1&lt;/code&gt; in this file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;sysctl &lt;span class="nt"&gt;-w&lt;/span&gt; net.ipv4.ip_forward&lt;span class="o"&gt;=&lt;/span&gt;1
&lt;span class="nb"&gt;sudo &lt;/span&gt;vim /etc/sysctl.conf &lt;span class="c"&gt;# edit this file, so that setting is applied after reboot&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Find your default interface:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;ip route | &lt;span class="nb"&gt;grep &lt;/span&gt;default
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Output should be like: default via x.x.x.x dev &lt;code&gt;ens5&lt;/code&gt; proto dhcp src x.x.x.x
metric 100. Remember your interface name and put it to iptables rules below:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;iptables &lt;span class="nt"&gt;-t&lt;/span&gt; nat &lt;span class="nt"&gt;-A&lt;/span&gt; POSTROUTING &lt;span class="nt"&gt;-o&lt;/span&gt; ens5 &lt;span class="nt"&gt;-j&lt;/span&gt; MASQUERADE
&lt;span class="nb"&gt;sudo &lt;/span&gt;iptables &lt;span class="nt"&gt;-A&lt;/span&gt; FORWARD &lt;span class="nt"&gt;-j&lt;/span&gt; ACCEPT
&lt;span class="nb"&gt;sudo &lt;/span&gt;apt-get &lt;span class="nb"&gt;install &lt;/span&gt;iptables-persistent
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;When you install iptables-persistent it will ask you to save current rules into
file, just agree with that and then start the service:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;systemctl &lt;span class="nb"&gt;enable &lt;/span&gt;openvpn@server
&lt;span class="nb"&gt;sudo &lt;/span&gt;systemctl start openvpn@server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now you can download &lt;code&gt;$CLIENT_NAME.ovpn&lt;/code&gt; to your machine and start browsing internet securely:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;scp ubuntu@&amp;lt;server-ip&amp;gt;:/etc/openvpn/client/&amp;lt;client-name&amp;gt;.ovpn ./
&lt;span class="nb"&gt;sudo &lt;/span&gt;openvpn &amp;lt;client-name&amp;gt;.ovpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content>
  </entry>
  <entry>
    <title>Free VPN for a lifetime in Oracle cloud</title>
    <link rel="alternate" href="/2021/12/04/free-openvpn-for-a-lifetime.html"/>
    <id>/2021/12/04/free-openvpn-for-a-lifetime.html</id>
    <published>2021-12-04T00:00:00+03:00</published>
    <updated>2021-12-04T00:00:00+03:00</updated>
    <author>
      <name>Dmitry Vorotilin</name>
    </author>
    <summary type="html">&lt;p&gt;Yes you heard it right, for a lifetime! Oracle Cloud has a &lt;a href="https://www.oracle.com/cloud/free/"&gt;tremendous proposal&lt;/a&gt;, on
their Free Tier you can use “Always Free” services including &lt;a href="https://www.oracle.com/cloud/compute/arm/"&gt;Arm Ampere A1 Compute&lt;/a&gt;
instances. Yea you can create instances with up to 24 Gb of memory and 4 CPU cores...&lt;/p&gt;</summary>
    <content type="html">&lt;p&gt;Yes you heard it right, for a lifetime! Oracle Cloud has a &lt;a href="https://www.oracle.com/cloud/free/"&gt;tremendous proposal&lt;/a&gt;, on
their Free Tier you can use &amp;ldquo;Always Free&amp;rdquo; services including &lt;a href="https://www.oracle.com/cloud/compute/arm/"&gt;Arm Ampere A1 Compute&lt;/a&gt;
instances. Yea you can create instances with up to 24 Gb of memory and 4 CPU cores. It can be one or a few it&amp;rsquo;s up to
you, but it should be in the specified limits.&lt;/p&gt;

&lt;p&gt;We are going to create OpenVPN server using &lt;a href="https://learn.hashicorp.com/tutorials/terraform/install-cli"&gt;Terraform&lt;/a&gt; and
&lt;a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html"&gt;Ansible&lt;/a&gt;. Make sure you have them
installed, as I won&amp;rsquo;t go into installation details here.&lt;/p&gt;

&lt;p&gt;At this point, you&amp;rsquo;ll have set &lt;a href="https://signup.cloud.oracle.com/?language=en&amp;amp;sourceType=:ow:o:p:feb:0916FreePageBannerButton&amp;amp;intcmp=:ow:o:p:feb:0916FreePageBannerButton"&gt;Oracle account&lt;/a&gt;,
and it&amp;rsquo;s time to create API keys. Go to your &amp;ldquo;Profile&amp;rdquo; ➞ &amp;ldquo;API keys&amp;rdquo; and click &amp;ldquo;Add API Key&amp;rdquo;. Copy what you are given and
download pem key to &lt;code&gt;~/.oci&lt;/code&gt; folder.&lt;/p&gt;

&lt;p&gt;Run commands below:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;git clone git@github.com:route/oracle.git &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
  &lt;span class="nb"&gt;cd &lt;/span&gt;oracle &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
  &lt;span class="nb"&gt;cp &lt;/span&gt;tf.env.example tf.env &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
  &lt;span class="nb"&gt;cp &lt;/span&gt;compute/vpn/ovpn.env.example compute/vpn/ovpn.env
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Open it with your favorite editor and paste values Oracle provided to &lt;code&gt;tf.env&lt;/code&gt;. Fill in &lt;code&gt;INSTANCE_SSH_PUBLIC_KEY&lt;/code&gt; as
well, it&amp;rsquo;s used to ssh into the server using your public ssh key. By default, we create 1 Cpu x 2 Gb machine.&lt;/p&gt;

&lt;p&gt;Go to &lt;code&gt;compute/vpn&lt;/code&gt; as well and fill in values for OpenVPN file &lt;code&gt;ovpn.env&lt;/code&gt;. Set &lt;code&gt;OPENVPN_EASY_RSA_*&lt;/code&gt; variables with
arbitrary data needed for certificates. Config files are generated for clients listed in &lt;code&gt;OPENVPN_CLIENTS&lt;/code&gt; variable. Set
as many names as you&amp;rsquo;d like to have people.&lt;/p&gt;

&lt;p&gt;If all is set then run:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;./configure
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After running this you&amp;rsquo;ll have a server up and running and two openvpn config files &lt;code&gt;linux.ovpn&lt;/code&gt; and &lt;code&gt;mac.ovpn&lt;/code&gt;
downloaded in &lt;code&gt;compute/vpn/ansinle/clients&lt;/code&gt; folder. Now you can use them to browse internet privately. For linux you can
set up OpenVPN tunnel in settings, for mac I prefer &lt;a href="https://www.sparklabs.com/viscosity/"&gt;Viscosity&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;If you&amp;rsquo;d like to add more clients, change &lt;code&gt;ovpn.env&lt;/code&gt; and run &lt;code&gt;(cd compute/vpn &amp;amp;&amp;amp; ./configure run openvpn_clients)&lt;/code&gt; &lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Hi! It's me, your flaky system test again</title>
    <link rel="alternate" href="/2021/03/03/your-flaky-system-test-again.html"/>
    <id>/2021/03/03/your-flaky-system-test-again.html</id>
    <published>2021-03-03T00:00:00+03:00</published>
    <updated>2021-03-03T00:00:00+03:00</updated>
    <author>
      <name>Dmitry Vorotilin</name>
    </author>
    <summary type="html">&lt;h6&gt;To my grandfather, who was always curious about how things work&lt;/h6&gt;

&lt;p&gt;There are many articles on how to &lt;a href="https://thoughtbot.com/blog/write-reliable-asynchronous-integration-tests-with-capybara"&gt;write reliable capybara tests&lt;/a&gt;.
There are less articles on how to deal with your &lt;a href="https://www.mayerdan.com/ruby/2019/09/07/flaky-ruby-tests"&gt;flaky tests&lt;/a&gt;.
There are none I’ve found on how to properly debug and really...&lt;/p&gt;</summary>
    <content type="html">&lt;h6&gt;To my grandfather, who was always curious about how things work&lt;/h6&gt;

&lt;p&gt;There are many articles on how to &lt;a href="https://thoughtbot.com/blog/write-reliable-asynchronous-integration-tests-with-capybara"&gt;write reliable capybara tests&lt;/a&gt;.
There are less articles on how to deal with your &lt;a href="https://www.mayerdan.com/ruby/2019/09/07/flaky-ruby-tests"&gt;flaky tests&lt;/a&gt;.
There are none I&amp;rsquo;ve found on how to properly debug and really fight flaky tests back, this one is about it. I want you to
get comfortable with the tools I use and get along with me while we debug one of the failing specs so thus I provide a
single runnable file but for your rails application the setup is obvious: &lt;a href="https://evilmartians.com/chronicles/system-of-a-test-setting-up-end-to-end-rails-testing"&gt;System of a test: Proper browser testing in Ruby on Rails&lt;/a&gt;&lt;/p&gt;

&lt;h3&gt;What we have?&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight ruby"&gt;&lt;code&gt;&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s2"&gt;"bundler/inline"&lt;/span&gt;

&lt;span class="n"&gt;gemfile&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;
  &lt;span class="n"&gt;source&lt;/span&gt; &lt;span class="s2"&gt;"https://rubygems.org"&lt;/span&gt;

  &lt;span class="n"&gt;gem&lt;/span&gt; &lt;span class="s2"&gt;"puma"&lt;/span&gt;
  &lt;span class="n"&gt;gem&lt;/span&gt; &lt;span class="s2"&gt;"rspec"&lt;/span&gt;
  &lt;span class="n"&gt;gem&lt;/span&gt; &lt;span class="s2"&gt;"capybara"&lt;/span&gt;
  &lt;span class="n"&gt;gem&lt;/span&gt; &lt;span class="s2"&gt;"cuprite"&lt;/span&gt;
  &lt;span class="n"&gt;gem&lt;/span&gt; &lt;span class="s2"&gt;"ferrum"&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;

&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s2"&gt;"rspec/autorun"&lt;/span&gt;
&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s2"&gt;"capybara/rspec"&lt;/span&gt;
&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s2"&gt;"capybara/cuprite"&lt;/span&gt;

&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;app&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;proc&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{},&lt;/span&gt; &lt;span class="no"&gt;File&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"index.html"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"r"&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;default_driver&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="ss"&gt;:cuprite&lt;/span&gt;
&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;register_driver&lt;/span&gt; &lt;span class="ss"&gt;:cuprite&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
  &lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Cuprite&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Driver&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;

&lt;span class="n"&gt;describe&lt;/span&gt; &lt;span class="s2"&gt;"flaky spec"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;type: :feature&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;
  &lt;span class="n"&gt;let&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:email&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="s2"&gt;"email@example.com"&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
  &lt;span class="n"&gt;let&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:first_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="s2"&gt;"Firstname"&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
  &lt;span class="n"&gt;let&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:last_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="s2"&gt;"Lastname"&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;

  &lt;span class="n"&gt;it&lt;/span&gt; &lt;span class="s2"&gt;"submits form successfully"&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;
    &lt;span class="n"&gt;visit&lt;/span&gt; &lt;span class="s2"&gt;"/"&lt;/span&gt;

    &lt;span class="n"&gt;fill_in&lt;/span&gt; &lt;span class="s2"&gt;"email"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;with: &lt;/span&gt;&lt;span class="n"&gt;email&lt;/span&gt;
    &lt;span class="n"&gt;click_button&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Next"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;fill_in&lt;/span&gt; &lt;span class="s2"&gt;"first-name"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;with: &lt;/span&gt;&lt;span class="n"&gt;first_name&lt;/span&gt;
    &lt;span class="n"&gt;fill_in&lt;/span&gt; &lt;span class="s2"&gt;"last-name"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;with: &lt;/span&gt;&lt;span class="n"&gt;last_name&lt;/span&gt;
    &lt;span class="n"&gt;click_button&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Finish"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;expect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;page&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nf"&gt;to&lt;/span&gt; &lt;span class="n"&gt;have_text&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Successfully sent"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and our simplified html markup:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight html"&gt;&lt;code&gt;&lt;span class="cp"&gt;&amp;lt;!doctype html&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;html&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;head&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;style&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;body&lt;/span&gt; &lt;span class="nt"&gt;form&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nl"&gt;display&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;block&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="nl"&gt;margin&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="m"&gt;10px&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
      &lt;span class="nf"&gt;#hint&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nc"&gt;.step&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nl"&gt;display&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;none&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
      &lt;span class="nc"&gt;.active&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nl"&gt;display&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;block&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;/style&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;/head&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;body&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;form&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;div&lt;/span&gt; &lt;span class="na"&gt;class=&lt;/span&gt;&lt;span class="s"&gt;"step active"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;input&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"email"&lt;/span&gt; &lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;div&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"hint"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;Please add here your email&lt;span class="nt"&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;button&lt;/span&gt; &lt;span class="na"&gt;class=&lt;/span&gt;&lt;span class="s"&gt;"btn"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;Next&lt;span class="nt"&gt;&amp;lt;/button&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;div&lt;/span&gt; &lt;span class="na"&gt;class=&lt;/span&gt;&lt;span class="s"&gt;"step"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;input&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"first-name"&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;"text"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;input&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"last-name"&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;"text"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;button&lt;/span&gt; &lt;span class="na"&gt;class=&lt;/span&gt;&lt;span class="s"&gt;"btn"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;Finish&lt;span class="nt"&gt;&amp;lt;/button&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;div&lt;/span&gt; &lt;span class="na"&gt;class=&lt;/span&gt;&lt;span class="s"&gt;"step"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;p&amp;gt;&lt;/span&gt;Successfully sent&lt;span class="nt"&gt;&amp;lt;/p&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;/form&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;script &lt;/span&gt;&lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;"text/javascript"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
      &lt;span class="nx"&gt;setTimeout&lt;/span&gt;&lt;span class="p"&gt;(()&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nb"&gt;document&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;getElementById&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="s2"&gt;hint&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nx"&gt;style&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;display&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="s2"&gt;block&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
      &lt;span class="p"&gt;},&lt;/span&gt; &lt;span class="mi"&gt;55&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

      &lt;span class="nb"&gt;document&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;addEventListener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="s2"&gt;click&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;event&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;event&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;preventDefault&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;

        &lt;span class="nx"&gt;parent&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;event&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;target&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;parentElement&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="nx"&gt;parent&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;classList&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="s2"&gt;active&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="nx"&gt;parent&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;nextElementSibling&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;classList&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="s2"&gt;active&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
      &lt;span class="p"&gt;});&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Save it as &lt;code&gt;flaky_spec.rb&lt;/code&gt; and &lt;code&gt;index.html&lt;/code&gt; respectively. Run with &lt;code&gt;ruby flaky_spec.rb&lt;/code&gt;. In our test we have a multi-step
form, where you fill in an email, click &amp;ldquo;Next&amp;rdquo; and then finish the form with first and last name. A bit of vanilla JS is
to hide second step fields and activate when we need them. We also show some kind of a hint under the first input with a
bit of delay. The test works just fine, why wouldn&amp;rsquo;t it? We use waiting matchers, no AJAX, no styles, single page and
just a handful of JS and yet very very rare it fails:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;Failures:

  1&lt;span class="o"&gt;)&lt;/span&gt; flaky spec submits form successfully
     Failure/Error: fill_in &lt;span class="s2"&gt;"first-name"&lt;/span&gt;, with: first_name

     Capybara::ElementNotFound:
       Unable to find visible field &lt;span class="s2"&gt;"first-name"&lt;/span&gt; that is not disabled
     &lt;span class="c"&gt;# flaky_spec:34:in `block (2 levels) in &amp;lt;main&amp;gt;'&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The error shows that after we fill an email and click &amp;ldquo;Next&amp;rdquo; capybara cannot find any visible input for &lt;code&gt;first-name&lt;/code&gt;.
So obviously the issue happens after we click on the &amp;ldquo;Next&amp;rdquo; button. You might guess that &lt;code&gt;fill_in&lt;/code&gt; cannot find input
because it doesn&amp;rsquo;t have waiting capabilities but it does. Why in the hell test fails? After a couple of hours playing
around with such kind of a test developers usually give up and start using &lt;code&gt;rspec-retry&lt;/code&gt;, but we are going to hunt it
down.&lt;/p&gt;

&lt;h3&gt;What do we do?&lt;/h3&gt;

&lt;h4&gt;Headful mode + slowmo option&lt;/h4&gt;

&lt;p&gt;To start debugging system tests means that we need to see what&amp;rsquo;s going on in the browser. First of all we can run test
in a headful mode and see it with our own eyes:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight ruby"&gt;&lt;code&gt;&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;default_driver&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="ss"&gt;:cuprite&lt;/span&gt;
&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;register_driver&lt;/span&gt; &lt;span class="ss"&gt;:cuprite&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
  &lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Cuprite&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Driver&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="ss"&gt;headless:  &lt;/span&gt;&lt;span class="no"&gt;ENV&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"HEADLESS"&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="s2"&gt;"false"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="ss"&gt;slowmo: &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;ENV&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"SLOWMO"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;0.2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="no"&gt;ENV&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"HEADLESS"&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;"false"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="p"&gt;})&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Run with &lt;code&gt;HEADLESS=false ruby flaky_spec.rb&lt;/code&gt; and see it passing. We also add &lt;code&gt;:slowmo&lt;/code&gt; option with delay set to &lt;code&gt;0.2&lt;/code&gt;
without it everything happens way fast and we can barely see what&amp;rsquo;s going on. Experiment with &lt;code&gt;:slowmo&lt;/code&gt; option making
the test not too slow and not too fast. Unfortunately this doesn&amp;rsquo;t help us to spot an issue, because test is always
passing but it&amp;rsquo;s a good technique for starters.&lt;/p&gt;

&lt;h4&gt;Inspector&lt;/h4&gt;

&lt;p&gt;Another useful trick we can try is to put &lt;code&gt;page.driver.debug&lt;/code&gt; statement to the test to make it pause and open the
browser for us to debug, first let&amp;rsquo;s add inspector option to the driver:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight ruby"&gt;&lt;code&gt;&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;default_driver&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="ss"&gt;:cuprite&lt;/span&gt;
&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;register_driver&lt;/span&gt; &lt;span class="ss"&gt;:cuprite&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
  &lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Cuprite&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Driver&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="ss"&gt;inspector: &lt;/span&gt;&lt;span class="no"&gt;ENV&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"INSPECTOR"&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;"true"&lt;/span&gt;
  &lt;span class="p"&gt;})&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;then:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight ruby"&gt;&lt;code&gt;&lt;span class="n"&gt;fill_in&lt;/span&gt; &lt;span class="s2"&gt;"email"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;with: &lt;/span&gt;&lt;span class="n"&gt;email&lt;/span&gt;
&lt;span class="n"&gt;click_button&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Next"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;page&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;driver&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;debug&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and run it with &lt;code&gt;INSPECTOR=true ruby flaky_spec.rb&lt;/code&gt;. We will see in the console that test is paused:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;Cuprite execution paused. Press enter &lt;span class="o"&gt;(&lt;/span&gt;or run &lt;span class="s1"&gt;'kill -CONT 1098635'&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; to &lt;span class="k"&gt;continue&lt;/span&gt;&lt;span class="nb"&gt;.&lt;/span&gt;
Opening &lt;span class="k"&gt;in &lt;/span&gt;existing browser session.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and Chrome window is ready and showing us inspectable pages:&lt;/p&gt;

&lt;p&gt;&lt;img src="/images/inspectable_pages.png" class="img-fluid" alt="inspectable pages"&gt;
&lt;img src="/images/inspectable_content.png" class="img-fluid" alt="inspectable content"&gt;&lt;/p&gt;

&lt;p&gt;You can also call &lt;code&gt;page.driver.debug(binding)&lt;/code&gt; and besides opening the browser Cuprite starts pry or irb console where
you can execute some statements in the test&amp;rsquo;s context. If you are lucky enough, this debugging technique can show you
that capybara cannot find &lt;code&gt;first-name&lt;/code&gt; input because page is still showing the first step and for some reason hasn&amp;rsquo;t
switch to the second. We came a little closer to the clue, but it&amp;rsquo;s not enough.&lt;/p&gt;

&lt;h4&gt;Logger option&lt;/h4&gt;

&lt;p&gt;Using logger we can see all the messages our Ruby process exchanges with Chrome. Cuprite uses CDP protocol to control
Chrome. When your test starts running Cuprite spawns Chrome which listens to the messages through a websocket. Turning
logger on just shows in the console all the messages both processes exchange. Run &lt;code&gt;CUPRITE_DEBUG=true ruby flaky_spec.rb&lt;/code&gt;
and you&amp;rsquo;ll see a lot of output in your console. Now it&amp;rsquo;s time to makes some sense out of it. The command we send to
Chrome starts with ▶ and shows the direction of the message:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;▶ 0.32 &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"method"&lt;/span&gt;:&lt;span class="s2"&gt;"Page.navigate"&lt;/span&gt;,&lt;span class="s2"&gt;"params"&lt;/span&gt;:&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"url"&lt;/span&gt;:&lt;span class="s2"&gt;"http://127.0.0.1:46551/listings"&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,&lt;span class="s2"&gt;"id"&lt;/span&gt;:1014&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;the answer we get back:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;◀ 1.30 &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"id"&lt;/span&gt;:1014,&lt;span class="s2"&gt;"result"&lt;/span&gt;:&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"frameId"&lt;/span&gt;:&lt;span class="s2"&gt;"3EBE..."&lt;/span&gt;,&lt;span class="s2"&gt;"loaderId"&lt;/span&gt;:&lt;span class="s2"&gt;"A97..."&lt;/span&gt;&lt;span class="o"&gt;}}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Digits you see after the direction sign is elapsed time and the message is just a simple JSON. Note matching ids, you
provide a unique numeric id with the message and Chrome has the same id for the response. You pass the command you&amp;rsquo;d like
Chrome to invoke in &lt;code&gt;method&lt;/code&gt; with params in &lt;code&gt;params&lt;/code&gt;. The whole list of commands for CDP protocol is &lt;a href="https://chromedevtools.github.io/devtools-protocol/"&gt;here&lt;/a&gt;.
Let&amp;rsquo;s work on the terminology. First of all I would be ashamed to steal pictures and actually I&amp;rsquo;m ashamed, but this one
is exactly how it is in Puppeteer except that I replaced this wording with Cuprite.&lt;/p&gt;

&lt;p&gt;&lt;img src="/images/cuprite_schema.png" class="img-fluid" alt="cuprite schema"&gt;&lt;/p&gt;

&lt;p&gt;If you want to create a new page and make it go to example.com you first have to create new browser context:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Target.createBrowserContext"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"result"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"browserContextId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"9A688D2E33EB21D8FE5144A1481C2BF8"&lt;/span&gt;&lt;span class="p"&gt;}}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Context has an id and resembles an incognito session, you can create many pages in the same context and than just
dispose it with all the pages at once in the end. Create a page in the context:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Target.createTarget"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"browserContextId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"9A688D2E33EB21D8FE5144A1481C2BF8"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"url"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"about:blank"&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"result"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"targetId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"F135A71EEF7D8A39547AB4C5BB3C9942"&lt;/span&gt;&lt;span class="p"&gt;}}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Yes page is called a target in CDP terminology. Note that we pass &lt;code&gt;browserContextId&lt;/code&gt; and a url. Chrome sends us back
&lt;code&gt;targetId&lt;/code&gt;. Now page is created and it&amp;rsquo;s time to subscribe to interesting events we&amp;rsquo;d like to be notified of. It can be DOM or CSS,
there are many of them. I think I should mention &lt;code&gt;Runtime&lt;/code&gt; as it&amp;rsquo;s important:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Runtime.enable"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1002&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Runtime.executionContextCreated"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"context"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"origin"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"://"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"name"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;""&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"auxData"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"isDefault"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"type"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"default"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"frameId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"F135A71EEF7D8A39547AB4C5BB3C9942"&lt;/span&gt;&lt;span class="p"&gt;}}}}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1002&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"result"&lt;/span&gt;&lt;span class="p"&gt;:{}}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It&amp;rsquo;s another context, but this time it&amp;rsquo;s related to JS world, this is the context where all the JS is executed for this
page. Each page has a main frame and each frame has it&amp;rsquo;s own execution context. Now we can tell the page to navigate
to the given url:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Page.navigate"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"url"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"http://127.0.0.1:36555/"&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1014&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As we are executing test the url obviously shows us loopback interface where capybara is running our application with
puma. After this call there are some network events and messages regarding page state, and we move to the point where
capybara starts filling the email and in order to do that it has to find such node first:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Runtime.callFunctionOn"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"executionContextId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"functionDeclaration"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"function() { return _cuprite.find(arguments[0], arguments[1]) }"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"arguments"&lt;/span&gt;&lt;span class="p"&gt;:[{&lt;/span&gt;&lt;span class="nl"&gt;"value"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"xpath"&lt;/span&gt;&lt;span class="p"&gt;},{&lt;/span&gt;&lt;span class="nl"&gt;"value"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"./descendant::*[self::input | self::textarea][not(((((((./@type = 'submit') or (./@type = 'image')) or (./@type = 'radio')) or (./@type = 'checkbox')) or (./@type = 'hidden')) or (./@type = 'file')))][((((./@id = 'email') or (./@name = 'email')) or (./@placeholder = 'email')) or (./@id = //label[(normalize-space(string(.)) = 'email')]/@for))] | .//label[(normalize-space(string(.)) = 'email')]//./descendant::*[self::input | self::textarea][not(((((((./@type = 'submit') or (./@type = 'image')) or (./@type = 'radio')) or (./@type = 'checkbox')) or (./@type = 'hidden')) or (./@type = 'file')))]"&lt;/span&gt;&lt;span class="p"&gt;}]},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1014&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finding a node means executing a JS function in the execution context for the main frame, capybara passes a long
argument - xpath for email input. In return we get &lt;code&gt;Runtime.RemoteObjectId&lt;/code&gt; which can be converted to the &lt;code&gt;nodeId&lt;/code&gt; which
can be used to work with such node, in our case we want to set input&amp;rsquo;s value:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Runtime.callFunctionOn"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"executionContextId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"functionDeclaration"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"function() { return _cuprite.set(arguments[0], arguments[1]) }"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"arguments"&lt;/span&gt;&lt;span class="p"&gt;:[{&lt;/span&gt;&lt;span class="nl"&gt;"objectId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"-8351792869791064162.2.7"&lt;/span&gt;&lt;span class="p"&gt;},{&lt;/span&gt;&lt;span class="nl"&gt;"value"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"email@example.com"&lt;/span&gt;&lt;span class="p"&gt;}]},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1026&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After that we have to find &amp;ldquo;Next&amp;rdquo; button and click it in order to activate next step, so capybara once again finds node
by xpath and this time we need to get coordinates of such node because we have to send click there, so we get content
quads, calculate the coordinates and fire the click:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"DOM.getContentQuads"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"nodeId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1038&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1038&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"result"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"quads"&lt;/span&gt;&lt;span class="p"&gt;:[[&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;41&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mf"&gt;51.40625&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;41&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mf"&gt;51.40625&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;62&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;62&lt;/span&gt;&lt;span class="p"&gt;]]}}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Input.dispatchMouseEvent"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"type"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"mouseMoved"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"x"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;29&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"y"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;51&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1044&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Input.dispatchMouseEvent"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"x"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mf"&gt;29.703125&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"y"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;51&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"type"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"mousePressed"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"button"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"left"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"clickCount"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"modifiers"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1045&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Input.dispatchMouseEvent"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"x"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mf"&gt;29.703125&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"y"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;51&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"type"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"mouseReleased"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"button"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"left"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"clickCount"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"modifiers"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1046&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Notice that we first have to scroll this element into the view, then move mouse and only then click. After that we start
to look for the next xpath for &lt;code&gt;first-name&lt;/code&gt;. Depending on if test passed or not you will either see capybara found input
or tries to find it until give up. So what does it give us? We can clearly see that click happened and if you are an
eagle eye you may have noticed:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"DOM.attributeModified"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"nodeId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;14&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"name"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"class"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"value"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"hint"&lt;/span&gt;&lt;span class="p"&gt;}}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;right between mouse pressed and released. So when we fire the click JS kicks in and our hint appears with &lt;code&gt;display: block&lt;/code&gt;
which moves our button down. It&amp;rsquo;s invented example, but instead of such JS it can be AJAX, styles invalidation, image
loading or many other things that are happeneing when page is still loading. Do you think about such things while writing
the test? Can you remember a real case when you misclicked on the link because some content appeared? It happens for me
quite often. So why your test can&amp;rsquo;t?&lt;/p&gt;

&lt;h3&gt;How to fix it?&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;The answer depends on your application usually. If it&amp;rsquo;s AJAX you have to replace content properly, if it&amp;rsquo;s styles try to
make height static if you can or it will make your end users nervous as well. Always think about asynchronous nature
of the webpage while writing your system tests.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;If you cannot solve issue directly, try to replace &lt;code&gt;click&lt;/code&gt; with &lt;code&gt;trigger(:click)&lt;/code&gt;. There is huge difference between
them as for the latter we don&amp;rsquo;t need coordinates, but there&amp;rsquo;s also downside as your element can be not clickable at all,
obscured by the others and you won&amp;rsquo;t catch it in the tests.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Cuprite also comes with lot&amp;rsquo;s of configurable settings. It actually has node movement protection, but it&amp;rsquo;s set to a
very bare minimum because we don&amp;rsquo;t want to slow down your tests: &lt;code&gt;FERRUM_NODE_MOVING_WAIT=0.01&lt;/code&gt; and &lt;code&gt;FERRUM_NODE_MOVING_ATTEMPTS=50&lt;/code&gt;.
We try to get coordinates of your node a few times with little delay and if it&amp;rsquo;s moving we do max number of attempts
until give up and raise &lt;code&gt;NodeIsMovingError&lt;/code&gt;. You can increase this env variable and check if it makes your build more
stable.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3&gt;Bonus&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nv"&gt;BROWSER_PATH&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/path/to/chrome &lt;span class="c"&gt;# Path to Chrome binary&lt;/span&gt;
&lt;span class="nv"&gt;CUPRITE_DEBUG&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;true&lt;/span&gt; &lt;span class="c"&gt;# Turn on debug mode and show logs in the console same as FERRUM_DEBUG=true&lt;/span&gt;
FERRUM_DEFAULT_TIMEOUT &lt;span class="o"&gt;=&lt;/span&gt; 5 &lt;span class="c"&gt;# How long wait for an answer from Chrome&lt;/span&gt;
FERRUM_PROCESS_TIMEOUT &lt;span class="o"&gt;=&lt;/span&gt; 10 &lt;span class="c"&gt;# How long wait for Chrome process to start&lt;/span&gt;
FERRUM_NODE_MOVING_WAIT &lt;span class="o"&gt;=&lt;/span&gt; 0.01 &lt;span class="c"&gt;# For how long wait before trying to get coordinates again&lt;/span&gt;
FERRUM_NODE_MOVING_ATTEMPTS &lt;span class="o"&gt;=&lt;/span&gt; 50 &lt;span class="c"&gt;# How many attempts to do until give up since node is moving&lt;/span&gt;
FERRUM_CLICK_WAIT &lt;span class="o"&gt;=&lt;/span&gt; 0.1 &lt;span class="c"&gt;# How long wait for frame to start loading after click&lt;/span&gt;
&lt;span class="nv"&gt;CUPRITE_TRIGGER_CLICK_WAIT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;0.1 &lt;span class="c"&gt;# How long wait for frame to start loading after trigger&lt;/span&gt;
&lt;span class="nv"&gt;CUPRITE_MODAL_WAIT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;0.05  &lt;span class="c"&gt;# How long wait for modal dialog&lt;/span&gt;
&lt;span class="nv"&gt;FERRUM_NEW_WINDOW_WAIT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;0.3 &lt;span class="c"&gt;# How long wait for a new window&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content>
  </entry>
  <entry>
    <title>OpenVPN on Ubuntu 18.04</title>
    <link rel="alternate" href="/2018/09/24/ubuntu-openvpn.html"/>
    <id>/2018/09/24/ubuntu-openvpn.html</id>
    <published>2018-09-24T00:00:00+03:00</published>
    <updated>2018-09-24T00:00:00+03:00</updated>
    <author>
      <name>Dmitry Vorotilin</name>
    </author>
    <summary type="html">&lt;h3&gt;Install and copy configs:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;apt update
&lt;span class="nb"&gt;sudo &lt;/span&gt;apt &lt;span class="nb"&gt;install &lt;/span&gt;openvpn
wget &lt;span class="nt"&gt;-P&lt;/span&gt; ~/ https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.4/EasyRSA-3.0.4.tgz
&lt;span class="nb"&gt;tar &lt;/span&gt;zxvf EasyRSA-3.0.4.tgz
&lt;span class="nb"&gt;cd &lt;/span&gt;EasyRSA-3.0.4
&lt;span class="nb"&gt;cp &lt;/span&gt;vars.example vars
vim vars
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Set these variables...&lt;/p&gt;</summary>
    <content type="html">&lt;h3&gt;Install and copy configs:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;apt update
&lt;span class="nb"&gt;sudo &lt;/span&gt;apt &lt;span class="nb"&gt;install &lt;/span&gt;openvpn
wget &lt;span class="nt"&gt;-P&lt;/span&gt; ~/ https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.4/EasyRSA-3.0.4.tgz
&lt;span class="nb"&gt;tar &lt;/span&gt;zxvf EasyRSA-3.0.4.tgz
&lt;span class="nb"&gt;cd &lt;/span&gt;EasyRSA-3.0.4
&lt;span class="nb"&gt;cp &lt;/span&gt;vars.example vars
vim vars
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Set these variables in the file and save:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;vim vars
set_var EASYRSA_REQ_COUNTRY     &lt;span class="s2"&gt;"&amp;lt;COUNTRY&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_PROVINCE    &lt;span class="s2"&gt;"&amp;lt;PROVINCE&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_CITY        &lt;span class="s2"&gt;"&amp;lt;CITY&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_ORG         &lt;span class="s2"&gt;"&amp;lt;ORGANIZATION&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_EMAIL       &lt;span class="s2"&gt;"&amp;lt;EMAIL&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_OU          &lt;span class="s2"&gt;"&amp;lt;ORGANIZATIONAL UNIT&amp;gt;"&lt;/span&gt;
set_var EASYRSA_KEY_SIZE        2048
set_var EASYRSA_CA_EXPIRE       3650
set_var EASYRSA_CERT_EXPIRE     3650
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Generate server keys:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;./easyrsa init-pki
./easyrsa build-ca
./easyrsa build-server-full openvpn-server nopass
./easyrsa gen-dh
openvpn &lt;span class="nt"&gt;--genkey&lt;/span&gt; &lt;span class="nt"&gt;--secret&lt;/span&gt; ta.key
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Generate client keys:&lt;/h3&gt;

&lt;p&gt;Set CLIENT_NAME to any name you&amp;rsquo;d like to associate your OpenVPN client with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;export &lt;/span&gt;&lt;span class="nv"&gt;CLIENT_NAME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"&amp;lt;client-name&amp;gt;"&lt;/span&gt;
./easyrsa build-client-full &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt; nopass
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Copy server keys:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;cp &lt;/span&gt;pki/dh.pem &lt;span class="se"&gt;\&lt;/span&gt;
   pki/ca.crt &lt;span class="se"&gt;\&lt;/span&gt;
   pki/issued/openvpn-server.crt &lt;span class="se"&gt;\&lt;/span&gt;
   pki/private/openvpn-server.key &lt;span class="se"&gt;\&lt;/span&gt;
   ta.key &lt;span class="se"&gt;\&lt;/span&gt;
   /etc/openvpn/keys
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Configure client:&lt;/h3&gt;

&lt;p&gt;Change &lt;code&gt;&amp;lt;server-ip&amp;gt;&lt;/code&gt; in the middle of the ovpn file to your server IP address.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /etc/openvpn
&lt;span class="nb"&gt;touch&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
client
nobind
dev tun
remote-cert-tls server

remote &amp;lt;server-ip&amp;gt; 1194 udp

key-direction 1

redirect-gateway def1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Type &lt;code&gt;Ctrl-D&lt;/code&gt; here and then type the rest:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;key&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat&lt;/span&gt; ~/EasyRSA-3.0.4/pki/private/&lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.key &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/key&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;cert&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;sed&lt;/span&gt; &lt;span class="nt"&gt;-n&lt;/span&gt; &lt;span class="s1"&gt;'/^-----BEGIN/,/^-----END/p'&lt;/span&gt; ~/EasyRSA-3.0.4/pki/issued/&lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.crt &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/cert&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;ca&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat&lt;/span&gt; ~/EasyRSA-3.0.4/pki/ca.crt &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/ca&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;tls-auth&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat&lt;/span&gt; ~/EasyRSA-3.0.4/ta.key &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/tls-auth&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Configure server:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;touch &lt;/span&gt;server.conf
&lt;span class="nb"&gt;cat&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; server.conf
server 192.168.255.0 255.255.255.0

verb 3

key /etc/openvpn/keys/openvpn-server.key  &lt;span class="c"&gt;# This file should be kept secret&lt;/span&gt;
ca /etc/openvpn/keys/ca.crt
cert /etc/openvpn/keys/openvpn-server.crt
dh /etc/openvpn/keys/dh.pem
tls-auth /etc/openvpn/keys/ta.key 0 &lt;span class="c"&gt;# This file is secret&lt;/span&gt;

key-direction 0
keepalive 10 60

persist-key
persist-tun

proto udp
port 1194
dev tun

status openvpn-status.log

user nobody
group nogroup

explicit-exit-notify 1
remote-cert-tls client

route 192.168.254.0 255.255.255.0

push &lt;span class="s2"&gt;"dhcp-option DNS 8.8.8.8"&lt;/span&gt;
push &lt;span class="s2"&gt;"dhcp-option DNS 8.8.4.4"&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Type &lt;code&gt;Ctrl-D&lt;/code&gt; here.&lt;/p&gt;

&lt;p&gt;That&amp;rsquo;s basically it, we only need to allow traffic to be NATed through the
server. Set &lt;code&gt;net.ipv4.ip_forward=1&lt;/code&gt; in this file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;vim /etc/sysctl.conf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Find your default interface:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;ip route | &lt;span class="nb"&gt;grep &lt;/span&gt;default
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Output should be like: default via x.x.x.x dev &lt;code&gt;ens3&lt;/code&gt; proto dhcp src x.x.x.x
metric 100. Rememeber your interface name and put it to iptable rules below:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;iptables &lt;span class="nt"&gt;-t&lt;/span&gt; nat &lt;span class="nt"&gt;-A&lt;/span&gt; POSTROUTING &lt;span class="nt"&gt;-o&lt;/span&gt; ens3 &lt;span class="nt"&gt;-j&lt;/span&gt; MASQUERADE
iptables &lt;span class="nt"&gt;-A&lt;/span&gt; FORWARD &lt;span class="nt"&gt;-j&lt;/span&gt; ACCEPT
apt-get &lt;span class="nb"&gt;install &lt;/span&gt;iptables-persistent
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;When you install iptables-persistent it will ask you to save current rules into
file, just agree with that and then start the service:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;systemctl start openvpn@server
&lt;span class="nb"&gt;sudo &lt;/span&gt;systemctl &lt;span class="nb"&gt;enable &lt;/span&gt;openvpn@server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now you can download &lt;code&gt;$CLIENT_NAME.ovpn&lt;/code&gt; to your machine and start browsing
internet securely:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;scp root@&amp;lt;server-ip&amp;gt;:/etc/openvpn/&amp;lt;client-name&amp;gt;.ovpn ./
&lt;span class="nb"&gt;sudo &lt;/span&gt;openvpn &amp;lt;client-name&amp;gt;.ovpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content>
  </entry>
  <entry>
    <title>OpenVPN on FreeBSD 11.1</title>
    <link rel="alternate" href="/2018/05/21/freebsd-openvpn.html"/>
    <id>/2018/05/21/freebsd-openvpn.html</id>
    <published>2018-05-21T00:00:00+03:00</published>
    <updated>2018-05-21T00:00:00+03:00</updated>
    <author>
      <name>Dmitry Vorotilin</name>
    </author>
    <summary type="html">&lt;h3&gt;Install and copy configs:&lt;/h3&gt;

&lt;p&gt;Let’s first change shell to sh as FreeBSD comes with csh by default:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;root@vpn:~ &lt;span class="c"&gt;# sh&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;pkg update &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; pkg &lt;span class="nb"&gt;install &lt;/span&gt;openvpn
&lt;span class="nb"&gt;mkdir&lt;/span&gt; /usr/local/etc/openvpn
&lt;span class="nb"&gt;cp&lt;/span&gt; /usr/local/share/examples/openvpn/sample-config-files/server.conf &lt;span class="se"&gt;\&lt;/span&gt;
 ...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</summary>
    <content type="html">&lt;h3&gt;Install and copy configs:&lt;/h3&gt;

&lt;p&gt;Let&amp;rsquo;s first change shell to sh as FreeBSD comes with csh by default:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;root@vpn:~ &lt;span class="c"&gt;# sh&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;pkg update &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; pkg &lt;span class="nb"&gt;install &lt;/span&gt;openvpn
&lt;span class="nb"&gt;mkdir&lt;/span&gt; /usr/local/etc/openvpn
&lt;span class="nb"&gt;cp&lt;/span&gt; /usr/local/share/examples/openvpn/sample-config-files/server.conf &lt;span class="se"&gt;\&lt;/span&gt;
   /usr/local/etc/openvpn/openvpn.conf
&lt;span class="nb"&gt;cp&lt;/span&gt; &lt;span class="nt"&gt;-r&lt;/span&gt; /usr/local/share/easy-rsa /usr/local/etc/openvpn/easy-rsa
&lt;span class="nb"&gt;cd&lt;/span&gt; /usr/local/etc/openvpn/easy-rsa
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Set these variables in the file and save:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="c"&gt;# vim vars&lt;/span&gt;
set_var EASYRSA_REQ_COUNTRY     &lt;span class="s2"&gt;"&amp;lt;COUNTRY&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_PROVINCE    &lt;span class="s2"&gt;"&amp;lt;PROVINCE&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_CITY        &lt;span class="s2"&gt;"&amp;lt;CITY&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_ORG         &lt;span class="s2"&gt;"&amp;lt;ORGANIZATION&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_EMAIL       &lt;span class="s2"&gt;"&amp;lt;EMAIL&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_OU          &lt;span class="s2"&gt;"&amp;lt;ORGANIZATIONAL UNIT&amp;gt;"&lt;/span&gt;
set_var EASYRSA_KEY_SIZE        2048
set_var EASYRSA_CA_EXPIRE       3650
set_var EASYRSA_CERT_EXPIRE     3650
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Generate server keys:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;./easyrsa.real init-pki
./easyrsa.real build-ca
./easyrsa.real build-server-full openvpn-server nopass
./easyrsa.real gen-dh
openvpn &lt;span class="nt"&gt;--genkey&lt;/span&gt; &lt;span class="nt"&gt;--secret&lt;/span&gt; ta.key
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Generate client keys:&lt;/h3&gt;

&lt;p&gt;Set CLIENT_NAME to any name you&amp;rsquo;d like to associate your OpenVPN client with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nv"&gt;CLIENT_NAME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"&amp;lt;client-name&amp;gt;"&lt;/span&gt;
./easyrsa.real build-client-full &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt; nopass
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Copy server keys:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;mkdir&lt;/span&gt; /usr/local/etc/openvpn/keys
&lt;span class="nb"&gt;cp &lt;/span&gt;pki/dh.pem &lt;span class="se"&gt;\&lt;/span&gt;
   pki/ca.crt &lt;span class="se"&gt;\&lt;/span&gt;
   pki/issued/openvpn-server.crt &lt;span class="se"&gt;\&lt;/span&gt;
   pki/private/openvpn-server.key &lt;span class="se"&gt;\&lt;/span&gt;
   ta.key &lt;span class="se"&gt;\&lt;/span&gt;
   /usr/local/etc/openvpn/keys
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Configure client:&lt;/h3&gt;

&lt;p&gt;Change &lt;code&gt;&amp;lt;server-ip&amp;gt;&lt;/code&gt; in the middle of the ovpn file to your server IP/Domain.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /usr/local/etc/openvpn
&lt;span class="nb"&gt;touch&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
client
nobind
dev tun
remote-cert-tls server

remote &amp;lt;server-ip&amp;gt; 1194 udp

key-direction 1

redirect-gateway def1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Type &lt;code&gt;Ctrl-D&lt;/code&gt; here and then type the rest:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;key&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat &lt;/span&gt;easy-rsa/pki/private/&lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.key &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/key&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;cert&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;sed&lt;/span&gt; &lt;span class="nt"&gt;-n&lt;/span&gt; &lt;span class="s1"&gt;'/^-----BEGIN/,/^-----END/p'&lt;/span&gt; easy-rsa/pki/issued/&lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.crt &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/cert&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;ca&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat &lt;/span&gt;easy-rsa/pki/ca.crt &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/ca&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;tls-auth&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat &lt;/span&gt;easy-rsa/ta.key &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/tls-auth&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Configure server:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;touch &lt;/span&gt;openvpn.conf
&lt;span class="nb"&gt;cat&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; openvpn.conf
server 192.168.255.0 255.255.255.0

verb 3

key /usr/local/etc/openvpn/keys/openvpn-server.key  &lt;span class="c"&gt;# This file should be kept secret&lt;/span&gt;
ca /usr/local/etc/openvpn/keys/ca.crt
cert /usr/local/etc/openvpn/keys/openvpn-server.crt
dh /usr/local/etc/openvpn/keys/dh.pem
tls-auth /usr/local/etc/openvpn/keys/ta.key 0 &lt;span class="c"&gt;# This file is secret&lt;/span&gt;

key-direction 0
keepalive 10 60

persist-key
persist-tun

proto udp
port 1194
dev tun

status openvpn-status.log

user nobody
group nobody

explicit-exit-notify 1
remote-cert-tls client

route 192.168.254.0 255.255.255.0

push &lt;span class="s2"&gt;"dhcp-option DNS 8.8.8.8"&lt;/span&gt;
push &lt;span class="s2"&gt;"dhcp-option DNS 8.8.4.4"&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Type &lt;code&gt;Ctrl-D&lt;/code&gt; here and again type the rest:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;sysrc &lt;span class="nv"&gt;openvpn_enable&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"YES"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;openvpn_if&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"tun"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;gateway_enable&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"YES"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;firewall_enable&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"YES"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;firewall_type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"OPEN"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;natd_enable&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"YES"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;natd_interface&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"vtnet0"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;natd_flags&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;""&lt;/span&gt;
service openvpn start
reboot
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After your server reboots you can download &lt;code&gt;$CLIENT_NAME.ovpn&lt;/code&gt; to your machine
and start browsing internet securely:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;scp root@&amp;lt;server-ip&amp;gt;:/usr/local/etc/openvpn/&amp;lt;client-name&amp;gt;.ovpn ./
&lt;span class="nb"&gt;sudo &lt;/span&gt;openvpn &amp;lt;client-name&amp;gt;.ovpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content>
  </entry>
</feed>
