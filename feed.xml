<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>NOPe Code</title>
  <id>http://route.github.io/</id>
  <link href="http://route.github.io/"/>
  <link href="http://route.github.io/feed.xml" rel="self"/>
  <updated>2021-03-02T00:00:00+03:00</updated>
  <author>
    <name>Dmitry Vorotilin</name>
  </author>
  <entry>
    <title>Hi! It's me, your flaky system test again</title>
    <link rel="alternate" href="/2021/03/02/your-flaky-ruby-tests.html"/>
    <id>/2021/03/02/your-flaky-ruby-tests.html</id>
    <published>2021-03-02T00:00:00+03:00</published>
    <updated>2021-03-02T00:00:00+03:00</updated>
    <author>
      <name>Dmitry Vorotilin</name>
    </author>
    <summary type="html">&lt;p&gt;There are many articles on how to &lt;a href="https://thoughtbot.com/blog/write-reliable-asynchronous-integration-tests-with-capybara"&gt;write reliable capybara tests&lt;/a&gt;.
There are less articles on how to deal with your &lt;a href="https://www.mayerdan.com/ruby/2019/09/07/flaky-ruby-tests"&gt;flaky tests&lt;/a&gt;.
There are none Iâ€™ve found on how to properly debug and really fight flaky tests back, this one is about it. I want you to...&lt;/p&gt;</summary>
    <content type="html">&lt;p&gt;There are many articles on how to &lt;a href="https://thoughtbot.com/blog/write-reliable-asynchronous-integration-tests-with-capybara"&gt;write reliable capybara tests&lt;/a&gt;.
There are less articles on how to deal with your &lt;a href="https://www.mayerdan.com/ruby/2019/09/07/flaky-ruby-tests"&gt;flaky tests&lt;/a&gt;.
There are none I&amp;rsquo;ve found on how to properly debug and really fight flaky tests back, this one is about it. I want you to
get comfortable with the tools I use and get along with me while we debug one of the failing specs so thus I provide a
single runnable file but for your rails application the setup is obvious: &lt;a href="https://evilmartians.com/chronicles/system-of-a-test-setting-up-end-to-end-rails-testing"&gt;System of a test: Proper browser testing in Ruby on Rails&lt;/a&gt;&lt;/p&gt;

&lt;h3&gt;What we have?&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight ruby"&gt;&lt;code&gt;&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s2"&gt;"bundler/inline"&lt;/span&gt;

&lt;span class="n"&gt;gemfile&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;
  &lt;span class="n"&gt;source&lt;/span&gt; &lt;span class="s2"&gt;"https://rubygems.org"&lt;/span&gt;

  &lt;span class="n"&gt;gem&lt;/span&gt; &lt;span class="s2"&gt;"puma"&lt;/span&gt;
  &lt;span class="n"&gt;gem&lt;/span&gt; &lt;span class="s2"&gt;"rspec"&lt;/span&gt;
  &lt;span class="n"&gt;gem&lt;/span&gt; &lt;span class="s2"&gt;"capybara"&lt;/span&gt;
  &lt;span class="n"&gt;gem&lt;/span&gt; &lt;span class="s2"&gt;"cuprite"&lt;/span&gt;
  &lt;span class="n"&gt;gem&lt;/span&gt; &lt;span class="s2"&gt;"ferrum"&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;

&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s2"&gt;"rspec/autorun"&lt;/span&gt;
&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s2"&gt;"capybara/rspec"&lt;/span&gt;
&lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s2"&gt;"capybara/cuprite"&lt;/span&gt;

&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;app&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;proc&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{},&lt;/span&gt; &lt;span class="no"&gt;File&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;open&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"index.html"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"r"&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;default_driver&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="ss"&gt;:cuprite&lt;/span&gt;
&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;register_driver&lt;/span&gt; &lt;span class="ss"&gt;:cuprite&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
  &lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Cuprite&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Driver&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;

&lt;span class="n"&gt;describe&lt;/span&gt; &lt;span class="s2"&gt;"flaky spec"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;type: :feature&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;
  &lt;span class="n"&gt;let&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:email&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="s2"&gt;"email@example.com"&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
  &lt;span class="n"&gt;let&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:first_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="s2"&gt;"Firstname"&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
  &lt;span class="n"&gt;let&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ss"&gt;:last_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="s2"&gt;"Lastname"&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;

  &lt;span class="n"&gt;it&lt;/span&gt; &lt;span class="s2"&gt;"submits form successfully"&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt;
    &lt;span class="n"&gt;visit&lt;/span&gt; &lt;span class="s2"&gt;"/"&lt;/span&gt;

    &lt;span class="n"&gt;fill_in&lt;/span&gt; &lt;span class="s2"&gt;"email"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;with: &lt;/span&gt;&lt;span class="n"&gt;email&lt;/span&gt;
    &lt;span class="n"&gt;click_button&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Next"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;fill_in&lt;/span&gt; &lt;span class="s2"&gt;"first-name"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;with: &lt;/span&gt;&lt;span class="n"&gt;first_name&lt;/span&gt;
    &lt;span class="n"&gt;fill_in&lt;/span&gt; &lt;span class="s2"&gt;"last-name"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;with: &lt;/span&gt;&lt;span class="n"&gt;last_name&lt;/span&gt;
    &lt;span class="n"&gt;click_button&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Finish"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;expect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;page&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nf"&gt;to&lt;/span&gt; &lt;span class="n"&gt;have_text&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Successfully sent"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="k"&gt;end&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and our simplified html markup:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight html"&gt;&lt;code&gt;&lt;span class="cp"&gt;&amp;lt;!doctype html&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;html&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;head&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;style&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;body&lt;/span&gt; &lt;span class="nt"&gt;form&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nl"&gt;display&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;block&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="nl"&gt;margin&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="m"&gt;10px&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
      &lt;span class="nf"&gt;#hint&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt; &lt;span class="nc"&gt;.step&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nl"&gt;display&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;none&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
      &lt;span class="nc"&gt;.active&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="nl"&gt;display&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;block&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="p"&gt;}&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;/style&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;/head&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;body&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;form&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;div&lt;/span&gt; &lt;span class="na"&gt;class=&lt;/span&gt;&lt;span class="s"&gt;"step active"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;input&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"email"&lt;/span&gt; &lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;div&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"hint"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;Please add here your email&lt;span class="nt"&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;button&lt;/span&gt; &lt;span class="na"&gt;class=&lt;/span&gt;&lt;span class="s"&gt;"btn"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;Next&lt;span class="nt"&gt;&amp;lt;/button&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;div&lt;/span&gt; &lt;span class="na"&gt;class=&lt;/span&gt;&lt;span class="s"&gt;"step"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;input&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"first-name"&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;"text"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;input&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;"last-name"&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;"text"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;button&lt;/span&gt; &lt;span class="na"&gt;class=&lt;/span&gt;&lt;span class="s"&gt;"btn"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;Finish&lt;span class="nt"&gt;&amp;lt;/button&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;div&lt;/span&gt; &lt;span class="na"&gt;class=&lt;/span&gt;&lt;span class="s"&gt;"step"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;p&amp;gt;&lt;/span&gt;Successfully sent&lt;span class="nt"&gt;&amp;lt;/p&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;/form&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;script &lt;/span&gt;&lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;"text/javascript"&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
      &lt;span class="nx"&gt;setTimeout&lt;/span&gt;&lt;span class="p"&gt;(()&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nb"&gt;document&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;getElementById&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="s2"&gt;hint&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="p"&gt;).&lt;/span&gt;&lt;span class="nx"&gt;style&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;display&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="s2"&gt;block&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
      &lt;span class="p"&gt;},&lt;/span&gt; &lt;span class="mi"&gt;55&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

      &lt;span class="nb"&gt;document&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;addEventListener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="s2"&gt;click&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;event&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&amp;gt;&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="nx"&gt;event&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;preventDefault&lt;/span&gt;&lt;span class="p"&gt;();&lt;/span&gt;

        &lt;span class="nx"&gt;parent&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nx"&gt;event&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;target&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;parentElement&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
        &lt;span class="nx"&gt;parent&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;classList&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="s2"&gt;active&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
        &lt;span class="nx"&gt;parent&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;nextElementSibling&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;classList&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;add&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="s2"&gt;active&lt;/span&gt;&lt;span class="dl"&gt;"&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
      &lt;span class="p"&gt;});&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Save it as &lt;code&gt;flaky_spec.rb&lt;/code&gt; and &lt;code&gt;index.html&lt;/code&gt; respectively. Run with &lt;code&gt;ruby flaky_spec.rb&lt;/code&gt;. In our test we have a multi-step
form, where you fill in an email, click &amp;ldquo;Next&amp;rdquo; and then finish the form with first and last name. A bit of vanilla JS is
to hide second step fields and activate when we need them. We also show some kind of a hint under the first input with a
bit of delay. The test works just fine, why wouldn&amp;rsquo;t it? We use waiting matchers, no AJAX, no styles, single page and
just a handful of JS and yet very very rare it fails:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;Failures:

  1&lt;span class="o"&gt;)&lt;/span&gt; flaky spec submits form successfully
     Failure/Error: fill_in &lt;span class="s2"&gt;"first-name"&lt;/span&gt;, with: first_name

     Capybara::ElementNotFound:
       Unable to find visible field &lt;span class="s2"&gt;"first-name"&lt;/span&gt; that is not disabled
     &lt;span class="c"&gt;# flaky_spec:34:in `block (2 levels) in &amp;lt;main&amp;gt;'&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The error shows that after we fill an email and click &amp;ldquo;Next&amp;rdquo; capybara cannot find any visible input for &lt;code&gt;first-name&lt;/code&gt;.
So obviously the issue happens after we click on the &amp;ldquo;Next&amp;rdquo; button. You might guess that &lt;code&gt;fill_in&lt;/code&gt; cannot find input
because it doesn&amp;rsquo;t have waiting capabilities but it does. Why in the hell test fails? After a couple of hours playing
around with such kind of a test developers usually give up and start using &lt;code&gt;rspec-retry&lt;/code&gt;, but we are going to hunt it
down.&lt;/p&gt;

&lt;h3&gt;What do we do?&lt;/h3&gt;

&lt;h4&gt;Headful mode + slowmo option&lt;/h4&gt;

&lt;p&gt;To start debugging system tests means that we need to see what&amp;rsquo;s going on in the browser. First of all we can run test
in a headful mode and see it with our own eyes:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight ruby"&gt;&lt;code&gt;&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;default_driver&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="ss"&gt;:cuprite&lt;/span&gt;
&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;register_driver&lt;/span&gt; &lt;span class="ss"&gt;:cuprite&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
  &lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Cuprite&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Driver&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="ss"&gt;headless:  &lt;/span&gt;&lt;span class="no"&gt;ENV&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"HEADLESS"&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="s2"&gt;"false"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="ss"&gt;slowmo: &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="no"&gt;ENV&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"SLOWMO"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mf"&gt;0.2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="no"&gt;ENV&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"HEADLESS"&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;"false"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
  &lt;span class="p"&gt;})&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Run with &lt;code&gt;HEADLESS=false ruby flaky_spec.rb&lt;/code&gt; and see it passing. We also add &lt;code&gt;:slowmo&lt;/code&gt; option with delay set to &lt;code&gt;0.2&lt;/code&gt;
without it everything happens way fast and we can barely see what&amp;rsquo;s going on. Experiment with &lt;code&gt;:slowmo&lt;/code&gt; option making
the test not too slow and not too fast. Unfortunately this doesn&amp;rsquo;t help us to spot an issue, because test is always
passing but it&amp;rsquo;s a good technique for starters.&lt;/p&gt;

&lt;h4&gt;Inspector&lt;/h4&gt;

&lt;p&gt;Another useful trick we can try is to put &lt;code&gt;page.driver.debug&lt;/code&gt; statement to the test to make it pause and open the
browser for us to debug, first let&amp;rsquo;s add inspector option to the driver:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight ruby"&gt;&lt;code&gt;&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;default_driver&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="ss"&gt;:cuprite&lt;/span&gt;
&lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;register_driver&lt;/span&gt; &lt;span class="ss"&gt;:cuprite&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;
  &lt;span class="no"&gt;Capybara&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Cuprite&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="no"&gt;Driver&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;new&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;app&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="ss"&gt;inspector: &lt;/span&gt;&lt;span class="no"&gt;ENV&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s2"&gt;"INSPECTOR"&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s2"&gt;"true"&lt;/span&gt;
  &lt;span class="p"&gt;})&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;then:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight ruby"&gt;&lt;code&gt;&lt;span class="n"&gt;fill_in&lt;/span&gt; &lt;span class="s2"&gt;"email"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ss"&gt;with: &lt;/span&gt;&lt;span class="n"&gt;email&lt;/span&gt;
&lt;span class="n"&gt;click_button&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Next"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;page&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;driver&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nf"&gt;debug&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and run it with &lt;code&gt;INSPECTOR=true ruby flaky_spec.rb&lt;/code&gt;. We will see in the console that test is paused:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;Cuprite execution paused. Press enter &lt;span class="o"&gt;(&lt;/span&gt;or run &lt;span class="s1"&gt;'kill -CONT 1098635'&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; to &lt;span class="k"&gt;continue&lt;/span&gt;&lt;span class="nb"&gt;.&lt;/span&gt;
Opening &lt;span class="k"&gt;in &lt;/span&gt;existing browser session.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and Chrome window is ready and showing us inspectable pages:&lt;/p&gt;

&lt;p&gt;&lt;img src="/images/inspectable_pages.png" class="img-fluid" alt="inspectable pages"&gt;
&lt;img src="/images/inspectable_content.png" class="img-fluid" alt="inspectable content"&gt;&lt;/p&gt;

&lt;p&gt;You can also call &lt;code&gt;page.driver.debug(binding)&lt;/code&gt; and besides opening the browser Cuprite starts pry or irb console where
you can execute some statements in the test&amp;rsquo;s context. If you are lucky enough, this debugging technique can show you
that capybara cannot find &lt;code&gt;first-name&lt;/code&gt; input because page is still showing the first step and for some reason hasn&amp;rsquo;t
switch to the second. We came a little closer to the clue, but it&amp;rsquo;s not enough.&lt;/p&gt;

&lt;h4&gt;Logger option&lt;/h4&gt;

&lt;p&gt;Using logger we can see all the messages our Ruby process exchanges with Chrome. Cuprite uses CDP protocol to control
Chrome. When your test starts running Cuprite spawns Chrome which listens to the messages through a websocket. Turning
logger on just shows in the console all the messages both processes exchange. Run &lt;code&gt;CUPRITE_DEBUG=true ruby flaky_spec.rb&lt;/code&gt;
and you&amp;rsquo;ll see a lot of output in your console. Now it&amp;rsquo;s time to makes some sense out of it. The command we send to
Chrome starts with â–¶ and shows the direction of the message:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;â–¶ 0.32 &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"method"&lt;/span&gt;:&lt;span class="s2"&gt;"Page.navigate"&lt;/span&gt;,&lt;span class="s2"&gt;"params"&lt;/span&gt;:&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"url"&lt;/span&gt;:&lt;span class="s2"&gt;"http://127.0.0.1:46551/listings"&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,&lt;span class="s2"&gt;"id"&lt;/span&gt;:1014&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;the answer we get back:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;â—€ 1.30 &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"id"&lt;/span&gt;:1014,&lt;span class="s2"&gt;"result"&lt;/span&gt;:&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"frameId"&lt;/span&gt;:&lt;span class="s2"&gt;"3EBE..."&lt;/span&gt;,&lt;span class="s2"&gt;"loaderId"&lt;/span&gt;:&lt;span class="s2"&gt;"A97..."&lt;/span&gt;&lt;span class="o"&gt;}}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Digits you see after the direction sign is elapsed time and the message is just a simple JSON. Note matching ids, you
provide a unique numeric id with the message and Chrome has the same id for the response. You pass the command you&amp;rsquo;d like
Chrome to invoke in &lt;code&gt;method&lt;/code&gt; with params in &lt;code&gt;params&lt;/code&gt;. The whole list of commands for CDP protocol is &lt;a href="https://chromedevtools.github.io/devtools-protocol/"&gt;here&lt;/a&gt;.
Let&amp;rsquo;s work on the terminology. First of all I would be ashamed to steal pictures and actually I&amp;rsquo;m ashamed, but this one
is exactly how it is in Puppeteer except that I replaced this wording with Cuprite.&lt;/p&gt;

&lt;p&gt;&lt;img src="/images/cuprite_schema.png" class="img-fluid" alt="cuprite schema"&gt;&lt;/p&gt;

&lt;p&gt;If you want to create a new page and make it go to example.com you first have to create new browser context:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Target.createBrowserContext"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"result"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"browserContextId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"9A688D2E33EB21D8FE5144A1481C2BF8"&lt;/span&gt;&lt;span class="p"&gt;}}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Context has an id and resembles an incognito session, you can create many pages in the same context and than just
dispose it with all the pages at once in the end. Create a page in the context:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Target.createTarget"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"browserContextId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"9A688D2E33EB21D8FE5144A1481C2BF8"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"url"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"about:blank"&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"result"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"targetId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"F135A71EEF7D8A39547AB4C5BB3C9942"&lt;/span&gt;&lt;span class="p"&gt;}}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Yes page is called a target in CDP terminology. Note that we pass &lt;code&gt;browserContextId&lt;/code&gt; and a url. Chrome sends us back
&lt;code&gt;targetId&lt;/code&gt;. Now page is created and it&amp;rsquo;s time to subscribe to interesting events we&amp;rsquo;d like to be notified of. It can be DOM or CSS,
there are many of them. I think I should mention &lt;code&gt;Runtime&lt;/code&gt; as it&amp;rsquo;s important:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Runtime.enable"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1002&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Runtime.executionContextCreated"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"context"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"origin"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"://"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"name"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;""&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"auxData"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"isDefault"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="kc"&gt;true&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"type"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"default"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"frameId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"F135A71EEF7D8A39547AB4C5BB3C9942"&lt;/span&gt;&lt;span class="p"&gt;}}}}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1002&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"result"&lt;/span&gt;&lt;span class="p"&gt;:{}}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It&amp;rsquo;s another context, but this time it&amp;rsquo;s related to JS world, this is the context where all the JS is executed for this
page. Each page has a main frame and each frame has it&amp;rsquo;s own execution context. Now we can tell the page to navigate
to the given url:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Page.navigate"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"url"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"http://127.0.0.1:36555/"&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1014&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As we are executing test the url obviously shows us loopback interface where capybara is running our application with
puma. After this call there are some network events and messages regarding page state, and we move to the point where
capybara starts filling the email and in order to do that it has to find such node first:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Runtime.callFunctionOn"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"executionContextId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"functionDeclaration"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"function() { return _cuprite.find(arguments[0], arguments[1]) }"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"arguments"&lt;/span&gt;&lt;span class="p"&gt;:[{&lt;/span&gt;&lt;span class="nl"&gt;"value"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"xpath"&lt;/span&gt;&lt;span class="p"&gt;},{&lt;/span&gt;&lt;span class="nl"&gt;"value"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"./descendant::*[self::input | self::textarea][not(((((((./@type = 'submit') or (./@type = 'image')) or (./@type = 'radio')) or (./@type = 'checkbox')) or (./@type = 'hidden')) or (./@type = 'file')))][((((./@id = 'email') or (./@name = 'email')) or (./@placeholder = 'email')) or (./@id = //label[(normalize-space(string(.)) = 'email')]/@for))] | .//label[(normalize-space(string(.)) = 'email')]//./descendant::*[self::input | self::textarea][not(((((((./@type = 'submit') or (./@type = 'image')) or (./@type = 'radio')) or (./@type = 'checkbox')) or (./@type = 'hidden')) or (./@type = 'file')))]"&lt;/span&gt;&lt;span class="p"&gt;}]},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1014&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finding a node means executing a JS function in the execution context for the main frame, capybara passes a long
argument - xpath for email input. In return we get &lt;code&gt;Runtime.RemoteObjectId&lt;/code&gt; which can be converted to the &lt;code&gt;nodeId&lt;/code&gt; which
can be used to work with such node, in our case we want to set input&amp;rsquo;s value:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Runtime.callFunctionOn"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"executionContextId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"functionDeclaration"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"function() { return _cuprite.set(arguments[0], arguments[1]) }"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"arguments"&lt;/span&gt;&lt;span class="p"&gt;:[{&lt;/span&gt;&lt;span class="nl"&gt;"objectId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"-8351792869791064162.2.7"&lt;/span&gt;&lt;span class="p"&gt;},{&lt;/span&gt;&lt;span class="nl"&gt;"value"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"email@example.com"&lt;/span&gt;&lt;span class="p"&gt;}]},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1026&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After that we have to find &amp;ldquo;Next&amp;rdquo; button and click it in order to activate next step, so capybara once again finds node
by xpath and this time we need to get coordinates of such node because we have to send click there, so we get content
quads, calculate the coordinates and fire the click:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"DOM.getContentQuads"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"nodeId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;16&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1038&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1038&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"result"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"quads"&lt;/span&gt;&lt;span class="p"&gt;:[[&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;41&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mf"&gt;51.40625&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;41&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mf"&gt;51.40625&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;62&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="mi"&gt;62&lt;/span&gt;&lt;span class="p"&gt;]]}}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Input.dispatchMouseEvent"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"type"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"mouseMoved"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"x"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;29&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"y"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;51&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1044&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Input.dispatchMouseEvent"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"x"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mf"&gt;29.703125&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"y"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;51&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"type"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"mousePressed"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"button"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"left"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"clickCount"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"modifiers"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1045&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"Input.dispatchMouseEvent"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"x"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mf"&gt;29.703125&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"y"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;51&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"type"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"mouseReleased"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"button"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"left"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"clickCount"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"modifiers"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;},&lt;/span&gt;&lt;span class="nl"&gt;"id"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;1046&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Notice that we first have to scroll this element into the view, then move mouse and only then click. After that we start
to look for the next xpath for &lt;code&gt;first-name&lt;/code&gt;. Depending on if test passed or not you will either see capybara found input
or tries to find it until give up. So what does it give us? We can clearly see that click happened and if you are an
eagle eye you may have noticed:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight json"&gt;&lt;code&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="nl"&gt;"method"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"DOM.attributeModified"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"params"&lt;/span&gt;&lt;span class="p"&gt;:{&lt;/span&gt;&lt;span class="nl"&gt;"nodeId"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;14&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"name"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"class"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nl"&gt;"value"&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="s2"&gt;"hint"&lt;/span&gt;&lt;span class="p"&gt;}}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;right between mouse pressed and released. So when we fire the click JS kicks in and our hint appears with &lt;code&gt;display: block&lt;/code&gt;
which moves our button down. It&amp;rsquo;s invented example, but instead of such JS it can be AJAX, styles invalidation, image
loading or many other things that are happeneing when page is still loading. Do you think about such things while writing
the test? Can you remember a real case when you misclicked on the link because some content appeared? It happens for me
quite often. So why your test can&amp;rsquo;t?&lt;/p&gt;

&lt;h3&gt;How to fix it?&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;The answer depends on your application usually. If it&amp;rsquo;s AJAX you have to replace content properly, if it&amp;rsquo;s styles try to
make height static if you can or it will make your end users nervous as well. Always think about asynchronous nature
of the webpage while writing your system tests.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;If you cannot solve issue directly, try to replace &lt;code&gt;click&lt;/code&gt; with &lt;code&gt;trigger(:click)&lt;/code&gt;. There is huge difference between
them as for the latter we don&amp;rsquo;t need coordinates, but there&amp;rsquo;s also downside as your element can be not clickable at all,
obscured by the others and you won&amp;rsquo;t catch it in the tests.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Cuprite also comes with lot&amp;rsquo;s of configurable settings. It actually has node movement protection, but it&amp;rsquo;s set to a
very bare minimum because we don&amp;rsquo;t want to slow down your tests: &lt;code&gt;FERRUM_NODE_MOVING_WAIT=0.01&lt;/code&gt; and &lt;code&gt;FERRUM_NODE_MOVING_ATTEMPTS=50&lt;/code&gt;.
We try to get coordinates of your node a few times with little delay and if it&amp;rsquo;s moving we do max number of attempts
until give up and raise &lt;code&gt;NodeIsMovingError&lt;/code&gt;. You can increase this env variable and check if it makes your build more
stable.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h3&gt;Bonus&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nv"&gt;BROWSER_PATH&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/path/to/chrome &lt;span class="c"&gt;# Path to Chrome binary&lt;/span&gt;
&lt;span class="nv"&gt;CUPRITE_DEBUG&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;true&lt;/span&gt; &lt;span class="c"&gt;# Turn on debug mode and show logs in the console same as FERRUM_DEBUG=true&lt;/span&gt;
FERRUM_DEFAULT_TIMEOUT &lt;span class="o"&gt;=&lt;/span&gt; 5 &lt;span class="c"&gt;# How long wait for an answer from Chrome&lt;/span&gt;
FERRUM_PROCESS_TIMEOUT &lt;span class="o"&gt;=&lt;/span&gt; 10 &lt;span class="c"&gt;# How long wait for Chrome process to start&lt;/span&gt;
FERRUM_NODE_MOVING_WAIT &lt;span class="o"&gt;=&lt;/span&gt; 0.01 &lt;span class="c"&gt;# For how long wait before trying to get coordinates again&lt;/span&gt;
FERRUM_NODE_MOVING_ATTEMPTS &lt;span class="o"&gt;=&lt;/span&gt; 50 &lt;span class="c"&gt;# How many attempts to do until give up since node is moving&lt;/span&gt;
FERRUM_CLICK_WAIT &lt;span class="o"&gt;=&lt;/span&gt; 0.1 &lt;span class="c"&gt;# How long wait for frame to start loading after click&lt;/span&gt;
&lt;span class="nv"&gt;CUPRITE_TRIGGER_CLICK_WAIT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;0.1 &lt;span class="c"&gt;# How long wait for frame to start loading after trigger&lt;/span&gt;
&lt;span class="nv"&gt;CUPRITE_MODAL_WAIT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;0.05  &lt;span class="c"&gt;# How long wait for modal dialog&lt;/span&gt;
&lt;span class="nv"&gt;FERRUM_NEW_WINDOW_WAIT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;0.3 &lt;span class="c"&gt;# How long wait for a new window&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content>
  </entry>
  <entry>
    <title>OpenVPN on Ubuntu 18.04</title>
    <link rel="alternate" href="/2018/09/24/ubuntu-openvpn.html"/>
    <id>/2018/09/24/ubuntu-openvpn.html</id>
    <published>2018-09-24T00:00:00+03:00</published>
    <updated>2018-09-24T00:00:00+03:00</updated>
    <author>
      <name>Dmitry Vorotilin</name>
    </author>
    <summary type="html">&lt;h3&gt;Install and copy configs:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;apt update
&lt;span class="nb"&gt;sudo &lt;/span&gt;apt &lt;span class="nb"&gt;install &lt;/span&gt;openvpn
wget &lt;span class="nt"&gt;-P&lt;/span&gt; ~/ https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.4/EasyRSA-3.0.4.tgz
&lt;span class="nb"&gt;tar &lt;/span&gt;zxvf EasyRSA-3.0.4.tgz
&lt;span class="nb"&gt;cd &lt;/span&gt;EasyRSA-3.0.4
&lt;span class="nb"&gt;cp &lt;/span&gt;vars.example vars
vim vars
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Set these variables...&lt;/p&gt;</summary>
    <content type="html">&lt;h3&gt;Install and copy configs:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;apt update
&lt;span class="nb"&gt;sudo &lt;/span&gt;apt &lt;span class="nb"&gt;install &lt;/span&gt;openvpn
wget &lt;span class="nt"&gt;-P&lt;/span&gt; ~/ https://github.com/OpenVPN/easy-rsa/releases/download/v3.0.4/EasyRSA-3.0.4.tgz
&lt;span class="nb"&gt;tar &lt;/span&gt;zxvf EasyRSA-3.0.4.tgz
&lt;span class="nb"&gt;cd &lt;/span&gt;EasyRSA-3.0.4
&lt;span class="nb"&gt;cp &lt;/span&gt;vars.example vars
vim vars
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Set these variables in the file and save:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;vim vars
set_var EASYRSA_REQ_COUNTRY     &lt;span class="s2"&gt;"&amp;lt;COUNTRY&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_PROVINCE    &lt;span class="s2"&gt;"&amp;lt;PROVINCE&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_CITY        &lt;span class="s2"&gt;"&amp;lt;CITY&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_ORG         &lt;span class="s2"&gt;"&amp;lt;ORGANIZATION&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_EMAIL       &lt;span class="s2"&gt;"&amp;lt;EMAIL&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_OU          &lt;span class="s2"&gt;"&amp;lt;ORGANIZATIONAL UNIT&amp;gt;"&lt;/span&gt;
set_var EASYRSA_KEY_SIZE        2048
set_var EASYRSA_CA_EXPIRE       3650
set_var EASYRSA_CERT_EXPIRE     3650
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Generate server keys:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;./easyrsa init-pki
./easyrsa build-ca
./easyrsa build-server-full openvpn-server nopass
./easyrsa gen-dh
openvpn &lt;span class="nt"&gt;--genkey&lt;/span&gt; &lt;span class="nt"&gt;--secret&lt;/span&gt; ta.key
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Generate client keys:&lt;/h3&gt;

&lt;p&gt;Set CLIENT_NAME to any name you&amp;rsquo;d like to associate your OpenVPN client with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;export &lt;/span&gt;&lt;span class="nv"&gt;CLIENT_NAME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"&amp;lt;client-name&amp;gt;"&lt;/span&gt;
./easyrsa build-client-full &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt; nopass
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Copy server keys:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;cp &lt;/span&gt;pki/dh.pem &lt;span class="se"&gt;\&lt;/span&gt;
   pki/ca.crt &lt;span class="se"&gt;\&lt;/span&gt;
   pki/issued/openvpn-server.crt &lt;span class="se"&gt;\&lt;/span&gt;
   pki/private/openvpn-server.key &lt;span class="se"&gt;\&lt;/span&gt;
   ta.key &lt;span class="se"&gt;\&lt;/span&gt;
   /etc/openvpn/keys
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Configure client:&lt;/h3&gt;

&lt;p&gt;Change &lt;code&gt;&amp;lt;server-ip&amp;gt;&lt;/code&gt; in the middle of the ovpn file to your server IP address.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /etc/openvpn
&lt;span class="nb"&gt;touch&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
client
nobind
dev tun
remote-cert-tls server

remote &amp;lt;server-ip&amp;gt; 1194 udp

key-direction 1

redirect-gateway def1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Type &lt;code&gt;Ctrl-D&lt;/code&gt; here and then type the rest:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;key&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat&lt;/span&gt; ~/EasyRSA-3.0.4/pki/private/&lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.key &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/key&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;cert&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;sed&lt;/span&gt; &lt;span class="nt"&gt;-n&lt;/span&gt; &lt;span class="s1"&gt;'/^-----BEGIN/,/^-----END/p'&lt;/span&gt; ~/EasyRSA-3.0.4/pki/issued/&lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.crt &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/cert&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;ca&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat&lt;/span&gt; ~/EasyRSA-3.0.4/pki/ca.crt &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/ca&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;tls-auth&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat&lt;/span&gt; ~/EasyRSA-3.0.4/ta.key &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/tls-auth&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Configure server:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;touch &lt;/span&gt;server.conf
&lt;span class="nb"&gt;cat&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; server.conf
server 192.168.255.0 255.255.255.0

verb 3

key /etc/openvpn/keys/openvpn-server.key  &lt;span class="c"&gt;# This file should be kept secret&lt;/span&gt;
ca /etc/openvpn/keys/ca.crt
cert /etc/openvpn/keys/openvpn-server.crt
dh /etc/openvpn/keys/dh.pem
tls-auth /etc/openvpn/keys/ta.key 0 &lt;span class="c"&gt;# This file is secret&lt;/span&gt;

key-direction 0
keepalive 10 60

persist-key
persist-tun

proto udp
port 1194
dev tun

status openvpn-status.log

user nobody
group nogroup

explicit-exit-notify 1
remote-cert-tls client

route 192.168.254.0 255.255.255.0

push &lt;span class="s2"&gt;"dhcp-option DNS 8.8.8.8"&lt;/span&gt;
push &lt;span class="s2"&gt;"dhcp-option DNS 8.8.4.4"&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Type &lt;code&gt;Ctrl-D&lt;/code&gt; here.&lt;/p&gt;

&lt;p&gt;That&amp;rsquo;s basically it, we only need to allow traffic to be NATed through the
server. Set &lt;code&gt;net.ipv4.ip_forward=1&lt;/code&gt; in this file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;vim /etc/sysctl.conf
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Find your default interface:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;ip route | &lt;span class="nb"&gt;grep &lt;/span&gt;default
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Output should be like: default via x.x.x.x dev &lt;code&gt;ens3&lt;/code&gt; proto dhcp src x.x.x.x
metric 100. Rememeber your interface name and put it to iptable rules below:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;iptables &lt;span class="nt"&gt;-t&lt;/span&gt; nat &lt;span class="nt"&gt;-A&lt;/span&gt; POSTROUTING &lt;span class="nt"&gt;-o&lt;/span&gt; ens3 &lt;span class="nt"&gt;-j&lt;/span&gt; MASQUERADE
iptables &lt;span class="nt"&gt;-A&lt;/span&gt; FORWARD &lt;span class="nt"&gt;-j&lt;/span&gt; ACCEPT
apt-get &lt;span class="nb"&gt;install &lt;/span&gt;iptables-persistent
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;When you install iptables-persistent it will ask you to save current rules into
file, just agree with that and then start the service:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;systemctl start openvpn@server
&lt;span class="nb"&gt;sudo &lt;/span&gt;systemctl &lt;span class="nb"&gt;enable &lt;/span&gt;openvpn@server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now you can download &lt;code&gt;$CLIENT_NAME.ovpn&lt;/code&gt; to your machine and start browsing
internet securely:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;scp root@&amp;lt;server-ip&amp;gt;:/etc/openvpn/&amp;lt;client-name&amp;gt;.ovpn ./
&lt;span class="nb"&gt;sudo &lt;/span&gt;openvpn &amp;lt;client-name&amp;gt;.ovpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content>
  </entry>
  <entry>
    <title>OpenVPN on FreeBSD 11.1</title>
    <link rel="alternate" href="/2018/05/21/freebsd-openvpn.html"/>
    <id>/2018/05/21/freebsd-openvpn.html</id>
    <published>2018-05-21T00:00:00+03:00</published>
    <updated>2018-05-21T00:00:00+03:00</updated>
    <author>
      <name>Dmitry Vorotilin</name>
    </author>
    <summary type="html">&lt;h3&gt;Install and copy configs:&lt;/h3&gt;

&lt;p&gt;Letâ€™s first change shell to sh as FreeBSD comes with csh by default:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;root@vpn:~ &lt;span class="c"&gt;# sh&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;pkg update &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; pkg &lt;span class="nb"&gt;install &lt;/span&gt;openvpn
&lt;span class="nb"&gt;mkdir&lt;/span&gt; /usr/local/etc/openvpn
&lt;span class="nb"&gt;cp&lt;/span&gt; /usr/local/share/examples/openvpn/sample-config-files/server.conf &lt;span class="se"&gt;\&lt;/span&gt;
 ...&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</summary>
    <content type="html">&lt;h3&gt;Install and copy configs:&lt;/h3&gt;

&lt;p&gt;Let&amp;rsquo;s first change shell to sh as FreeBSD comes with csh by default:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;root@vpn:~ &lt;span class="c"&gt;# sh&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;pkg update &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; pkg &lt;span class="nb"&gt;install &lt;/span&gt;openvpn
&lt;span class="nb"&gt;mkdir&lt;/span&gt; /usr/local/etc/openvpn
&lt;span class="nb"&gt;cp&lt;/span&gt; /usr/local/share/examples/openvpn/sample-config-files/server.conf &lt;span class="se"&gt;\&lt;/span&gt;
   /usr/local/etc/openvpn/openvpn.conf
&lt;span class="nb"&gt;cp&lt;/span&gt; &lt;span class="nt"&gt;-r&lt;/span&gt; /usr/local/share/easy-rsa /usr/local/etc/openvpn/easy-rsa
&lt;span class="nb"&gt;cd&lt;/span&gt; /usr/local/etc/openvpn/easy-rsa
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Set these variables in the file and save:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="c"&gt;# vim vars&lt;/span&gt;
set_var EASYRSA_REQ_COUNTRY     &lt;span class="s2"&gt;"&amp;lt;COUNTRY&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_PROVINCE    &lt;span class="s2"&gt;"&amp;lt;PROVINCE&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_CITY        &lt;span class="s2"&gt;"&amp;lt;CITY&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_ORG         &lt;span class="s2"&gt;"&amp;lt;ORGANIZATION&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_EMAIL       &lt;span class="s2"&gt;"&amp;lt;EMAIL&amp;gt;"&lt;/span&gt;
set_var EASYRSA_REQ_OU          &lt;span class="s2"&gt;"&amp;lt;ORGANIZATIONAL UNIT&amp;gt;"&lt;/span&gt;
set_var EASYRSA_KEY_SIZE        2048
set_var EASYRSA_CA_EXPIRE       3650
set_var EASYRSA_CERT_EXPIRE     3650
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Generate server keys:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;./easyrsa.real init-pki
./easyrsa.real build-ca
./easyrsa.real build-server-full openvpn-server nopass
./easyrsa.real gen-dh
openvpn &lt;span class="nt"&gt;--genkey&lt;/span&gt; &lt;span class="nt"&gt;--secret&lt;/span&gt; ta.key
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Generate client keys:&lt;/h3&gt;

&lt;p&gt;Set CLIENT_NAME to any name you&amp;rsquo;d like to associate your OpenVPN client with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nv"&gt;CLIENT_NAME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"&amp;lt;client-name&amp;gt;"&lt;/span&gt;
./easyrsa.real build-client-full &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt; nopass
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Copy server keys:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;mkdir&lt;/span&gt; /usr/local/etc/openvpn/keys
&lt;span class="nb"&gt;cp &lt;/span&gt;pki/dh.pem &lt;span class="se"&gt;\&lt;/span&gt;
   pki/ca.crt &lt;span class="se"&gt;\&lt;/span&gt;
   pki/issued/openvpn-server.crt &lt;span class="se"&gt;\&lt;/span&gt;
   pki/private/openvpn-server.key &lt;span class="se"&gt;\&lt;/span&gt;
   ta.key &lt;span class="se"&gt;\&lt;/span&gt;
   /usr/local/etc/openvpn/keys
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Configure client:&lt;/h3&gt;

&lt;p&gt;Change &lt;code&gt;&amp;lt;server-ip&amp;gt;&lt;/code&gt; in the middle of the ovpn file to your server IP/Domain.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;cd&lt;/span&gt; /usr/local/etc/openvpn
&lt;span class="nb"&gt;touch&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
client
nobind
dev tun
remote-cert-tls server

remote &amp;lt;server-ip&amp;gt; 1194 udp

key-direction 1

redirect-gateway def1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Type &lt;code&gt;Ctrl-D&lt;/code&gt; here and then type the rest:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;key&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat &lt;/span&gt;easy-rsa/pki/private/&lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.key &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/key&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;cert&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;sed&lt;/span&gt; &lt;span class="nt"&gt;-n&lt;/span&gt; &lt;span class="s1"&gt;'/^-----BEGIN/,/^-----END/p'&lt;/span&gt; easy-rsa/pki/issued/&lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.crt &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/cert&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;ca&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat &lt;/span&gt;easy-rsa/pki/ca.crt &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/ca&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;tls-auth&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;cat &lt;/span&gt;easy-rsa/ta.key &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;span class="nb"&gt;printf&lt;/span&gt; &lt;span class="s2"&gt;"&amp;lt;/tls-auth&amp;gt;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="nv"&gt;$CLIENT_NAME&lt;/span&gt;.ovpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;Configure server:&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nb"&gt;touch &lt;/span&gt;openvpn.conf
&lt;span class="nb"&gt;cat&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; openvpn.conf
server 192.168.255.0 255.255.255.0

verb 3

key /usr/local/etc/openvpn/keys/openvpn-server.key  &lt;span class="c"&gt;# This file should be kept secret&lt;/span&gt;
ca /usr/local/etc/openvpn/keys/ca.crt
cert /usr/local/etc/openvpn/keys/openvpn-server.crt
dh /usr/local/etc/openvpn/keys/dh.pem
tls-auth /usr/local/etc/openvpn/keys/ta.key 0 &lt;span class="c"&gt;# This file is secret&lt;/span&gt;

key-direction 0
keepalive 10 60

persist-key
persist-tun

proto udp
port 1194
dev tun

status openvpn-status.log

user nobody
group nobody

explicit-exit-notify 1
remote-cert-tls client

route 192.168.254.0 255.255.255.0

push &lt;span class="s2"&gt;"dhcp-option DNS 8.8.8.8"&lt;/span&gt;
push &lt;span class="s2"&gt;"dhcp-option DNS 8.8.4.4"&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Type &lt;code&gt;Ctrl-D&lt;/code&gt; here and again type the rest:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;sysrc &lt;span class="nv"&gt;openvpn_enable&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"YES"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;openvpn_if&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"tun"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;gateway_enable&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"YES"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;firewall_enable&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"YES"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;firewall_type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"OPEN"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;natd_enable&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"YES"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;natd_interface&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"vtnet0"&lt;/span&gt;
sysrc &lt;span class="nv"&gt;natd_flags&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;""&lt;/span&gt;
service openvpn start
reboot
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After your server reboots you can download &lt;code&gt;$CLIENT_NAME.ovpn&lt;/code&gt; to your machine
and start browsing internet securely:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;scp root@&amp;lt;server-ip&amp;gt;:/usr/local/etc/openvpn/&amp;lt;client-name&amp;gt;.ovpn ./
&lt;span class="nb"&gt;sudo &lt;/span&gt;openvpn &amp;lt;client-name&amp;gt;.ovpn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content>
  </entry>
  <entry>
    <title>Telegram drama</title>
    <link rel="alternate" href="/2018/04/24/telegram-drama.html"/>
    <id>/2018/04/24/telegram-drama.html</id>
    <published>2018-04-24T00:00:00+03:00</published>
    <updated>2018-04-24T00:00:00+03:00</updated>
    <author>
      <name>Dmitry Vorotilin</name>
    </author>
    <summary type="html">&lt;p&gt;In my childhood internet and network looked like a magick. In the movies they
showed something like ping output and I definitely thought that someone hacked
someone else.&lt;/p&gt;

&lt;p&gt;&lt;img src="/images/hackers.png" class="img-fluid" alt="hackers"&gt;&lt;/p&gt;

&lt;h3&gt;The beginning of story&lt;/h3&gt;

&lt;p&gt;Recently media regulator Roskomnadzor started to block...&lt;/p&gt;</summary>
    <content type="html">&lt;p&gt;In my childhood internet and network looked like a magick. In the movies they
showed something like ping output and I definitely thought that someone hacked
someone else.&lt;/p&gt;

&lt;p&gt;&lt;img src="/images/hackers.png" class="img-fluid" alt="hackers"&gt;&lt;/p&gt;

&lt;h3&gt;The beginning of story&lt;/h3&gt;

&lt;p&gt;Recently media regulator Roskomnadzor started to block Telegram IP addresses
because the latter denied giving goverment keys to decipher messages. It goes
without saying that it&amp;rsquo;s creepy but among other things Roskomnadzor blocked like
roughly 18m of IP addresses. It happened because Telegram used services publicly
provided by AWS and other big companies. Here I should say that&amp;rsquo;s exactly the
reason these companies exist lol they provide services. Roskomnadzor started to
block these IPs and Telegram started to use other IPs and so on. The post is not
about how secure Telegram is or why it doesn&amp;rsquo;t provide secure E2E encrypted
channels by default. In general it&amp;rsquo;s about freedom to talk to each other, browse
internet and live privately and by the way tools you can use to debug network.&lt;/p&gt;

&lt;h3&gt;The debugging&lt;/h3&gt;

&lt;p&gt;As usually this morning I tried to connect to one of our web services and it
timed out. ICMP traffic wasn&amp;rsquo;t blocked though. Let&amp;rsquo;s say a domain for this
server was &lt;code&gt;example.com&lt;/code&gt; with IP address &lt;code&gt;x.x.x.x&lt;/code&gt; and my PC had white IP
address &lt;code&gt;y.y.y.y&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;ping example.com
PING x.x.x.x: 64 data bytes
72 bytes from x.x.x.x: &lt;span class="nb"&gt;seq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;0 &lt;span class="nv"&gt;ttl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;52 &lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;141.242 ms
72 bytes from x.x.x.x: &lt;span class="nb"&gt;seq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;1 &lt;span class="nv"&gt;ttl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;52 &lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;140.809 ms

2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max &lt;span class="o"&gt;=&lt;/span&gt; 140.702/140.918/141.242 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Ping goes smoothly but providers can block resources using different techniques
starting from DNS spoofing and ending by DPI. If I want to open &lt;a href="http://rutracker.org"&gt;rutracker.org&lt;/a&gt;
for example my ISP redirects me to its own &lt;a href="http://warning.rt.ru/?id=9&amp;amp;st=0&amp;amp;dt=195.82.146.214&amp;amp;rs=http%3A%2F%2Frutracker.org%2Fforum%2Findex.php"&gt;page&lt;/a&gt;
showing that this address was in fact blocked by goverment. Though it&amp;rsquo;s not the
case for &lt;code&gt;x.x.x.x&lt;/code&gt; where HTTP traffic disappears silently. Opening
&lt;code&gt;chrome://net-internals&lt;/code&gt; sometimes is very intersting and confirms time out:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight plaintext"&gt;&lt;code&gt;14057: URL_REQUEST
https://example.com/
Start Time: 2018-04-24 08:07:06.009

t=144674 [st=    0] +REQUEST_ALIVE  [dt=24521]
                     --&amp;gt; priority = "HIGHEST"
                     --&amp;gt; url = "https://example.com/"
t=144674 [st=    0]    URL_REQUEST_DELEGATE  [dt=0]
t=144674 [st=    0]   +URL_REQUEST_START_JOB  [dt=24521]
                       --&amp;gt; load_flags = 4353 (MAIN_FRAME_DEPRECATED | VALIDATE_CACHE | VERIFY_EV_CERT)
                       --&amp;gt; method = "GET"
                       --&amp;gt; url = "https://example.com/"
t=144674 [st=    0]      URL_REQUEST_DELEGATE  [dt=0]
t=144674 [st=    0]      HTTP_CACHE_GET_BACKEND  [dt=0]
t=144674 [st=    0]      HTTP_CACHE_OPEN_ENTRY  [dt=0]
                         --&amp;gt; net_error = -2 (ERR_FAILED)
t=144674 [st=    0]      HTTP_CACHE_CREATE_ENTRY  [dt=0]
t=144674 [st=    0]      HTTP_CACHE_ADD_TO_ENTRY  [dt=1]
t=144675 [st=    1]     +HTTP_STREAM_REQUEST  [dt=24520]
t=144675 [st=    1]        HTTP_STREAM_JOB_CONTROLLER_BOUND
                           --&amp;gt; source_dependency = 14060 (HTTP_STREAM_JOB_CONTROLLER)
t=169195 [st=24521]        HTTP_STREAM_REQUEST_BOUND_TO_JOB
                           --&amp;gt; source_dependency = 14061 (HTTP_STREAM_JOB)
t=169195 [st=24521]     -HTTP_STREAM_REQUEST
t=169195 [st=24521]   -URL_REQUEST_START_JOB
                       --&amp;gt; net_error = -118 (ERR_CONNECTION_TIMED_OUT)
t=169195 [st=24521]    URL_REQUEST_DELEGATE  [dt=0]
t=169195 [st=24521] -REQUEST_ALIVE
                     --&amp;gt; net_error = -118 (ERR_CONNECTION_TIMED_OUT)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Traceroute from my machine to this IP shows a few intermidiate backbone providers:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;traceroute to example.com &lt;span class="o"&gt;(&lt;/span&gt;x.x.x.x&lt;span class="o"&gt;)&lt;/span&gt;, 30 hops max, 60 byte packets
 1  gateway &lt;span class="o"&gt;(&lt;/span&gt;192.168.0.1&lt;span class="o"&gt;)&lt;/span&gt;  0.417 ms  0.484 ms  0.568 ms
 2  100.103.0.1 &lt;span class="o"&gt;(&lt;/span&gt;100.103.0.1&lt;span class="o"&gt;)&lt;/span&gt;  4.935 ms  4.992 ms  5.020 ms
 3  213.59.232.208 &lt;span class="o"&gt;(&lt;/span&gt;213.59.232.208&lt;span class="o"&gt;)&lt;/span&gt;  38.910 ms 213.59.232.204 &lt;span class="o"&gt;(&lt;/span&gt;213.59.232.204&lt;span class="o"&gt;)&lt;/span&gt;  5.076 ms 213.59.232.208 &lt;span class="o"&gt;(&lt;/span&gt;213.59.232.208&lt;span class="o"&gt;)&lt;/span&gt;  5.339 ms
 4  87.226.146.65 &lt;span class="o"&gt;(&lt;/span&gt;87.226.146.65&lt;span class="o"&gt;)&lt;/span&gt;  6.112 ms 87.226.146.63 &lt;span class="o"&gt;(&lt;/span&gt;87.226.146.63&lt;span class="o"&gt;)&lt;/span&gt;  6.889 ms  6.970 ms
 5  87.226.146.58 &lt;span class="o"&gt;(&lt;/span&gt;87.226.146.58&lt;span class="o"&gt;)&lt;/span&gt;  20.707 ms  20.892 ms  20.702 ms
 6  213.59.212.235 &lt;span class="o"&gt;(&lt;/span&gt;213.59.212.235&lt;span class="o"&gt;)&lt;/span&gt;  20.632 ms  16.806 ms  17.437 ms
 7  rostelecom.demarc.cogentco.com &lt;span class="o"&gt;(&lt;/span&gt;149.11.20.138&lt;span class="o"&gt;)&lt;/span&gt;  63.077 ms  63.722 ms  64.571 ms
 8  hu0-1-0-4.rcr22.fra06.atlas.cogentco.com &lt;span class="o"&gt;(&lt;/span&gt;149.11.20.137&lt;span class="o"&gt;)&lt;/span&gt;  57.615 ms  58.457 ms  58.454 ms
 9  be2845.ccr41.fra03.atlas.cogentco.com &lt;span class="o"&gt;(&lt;/span&gt;154.54.56.189&lt;span class="o"&gt;)&lt;/span&gt;  58.463 ms be2846.ccr42.fra03.atlas.cogentco.com &lt;span class="o"&gt;(&lt;/span&gt;154.54.37.29&lt;span class="o"&gt;)&lt;/span&gt;  66.791 ms be2845.ccr41.fra03.atlas.cogentco.com &lt;span class="o"&gt;(&lt;/span&gt;154.54.56.189&lt;span class="o"&gt;)&lt;/span&gt;  59.662 ms
10  be3187.agr41.fra03.atlas.cogentco.com &lt;span class="o"&gt;(&lt;/span&gt;130.117.1.117&lt;span class="o"&gt;)&lt;/span&gt;  63.433 ms be3186.agr41.fra03.atlas.cogentco.com &lt;span class="o"&gt;(&lt;/span&gt;130.117.0.2&lt;span class="o"&gt;)&lt;/span&gt;  64.132 ms be3187.agr41.fra03.atlas.cogentco.com &lt;span class="o"&gt;(&lt;/span&gt;130.117.1.117&lt;span class="o"&gt;)&lt;/span&gt;  63.998 ms
11  telia.fra03.atlas.cogentco.com &lt;span class="o"&gt;(&lt;/span&gt;130.117.14.198&lt;span class="o"&gt;)&lt;/span&gt;  70.302 ms  70.477 ms  70.480 ms
12  ffm-bb3-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.133.34&lt;span class="o"&gt;)&lt;/span&gt;  168.162 ms ffm-bb4-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.125.218&lt;span class="o"&gt;)&lt;/span&gt;  140.360 ms ffm-bb3-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.120.3&lt;span class="o"&gt;)&lt;/span&gt;  165.617 ms
13  prs-bb3-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.123.13&lt;span class="o"&gt;)&lt;/span&gt;  171.186 ms  171.374 ms  169.994 ms
14  nyk-bb3-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;213.155.135.5&lt;span class="o"&gt;)&lt;/span&gt;  164.382 ms nyk-bb4-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;80.91.251.100&lt;span class="o"&gt;)&lt;/span&gt;  149.359 ms  150.275 ms
15  nyk-b3-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.140.223&lt;span class="o"&gt;)&lt;/span&gt;  163.973 ms hbg-bb1-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;80.91.249.11&lt;span class="o"&gt;)&lt;/span&gt;  177.416 ms  177.405 ms
16  digitalocean-ic-306498-nyk-b3.c.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.45.10&lt;span class="o"&gt;)&lt;/span&gt;  145.430 ms  145.572 ms  158.371 ms
17  &lt;span class="k"&gt;*&lt;/span&gt; &lt;span class="k"&gt;*&lt;/span&gt; &lt;span class="k"&gt;*&lt;/span&gt;
18  x.x.x.x &lt;span class="o"&gt;(&lt;/span&gt;x.x.x.x&lt;span class="o"&gt;)&lt;/span&gt;  154.054 ms  140.789 ms  141.688 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;While backwards from the droplet there&amp;rsquo;s only one of them:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;traceroute to y.y.y.y &lt;span class="o"&gt;(&lt;/span&gt;y.y.y.y&lt;span class="o"&gt;)&lt;/span&gt;, 30 hops max, 60 byte packets
 1  159.89.176.253 &lt;span class="o"&gt;(&lt;/span&gt;159.89.176.253&lt;span class="o"&gt;)&lt;/span&gt;  0.290 ms  0.263 ms  0.231 ms
 2  138.197.248.28 &lt;span class="o"&gt;(&lt;/span&gt;138.197.248.28&lt;span class="o"&gt;)&lt;/span&gt;  0.478 ms  0.469 ms  0.456 ms
 3  nyk-b3-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.45.9&lt;span class="o"&gt;)&lt;/span&gt;  1.021 ms  1.058 ms  1.043 ms
 4  nyk-bb3-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.140.222&lt;span class="o"&gt;)&lt;/span&gt;  1.153 ms nyk-bb4-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.139.150&lt;span class="o"&gt;)&lt;/span&gt;  1.523 ms nyk-bb3-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.140.222&lt;span class="o"&gt;)&lt;/span&gt;  1.111 ms
 5  prs-bb4-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;80.91.251.101&lt;span class="o"&gt;)&lt;/span&gt;  71.869 ms prs-bb3-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;213.155.135.4&lt;span class="o"&gt;)&lt;/span&gt;  106.781 ms  107.322 ms
 6  prs-bb3-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.134.92&lt;span class="o"&gt;)&lt;/span&gt;  88.216 ms  88.162 ms ffm-bb4-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.122.139&lt;span class="o"&gt;)&lt;/span&gt;  81.890 ms
 7  ffm-b1-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.141.237&lt;span class="o"&gt;)&lt;/span&gt;  93.304 ms ffm-bb3-link.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.123.12&lt;span class="o"&gt;)&lt;/span&gt;  101.734 ms  102.168 ms
 8  rostelecom-ic-319651-ffm-b1.c.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.151.97&lt;span class="o"&gt;)&lt;/span&gt;  156.199 ms  156.187 ms  156.198 ms
 9  213.59.212.103 &lt;span class="o"&gt;(&lt;/span&gt;213.59.212.103&lt;span class="o"&gt;)&lt;/span&gt;  138.304 ms  149.985 ms rostelecom-ic-319651-ffm-b1.c.telia.net &lt;span class="o"&gt;(&lt;/span&gt;62.115.151.97&lt;span class="o"&gt;)&lt;/span&gt;  158.270 ms
10  y.y.y.y &lt;span class="o"&gt;(&lt;/span&gt;y.y.y.y&lt;span class="o"&gt;)&lt;/span&gt;  139.571 ms  139.690 ms  139.701 ms
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The difference can be explained by dynamic routing. Since routes are described
by &lt;a href="https://en.wikipedia.org/wiki/Border_Gateway_Protocol"&gt;BGP&lt;/a&gt; even a few
sequential traceroutes can show different routes. In BGP realm the trust is
above everything. This site &lt;a href="https://bgpstream.com/"&gt;bgpstream.com&lt;/a&gt; can be very
interesting if you are into it. Though the route from DO is twice as shorter
then from Rostelekom. Let&amp;rsquo;s monitor outgoing and incoming traffic for this IP on
one window open curl and tcpdump on another:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;curl http://example.com
curl: &lt;span class="o"&gt;(&lt;/span&gt;7&lt;span class="o"&gt;)&lt;/span&gt; Failed to connect to example.com port 80: Connection timed out
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;tcpdump &lt;span class="nt"&gt;-nn&lt;/span&gt; &lt;span class="nt"&gt;-vvv&lt;/span&gt; &lt;span class="nt"&gt;-i&lt;/span&gt; enp4s0 dst x.x.x.x or src x.x.x.x
tcpdump: listening on enp4s0, link-type EN10MB &lt;span class="o"&gt;(&lt;/span&gt;Ethernet&lt;span class="o"&gt;)&lt;/span&gt;, capture size 262144 bytes
23:38:18.908971 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x0, ttl 64, &lt;span class="nb"&gt;id &lt;/span&gt;59563, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 60&lt;span class="o"&gt;)&lt;/span&gt;
    192.168.0.13.41722 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; x.x.x.x.80: Flags &lt;span class="o"&gt;[&lt;/span&gt;S], &lt;span class="nb"&gt;cksum &lt;/span&gt;0xd52f &lt;span class="o"&gt;(&lt;/span&gt;correct&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;1092877667, win 29200, options &lt;span class="o"&gt;[&lt;/span&gt;mss 1460,sackOK,TS val 3908771289 ecr 0,nop,wscale 7], length 0
23:38:18.925014 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x0, ttl 58, &lt;span class="nb"&gt;id &lt;/span&gt;1, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;none], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 40&lt;span class="o"&gt;)&lt;/span&gt;
    x.x.x.x.80 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; 192.168.0.13.41722: Flags &lt;span class="o"&gt;[&lt;/span&gt;R], &lt;span class="nb"&gt;cksum &lt;/span&gt;0x43e5 &lt;span class="o"&gt;(&lt;/span&gt;correct&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;0, win 29200, length 0
23:38:19.932815 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x0, ttl 64, &lt;span class="nb"&gt;id &lt;/span&gt;59564, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 60&lt;span class="o"&gt;)&lt;/span&gt;
    192.168.0.13.41722 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; x.x.x.x.80: Flags &lt;span class="o"&gt;[&lt;/span&gt;S], &lt;span class="nb"&gt;cksum &lt;/span&gt;0xd12f &lt;span class="o"&gt;(&lt;/span&gt;correct&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;1092877667, win 29200, options &lt;span class="o"&gt;[&lt;/span&gt;mss 1460,sackOK,TS val 3908772313 ecr 0,nop,wscale 7], length 0
23:38:19.948956 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x0, ttl 58, &lt;span class="nb"&gt;id &lt;/span&gt;1, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;none], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 40&lt;span class="o"&gt;)&lt;/span&gt;
    x.x.x.x.80 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; 192.168.0.13.41722: Flags &lt;span class="o"&gt;[&lt;/span&gt;R], &lt;span class="nb"&gt;cksum &lt;/span&gt;0x43e5 &lt;span class="o"&gt;(&lt;/span&gt;correct&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;0, win 29200, length 0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;3-Way TCP Handshake should be (SYN, SYN-ACK, ACK). Instead we see RST packet
right after SYN. You can see them as [S] and [R] flags. In other words all
outgoing http traffic dropped in the middle and instead we are sent RST packet.
Let&amp;rsquo;s send an outgoing packet from the droplet with source port 80 to home
router on port 80:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;yes&lt;/span&gt; | nc &lt;span class="nt"&gt;-p&lt;/span&gt; 80 &lt;span class="nt"&gt;-t&lt;/span&gt; y.y.y.y 80

&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;tcpdump &lt;span class="nt"&gt;-nn&lt;/span&gt; &lt;span class="nt"&gt;-vvv&lt;/span&gt; &lt;span class="nt"&gt;-i&lt;/span&gt; eth0 dst y.y.y.y and dst port 80 or src y.y.y.y and dst port 80
tcpdump: listening on eth0, link-type EN10MB &lt;span class="o"&gt;(&lt;/span&gt;Ethernet&lt;span class="o"&gt;)&lt;/span&gt;, capture size 262144 bytes
05:39:49.968049 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x0, ttl 64, &lt;span class="nb"&gt;id &lt;/span&gt;18207, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 60&lt;span class="o"&gt;)&lt;/span&gt;
    x.x.x.x.80 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; y.y.y.y.80: Flags &lt;span class="o"&gt;[&lt;/span&gt;S], &lt;span class="nb"&gt;cksum &lt;/span&gt;0x6e4e &lt;span class="o"&gt;(&lt;/span&gt;incorrect -&amp;gt; 0x16e9&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;3260122744, win 29200, options &lt;span class="o"&gt;[&lt;/span&gt;mss 1460,sackOK,TS val 1175830887 ecr 0,nop,wscale 7], length 0
05:39:50.109076 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x28, ttl 49, &lt;span class="nb"&gt;id &lt;/span&gt;0, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 60&lt;span class="o"&gt;)&lt;/span&gt;
    y.y.y.y.80 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; x.x.x.x.80: Flags &lt;span class="o"&gt;[&lt;/span&gt;S.], &lt;span class="nb"&gt;cksum &lt;/span&gt;0x83e9 &lt;span class="o"&gt;(&lt;/span&gt;correct&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;3723973951, ack 3260122745, win 28960, options &lt;span class="o"&gt;[&lt;/span&gt;mss 1440,sackOK,TS val 3637479403 ecr 1175830887,nop,wscale 7], length 0
05:39:50.109117 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x0, ttl 64, &lt;span class="nb"&gt;id &lt;/span&gt;18208, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 52&lt;span class="o"&gt;)&lt;/span&gt;
    x.x.x.x.80 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; y.y.y.y.80: Flags &lt;span class="o"&gt;[&lt;/span&gt;.], &lt;span class="nb"&gt;cksum &lt;/span&gt;0x6e46 &lt;span class="o"&gt;(&lt;/span&gt;incorrect -&amp;gt; 0x22b9&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;1, ack 1, win 229, options &lt;span class="o"&gt;[&lt;/span&gt;nop,nop,TS val 1175830923 ecr 3637479403], length 0
05:39:50.109230 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x0, ttl 64, &lt;span class="nb"&gt;id &lt;/span&gt;18209, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 2100&lt;span class="o"&gt;)&lt;/span&gt;
    x.x.x.x.80 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; y.y.y.y.80: Flags &lt;span class="o"&gt;[&lt;/span&gt;P.], &lt;span class="nb"&gt;cksum &lt;/span&gt;0x7646 &lt;span class="o"&gt;(&lt;/span&gt;incorrect -&amp;gt; 0xf0cc&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;1:2049, ack 1, win 229, options &lt;span class="o"&gt;[&lt;/span&gt;nop,nop,TS val 1175830923 ecr 3637479403], length 2048: HTTP
05:39:50.109280 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x0, ttl 64, &lt;span class="nb"&gt;id &lt;/span&gt;18211, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 1480&lt;span class="o"&gt;)&lt;/span&gt;
    x.x.x.x.80 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; y.y.y.y.80: Flags &lt;span class="o"&gt;[&lt;/span&gt;.], &lt;span class="nb"&gt;cksum &lt;/span&gt;0x73da &lt;span class="o"&gt;(&lt;/span&gt;incorrect -&amp;gt; 0x7def&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;2049:3477, ack 1, win 229, options &lt;span class="o"&gt;[&lt;/span&gt;nop,nop,TS val 1175830923 ecr 3637479403], length 1428: HTTP
05:39:50.109299 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x0, ttl 64, &lt;span class="nb"&gt;id &lt;/span&gt;18212, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 1480&lt;span class="o"&gt;)&lt;/span&gt;
    x.x.x.x.80 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; y.y.y.y.80: Flags &lt;span class="o"&gt;[&lt;/span&gt;.], &lt;span class="nb"&gt;cksum &lt;/span&gt;0x73da &lt;span class="o"&gt;(&lt;/span&gt;incorrect -&amp;gt; 0x785b&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;3477:4905, ack 1, win 229, options &lt;span class="o"&gt;[&lt;/span&gt;nop,nop,TS val 1175830923 ecr 3637479403], length 1428: HTTP
05:39:50.109331 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x0, ttl 64, &lt;span class="nb"&gt;id &lt;/span&gt;18213, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 2908&lt;span class="o"&gt;)&lt;/span&gt;
    x.x.x.x.80 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; y.y.y.y.80: Flags &lt;span class="o"&gt;[&lt;/span&gt;.], &lt;span class="nb"&gt;cksum &lt;/span&gt;0x796e &lt;span class="o"&gt;(&lt;/span&gt;incorrect -&amp;gt; 0xd5fd&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;4905:7761, ack 1, win 229, options &lt;span class="o"&gt;[&lt;/span&gt;nop,nop,TS val 1175830923 ecr 3637479403], length 2856: HTTP
05:39:50.109349 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x0, ttl 64, &lt;span class="nb"&gt;id &lt;/span&gt;18215, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 1480&lt;span class="o"&gt;)&lt;/span&gt;
    x.x.x.x.80 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; y.y.y.y.80: Flags &lt;span class="o"&gt;[&lt;/span&gt;.], &lt;span class="nb"&gt;cksum &lt;/span&gt;0x73da &lt;span class="o"&gt;(&lt;/span&gt;incorrect -&amp;gt; 0x679f&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;7761:9189, ack 1, win 229, options &lt;span class="o"&gt;[&lt;/span&gt;nop,nop,TS val 1175830923 ecr 3637479403], length 1428: HTTP
05:39:50.109371 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x0, ttl 64, &lt;span class="nb"&gt;id &lt;/span&gt;18216, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 2908&lt;span class="o"&gt;)&lt;/span&gt;
    x.x.x.x.80 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; y.y.y.y.80: Flags &lt;span class="o"&gt;[&lt;/span&gt;.], &lt;span class="nb"&gt;cksum &lt;/span&gt;0x796e &lt;span class="o"&gt;(&lt;/span&gt;incorrect -&amp;gt; 0xc541&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;9189:12045, ack 1, win 229, options &lt;span class="o"&gt;[&lt;/span&gt;nop,nop,TS val 1175830923 ecr 3637479403], length 2856: HTTP
05:39:50.109390 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x0, ttl 64, &lt;span class="nb"&gt;id &lt;/span&gt;18218, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 1480&lt;span class="o"&gt;)&lt;/span&gt;
    x.x.x.x.80 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; y.y.y.y.80: Flags &lt;span class="o"&gt;[&lt;/span&gt;.], &lt;span class="nb"&gt;cksum &lt;/span&gt;0x73da &lt;span class="o"&gt;(&lt;/span&gt;incorrect -&amp;gt; 0x56e3&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;12045:13473, ack 1, win 229, options &lt;span class="o"&gt;[&lt;/span&gt;nop,nop,TS val 1175830923 ecr 3637479403], length 1428: HTTP
05:39:50.251998 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x28, ttl 49, &lt;span class="nb"&gt;id &lt;/span&gt;34134, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 40&lt;span class="o"&gt;)&lt;/span&gt;
    y.y.y.y.80 &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; x.x.x.x.80: Flags &lt;span class="o"&gt;[&lt;/span&gt;R], &lt;span class="nb"&gt;cksum &lt;/span&gt;0x0de9 &lt;span class="o"&gt;(&lt;/span&gt;correct&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="nb"&gt;seq &lt;/span&gt;3723973952, win 0, length 0
05:39:50.252020 IP &lt;span class="o"&gt;(&lt;/span&gt;tos 0x28, ttl 49, &lt;span class="nb"&gt;id &lt;/span&gt;34135, offset 0, flags &lt;span class="o"&gt;[&lt;/span&gt;DF], proto TCP &lt;span class="o"&gt;(&lt;/span&gt;6&lt;span class="o"&gt;)&lt;/span&gt;, length 40&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;TCP handshake and reset after all but they at least exchanged a few packets.
I wonder if we can catch where exactly http traffic drops. With traceroute we can
see where ICMP packets go but does that mean HTTP goes the same direction?
traceroute supports other options for example you can trace tcp SYN packets:
&lt;code&gt;traceroute -T -O syn â€”port=80 -n -N 1 -q 1 x.x.x.x&lt;/code&gt;. The tool creates packets
manually so that they are only 44 bytes long and they pass DPI see SYN-ACK:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight plaintext"&gt;&lt;code&gt;10:34:34.815998 IP (tos 0x0, ttl 19, id 61933, offset 0, flags [none], proto TCP (6), length 44)
    y.y.y.y.58057 &amp;gt; x.x.x.x.80: Flags [S], cksum 0x61ef (correct), seq 3848879829, win 5840, options [mss 1460], length 0
  0x0000:  4500 002c f1ed 0000 1306 9dd0 c0a8 0002  E..,............
  0x0010:  9f59 b80a e2c9 0050 e569 3ed5 0000 0000  .Y.....P.i&amp;gt;.....
  0x0020:  6002 16d0 61ef 0000 0204 05b4            `...a.......
10:34:34.974844 IP (tos 0x0, ttl 51, id 0, offset 0, flags [DF], proto TCP (6), length 44)
    x.x.x.x.80 &amp;gt; y.y.y.y.58057: Flags [S.], cksum 0x0feb (correct), seq 2544066339, ack 3848879830, win 29200, options [mss 1440], length 0
  0x0000:  4500 002c 0000 4000 3306 2fbe 9f59 b80a  E..,..@.3./..Y..
  0x0010:  c0a8 0002 0050 e2c9 97a3 5f23 e569 3ed6  .....P...._#.i&amp;gt;.
  0x0020:  6012 7210 0feb 0000 0204 05a0 0000       `.r...........
10:34:34.974909 IP (tos 0x0, ttl 64, id 61944, offset 0, flags [DF], proto TCP (6), length 40)
    y.y.y.y.58057 &amp;gt; x.x.x.x.80: Flags [R], cksum 0x9078 (correct), seq 3848879830, win 0, length 0
  0x0000:  4500 0028 f1f8 4000 4006 30c9 c0a8 0002  E..(..@.@.0.....
  0x0010:  9f59 b80a e2c9 0050 e569 3ed6 0000 0000  .Y.....P.i&amp;gt;.....
  0x0020:  5004 0000 9078 0000                      P....x..
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The real SYN packet from browser is 60 bytes and DPI drops it:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight plaintext"&gt;&lt;code&gt;10:33:48.537807 IP (tos 0x0, ttl 19, id 54902, offset 0, flags [none], proto TCP (6), length 60)
    y.y.y.y.42193 &amp;gt; x.x.x.x.80: Flags [S], cksum 0xe900 (correct), seq 2785663221, win 5840, options [mss 1460,sackOK,TS val 1652926847 ecr 0,nop,wscale 2], length 0
  0x0000:  4500 003c d676 0000 1306 b937 c0a8 0002  E..&amp;lt;.v.....7....
  0x0010:  9f59 b80a a4d1 0050 a609 d8f5 0000 0000  .Y.....P........
  0x0020:  a002 16d0 e900 0000 0204 05b4 0402 080a  ................
  0x0030:  6285 a97f 0000 0000 0103 0302            b...........
10:33:48.563619 IP (tos 0x0, ttl 8, id 1, offset 0, flags [none], proto TCP (6), length 40)
    x.x.x.x.80 &amp;gt; y.y.y.y.42193: Flags [R], cksum 0x5ce1 (correct), seq 0, win 5840, length 0
  0x0000:  4500 0028 0001 0000 0806 9ac1 9f59 b80a  E..(.........Y..
  0x0010:  c0a8 0002 0050 a4d1 0000 0000 a609 d8f5  .....P..........
  0x0020:  5004 16d0 5ce1 0000 0000 0000 0000       P...\.........
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This all suggests that provider definitely dropped packets while they said they
didn&amp;rsquo;t to me.&lt;/p&gt;

&lt;p&gt;Overall I feel disappointed about the road internet march nowadays. It started
like a small network with purpose of exchanging data for research, helping
humankind to solve issues or at least doing something meaningful.
Instead I feel more like a resource that big company can sell and goverment can
control limiting my view. They all either earn money or get benefit trading you
but the thing is you don&amp;rsquo;t get anything out of it.&lt;/p&gt;

&lt;h3&gt;A few words about GPON&lt;/h3&gt;

&lt;p&gt;The text below is true for many ISPs. There are many downsides of GPON you can
read articles about it in the footer but for me it&amp;rsquo;s inability to set up my own
or at least high quality router instead of the one given by provider. You as a
customer will rent a router from them. The router usually goes with buggy
firmware, remote access for provider and inability to set it to the bridge mode.
In other words it is a useless piece of trash which you will own as you redeem
it during 2 years and you cannot buy another one and replace this shit because
it simply won&amp;rsquo;t work with GPON. Also &lt;a href="https://habr.com/post/113086/"&gt;Rostelekom is the biggest player&lt;/a&gt;
in Russia and has tight realtionship with goverment so I prefer stayng as far
away as possible from them and pay to a smaller provider to keep it on the air.&lt;/p&gt;

&lt;h3&gt;A way to bypass restrictions&lt;/h3&gt;

&lt;p&gt;I want my internet to work w/o restrictions and I don&amp;rsquo;t want to set up tunnels
on every signle device. In other words router should set up the tunnel and route
traffic accordingly. My new toy is &lt;a href="https://mikrotik.com/product/hap_ac2"&gt;Mikrotik hap ac2&lt;/a&gt;
and I&amp;rsquo;m very happy with it. It supports many cool features, the speed is great
and hardware accelearation for IPsec should speed it up even more.&lt;/p&gt;

&lt;p&gt;I have bought a server overseas, let&amp;rsquo;s setup GRE tunnel between router and a
server(&lt;code&gt;x.x.x.x&lt;/code&gt; - server&amp;rsquo;s white IP, &lt;code&gt;y.y.y.y&lt;/code&gt; - router&amp;rsquo;s white IP), the
network IP address inside the tunnel will be &lt;code&gt;192.168.0.1&lt;/code&gt; for server and
&lt;code&gt;192.168.0.2&lt;/code&gt; for router, my home network behind router is &lt;code&gt;192.168.88.0/24&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;sudo cat&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class="no"&gt;EOF&lt;/span&gt;&lt;span class="sh"&gt; &amp;gt;&amp;gt; /etc/network/interfaces
 iface tun1 inet static
    address 192.168.0.1
    netmask 255.255.255.0
    mtu 1456
    pre-up iptunnel add tun1 mode gre local x.x.x.x remote y.y.y.y ttl 255
    up ifconfig tun1 multicast
    pointopoint 192.168.0.2
    post-down iptunnel del tun1
 up ip ro add 192.168.88.0/24 via 192.168.0.2
&lt;/span&gt;&lt;span class="no"&gt;EOF

&lt;/span&gt;&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;sudo echo&lt;/span&gt; &lt;span class="s2"&gt;"net.ipv4.ip_forward = 1"&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&amp;gt;&lt;/span&gt; /etc/sysctl.conf
&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;sysctl &lt;span class="nt"&gt;-p&lt;/span&gt; &lt;span class="c"&gt;# check if it's set properly&lt;/span&gt;
&lt;span class="nv"&gt;$ &lt;/span&gt;&lt;span class="nb"&gt;sudo &lt;/span&gt;iptables &lt;span class="nt"&gt;-t&lt;/span&gt; nat &lt;span class="nt"&gt;-A&lt;/span&gt; POSTROUTING &lt;span class="nt"&gt;-o&lt;/span&gt; ens3 &lt;span class="nt"&gt;-j&lt;/span&gt; MASQUERADE
&lt;span class="nv"&gt;$ &lt;/span&gt;ifdown tun1 &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; ifup tun1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;On the router:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight shell"&gt;&lt;code&gt;/interface gre add &lt;span class="nv"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"gre-tunnel1"&lt;/span&gt; &lt;span class="nv"&gt;mtu&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;auto local-address&lt;span class="o"&gt;=&lt;/span&gt;y.y.y.y remote-address&lt;span class="o"&gt;=&lt;/span&gt;x.x.x.x clamp-tcp-mss&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;yes &lt;/span&gt;dont-fragment&lt;span class="o"&gt;=&lt;/span&gt;no allow-fast-path&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;yes&lt;/span&gt;
/ip address add &lt;span class="nv"&gt;address&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;192.168.0.2/24 &lt;span class="nv"&gt;network&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;192.168.0.0 &lt;span class="nv"&gt;interface&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;gre-tunnel1

/ip firewall mangle
add &lt;span class="nv"&gt;chain&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;forward &lt;span class="nv"&gt;action&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;change-mss new-mss&lt;span class="o"&gt;=&lt;/span&gt;clamp-to-pmtu &lt;span class="nv"&gt;passthrough&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;no tcp-flags&lt;span class="o"&gt;=&lt;/span&gt;syn &lt;span class="nv"&gt;protocol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;tcp &lt;span class="k"&gt;in&lt;/span&gt;&lt;span class="nt"&gt;-interface&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;gre-tunnel1 tcp-mss&lt;span class="o"&gt;=&lt;/span&gt;1300-65535 &lt;span class="nv"&gt;log&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;no log-prefix&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;""&lt;/span&gt;
add &lt;span class="nv"&gt;chain&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;forward &lt;span class="nv"&gt;action&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;change-mss new-mss&lt;span class="o"&gt;=&lt;/span&gt;clamp-to-pmtu &lt;span class="nv"&gt;passthrough&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;no tcp-flags&lt;span class="o"&gt;=&lt;/span&gt;syn &lt;span class="nv"&gt;protocol&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;tcp out-interface&lt;span class="o"&gt;=&lt;/span&gt;gre-tunnel1 tcp-mss&lt;span class="o"&gt;=&lt;/span&gt;1300-65535 &lt;span class="nv"&gt;log&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;no log-prefix&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;""&lt;/span&gt;

/ip route
add &lt;span class="nv"&gt;comment&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;linkedin &lt;span class="nv"&gt;distance&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;1 dst-address&lt;span class="o"&gt;=&lt;/span&gt;91.225.248.0/22 &lt;span class="nv"&gt;gateway&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;gre-tunnel1
add &lt;span class="nv"&gt;comment&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;linkedin &lt;span class="nv"&gt;distance&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;1 dst-address&lt;span class="o"&gt;=&lt;/span&gt;108.174.0.0/20 &lt;span class="nv"&gt;gateway&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;gre-tunnel1
add &lt;span class="nv"&gt;comment&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;linkedin &lt;span class="nv"&gt;distance&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;1 dst-address&lt;span class="o"&gt;=&lt;/span&gt;185.63.144.0/22 &lt;span class="nv"&gt;gateway&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;gre-tunnel1
add &lt;span class="nv"&gt;comment&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;rutracker &lt;span class="nv"&gt;distance&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;1 dst-address&lt;span class="o"&gt;=&lt;/span&gt;195.82.146.0/24 &lt;span class="nv"&gt;gateway&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;gre-tunnel1
add &lt;span class="nv"&gt;comment&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;telegram &lt;span class="nv"&gt;distance&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;1 dst-address&lt;span class="o"&gt;=&lt;/span&gt;149.154.164.0/22 &lt;span class="nv"&gt;gateway&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;gre-tunnel1
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can now open all sites you added routes to; the packets for them now flow
thru the tunnel. That&amp;rsquo;s it.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href="https://www.eff.org/cyberspace-independence"&gt;Cyberspace independence&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.lookatme.ru/mag/magazine/russian-internet/207489-decentralization"&gt;Decentralization&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.newyorker.com/tech/elements/the-mission-to-decentralize-the-internet"&gt;The mission to decentralize the internet&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://dyn.com/blog/could-it-happen-in-your-countr/"&gt;Could it happen in your country&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://dyn.com/blog/vast-world-of-fraudulent-routing/"&gt;Vast world of fraudulent routing&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://dyn.com/blog/latest-isps-to-hijack/"&gt;Latest ISPs to hijack&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://pierrekim.github.io/blog/2016-11-01-gpon-ftth-networks-insecurity.html"&gt;GPON FTTH networks (in)security&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://lurkmore.to/GPON"&gt;Lurkmore GPON&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
  </entry>
  <entry>
    <title>Slow query with ActiveRecord's method first</title>
    <link rel="alternate" href="/2018/04/12/stop-using-active-record-first.html"/>
    <id>/2018/04/12/stop-using-active-record-first.html</id>
    <published>2018-04-12T00:00:00+03:00</published>
    <updated>2018-04-12T00:00:00+03:00</updated>
    <author>
      <name>Dmitry Vorotilin</name>
    </author>
    <summary type="html">&lt;p&gt;If youâ€™ve grown with Rails like me you know that everyone used and perhaps still
uses everywhere &lt;code&gt;first&lt;/code&gt; method. You just type it automatically. I know that itâ€™s
so simple that it doesnâ€™t even deserve a post but you have to stop doing that.&lt;/p&gt;

&lt;p&gt;&lt;img src="/images/irb.png" class="img-fluid" alt="irb"&gt;&lt;/p&gt;

&lt;p&gt;Things...&lt;/p&gt;</summary>
    <content type="html">&lt;p&gt;If you&amp;rsquo;ve grown with Rails like me you know that everyone used and perhaps still
uses everywhere &lt;code&gt;first&lt;/code&gt; method. You just type it automatically. I know that it&amp;rsquo;s
so simple that it doesn&amp;rsquo;t even deserve a post but you have to stop doing that.&lt;/p&gt;

&lt;p&gt;&lt;img src="/images/irb.png" class="img-fluid" alt="irb"&gt;&lt;/p&gt;

&lt;p&gt;Things are getting more intersting with PostgreSQL v10:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight sql"&gt;&lt;code&gt;&lt;span class="k"&gt;EXPLAIN&lt;/span&gt; &lt;span class="k"&gt;ANALYZE&lt;/span&gt; &lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="k"&gt;FROM&lt;/span&gt; &lt;span class="nv"&gt;"posts"&lt;/span&gt; &lt;span class="k"&gt;WHERE&lt;/span&gt; &lt;span class="nv"&gt;"posts"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nv"&gt;"deleted_at"&lt;/span&gt; &lt;span class="k"&gt;IS&lt;/span&gt; &lt;span class="k"&gt;NULL&lt;/span&gt; &lt;span class="k"&gt;AND&lt;/span&gt; &lt;span class="nv"&gt;"posts"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nv"&gt;"user_id"&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="k"&gt;order&lt;/span&gt; &lt;span class="k"&gt;by&lt;/span&gt; &lt;span class="n"&gt;id&lt;/span&gt; &lt;span class="k"&gt;ASC&lt;/span&gt; &lt;span class="k"&gt;limit&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
                                                                    &lt;span class="n"&gt;QUERY&lt;/span&gt; &lt;span class="n"&gt;PLAN&lt;/span&gt;                                                                    
&lt;span class="c1"&gt;--------------------------------------------------------------------------------------------------------------------------------------------------&lt;/span&gt;
 &lt;span class="k"&gt;Limit&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cost&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;11&lt;/span&gt;&lt;span class="p"&gt;..&lt;/span&gt;&lt;span class="mi"&gt;26&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;91&lt;/span&gt; &lt;span class="k"&gt;rows&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;327&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;actual&lt;/span&gt; &lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;37557&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;875&lt;/span&gt;&lt;span class="p"&gt;..&lt;/span&gt;&lt;span class="mi"&gt;37557&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;875&lt;/span&gt; &lt;span class="k"&gt;rows&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="n"&gt;loops&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
   &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;  &lt;span class="k"&gt;Index&lt;/span&gt; &lt;span class="n"&gt;Scan&lt;/span&gt; &lt;span class="k"&gt;using&lt;/span&gt; &lt;span class="n"&gt;posts_pkey&lt;/span&gt; &lt;span class="k"&gt;on&lt;/span&gt; &lt;span class="n"&gt;posts&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cost&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;11&lt;/span&gt;&lt;span class="p"&gt;..&lt;/span&gt;&lt;span class="mi"&gt;2057670&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;78&lt;/span&gt; &lt;span class="k"&gt;rows&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;76800&lt;/span&gt; &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;327&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;actual&lt;/span&gt; &lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;37557&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;874&lt;/span&gt;&lt;span class="p"&gt;..&lt;/span&gt;&lt;span class="mi"&gt;37557&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;874&lt;/span&gt; &lt;span class="k"&gt;rows&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="n"&gt;loops&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
         &lt;span class="n"&gt;Filter&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;deleted_at&lt;/span&gt; &lt;span class="k"&gt;IS&lt;/span&gt; &lt;span class="k"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;AND&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;user_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
         &lt;span class="k"&gt;Rows&lt;/span&gt; &lt;span class="n"&gt;Removed&lt;/span&gt; &lt;span class="k"&gt;by&lt;/span&gt; &lt;span class="n"&gt;Filter&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;26826499&lt;/span&gt;
 &lt;span class="n"&gt;Planning&lt;/span&gt; &lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;202&lt;/span&gt; &lt;span class="n"&gt;ms&lt;/span&gt;
 &lt;span class="n"&gt;Execution&lt;/span&gt; &lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;37557&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;905&lt;/span&gt; &lt;span class="n"&gt;ms&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;6&lt;/span&gt; &lt;span class="k"&gt;rows&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Doesn&amp;rsquo;t it look creepy? According to &lt;a href="https://stackoverflow.com/questions/21385555/postgresql-query-very-slow-with-limit-1"&gt;stackoverflow&lt;/a&gt;
it can be an issue in the planner and given that you have pretty large table
this query becomes drastically slower than planned. So a combination of two
issues results in a waste of time for investigation. First of all it shouldn&amp;rsquo;t
have happened if we used &lt;code&gt;take&lt;/code&gt; method added &lt;a href="https://github.com/rails/rails/commit/1379375f93c53d4c49fa8592b6117c3ade263f2e"&gt;long ago&lt;/a&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight sql"&gt;&lt;code&gt;&lt;span class="k"&gt;EXPLAIN&lt;/span&gt; &lt;span class="k"&gt;ANALYZE&lt;/span&gt; &lt;span class="k"&gt;SELECT&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="k"&gt;FROM&lt;/span&gt; &lt;span class="nv"&gt;"posts"&lt;/span&gt; &lt;span class="k"&gt;WHERE&lt;/span&gt; &lt;span class="nv"&gt;"posts"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nv"&gt;"deleted_at"&lt;/span&gt; &lt;span class="k"&gt;IS&lt;/span&gt; &lt;span class="k"&gt;NULL&lt;/span&gt; &lt;span class="k"&gt;AND&lt;/span&gt; &lt;span class="nv"&gt;"posts"&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nv"&gt;"user_id"&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="k"&gt;limit&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
                                                     &lt;span class="n"&gt;QUERY&lt;/span&gt; &lt;span class="n"&gt;PLAN&lt;/span&gt;                                                     
&lt;span class="c1"&gt;--------------------------------------------------------------------------------------------------------------------&lt;/span&gt;
 &lt;span class="k"&gt;Limit&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cost&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;00&lt;/span&gt;&lt;span class="p"&gt;..&lt;/span&gt;&lt;span class="mi"&gt;13&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;40&lt;/span&gt; &lt;span class="k"&gt;rows&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;327&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;actual&lt;/span&gt; &lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;979&lt;/span&gt;&lt;span class="p"&gt;..&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;979&lt;/span&gt; &lt;span class="k"&gt;rows&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="n"&gt;loops&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
   &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;  &lt;span class="n"&gt;Seq&lt;/span&gt; &lt;span class="n"&gt;Scan&lt;/span&gt; &lt;span class="k"&gt;on&lt;/span&gt; &lt;span class="n"&gt;posts&lt;/span&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cost&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;00&lt;/span&gt;&lt;span class="p"&gt;..&lt;/span&gt;&lt;span class="mi"&gt;1029108&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;93&lt;/span&gt; &lt;span class="k"&gt;rows&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;76800&lt;/span&gt; &lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;327&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;actual&lt;/span&gt; &lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;978&lt;/span&gt;&lt;span class="p"&gt;..&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;978&lt;/span&gt; &lt;span class="k"&gt;rows&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="n"&gt;loops&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
         &lt;span class="n"&gt;Filter&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;deleted_at&lt;/span&gt; &lt;span class="k"&gt;IS&lt;/span&gt; &lt;span class="k"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;AND&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;user_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
         &lt;span class="k"&gt;Rows&lt;/span&gt; &lt;span class="n"&gt;Removed&lt;/span&gt; &lt;span class="k"&gt;by&lt;/span&gt; &lt;span class="n"&gt;Filter&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;3463&lt;/span&gt;
 &lt;span class="n"&gt;Planning&lt;/span&gt; &lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;606&lt;/span&gt; &lt;span class="n"&gt;ms&lt;/span&gt;
 &lt;span class="n"&gt;Execution&lt;/span&gt; &lt;span class="nb"&gt;time&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="mi"&gt;047&lt;/span&gt; &lt;span class="n"&gt;ms&lt;/span&gt;
&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;6&lt;/span&gt; &lt;span class="k"&gt;rows&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Force yourself typing &lt;code&gt;take&lt;/code&gt; instead of &lt;code&gt;first&lt;/code&gt; if you don&amp;rsquo;t care about the
order which in most cases is true.&lt;/p&gt;
</content>
  </entry>
  <entry>
    <title>Query Trail</title>
    <link rel="alternate" href="/2014/08/10/query-trail.html"/>
    <id>/2014/08/10/query-trail.html</id>
    <published>2014-08-10T00:00:00+04:00</published>
    <updated>2014-08-10T00:00:00+04:00</updated>
    <author>
      <name>Dmitry Vorotilin</name>
    </author>
    <summary type="html">&lt;p&gt;Recently I switched on a project with lots of legacy code. It was on Rails 2,
Rails 3 and now Iâ€™ve updated it to Rails 4.1. You canâ€™t even imagine how much
rubbish I got rid of. But the thing Iâ€™d like to share with you today is
&lt;a href="https://github.com/route/query_trail"&gt;QueryTrail&lt;/a&gt;. This simple...&lt;/p&gt;</summary>
    <content type="html">&lt;p&gt;Recently I switched on a project with lots of legacy code. It was on Rails 2,
Rails 3 and now I&amp;rsquo;ve updated it to Rails 4.1. You can&amp;rsquo;t even imagine how much
rubbish I got rid of. But the thing I&amp;rsquo;d like to share with you today is
&lt;a href="https://github.com/route/query_trail"&gt;QueryTrail&lt;/a&gt;. This simple but useful gem
shows you the backtrace of fired queries. You have to agree that when just one
action of your controller sends hundreds sql requests from helpers, templates
and so forth, it&amp;rsquo;s definitely hard to locate the place for specific query. But
not for now:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre class="highlight plaintext"&gt;&lt;code&gt;User Load (0.4ms)  SELECT  `users`.* FROM `users`  WHERE `users`.`id` = 1 LIMIT 1
Query Trail: config/initializers/warden.rb:11:in `block in &amp;lt;top (required)&amp;gt;'
             config/initializers/warden.rb:15:in `block in &amp;lt;top (required)&amp;gt;'
Doc Load (18.2ms)  SELECT `docs`.* FROM `docs`  WHERE `docs`.`approved` = 1
Query Trail: app/views/main/_docs.html.erb:2
             app/helpers/docs_helper.rb:3:in `render_main_block'
             app/views/main/index.html.erb:13
             app/views/main/index.html.erb:9
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content>
  </entry>
</feed>
